// --- Utility Functions ---
// ... (keep existing functions) ...

// --- Initialization ---
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded. Initializing...");
    // ... (cache DOM elements as before) ...

    // Show loading spinner and hide other content
    loadingSpinner?.classList.remove('hidden');
    loadingSpinner?.style.display = 'flex'; // Ensure it's visible
    errorMessageElement?.classList.add('hidden');
    mainContentElement?.classList.add('hidden');
    initialMessageElement.style.display = 'none';
    console.log("Initial UI state set (spinner visible).");

    try {
 // CORRECTED CHECKS:
// Check if the URL is missing or still set to a placeholder value
if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_URL.length < 10) { // Added length check just in case
    throw new Error("Supabase URL is not configured or is invalid.");
}
// Check if the Key is missing or still set to a placeholder value
if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY' || SUPABASE_ANON_KEY.length < 50) { // Added length check
    throw new Error("Supabase Anon Key is not configured or is invalid.");
}
        const { createClient } = window.supabase;
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client initialized.");

        // Quick test to ensure client is somewhat functional (optional, but helpful)
        if (typeof supabase.from !== 'function') {
             throw new Error("Supabase client object seems invalid (missing 'from' method).");
        }
        console.log("Supabase client seems functional.");


        // Setup Buttons
        document.getElementById('retryButton')?.addEventListener('click', () => location.reload());
        document.getElementById('manualEntryButton')?.addEventListener('click', useDemoData);
        initSaveButton();
        initUploadButton();
        initModals();
        console.log("Buttons and modals initialized.");

        // Load Dashboard Data
        console.log("Calling initializeDashboard...");
        initializeDashboard();
        console.log("Returned from initializeDashboard call.");


    } catch (error) {
        console.error("CRITICAL Error during initial setup:", error);
        // Ensure handleError is called even for setup errors
        handleError("Failed during initial page setup", error);
    }
});

// --- Debugging & Error Handling ---
function debugURLParameters() {
    // ... (keep existing function, ensure debugInfoElement is valid before using) ...
    if (!debugInfoElement) {
        console.warn("Debug info element not found for URL params.");
        return;
    }
    // ... rest of the function
}
function handleError(message, error) {
    console.error("HANDLE ERROR TRIGGERED:", message, error);
    // Ensure elements exist before manipulating
    errorTextElement = errorTextElement || document.getElementById('errorText');
    debugInfoElement = debugInfoElement || document.getElementById('debugInfo');
    loadingSpinner = loadingSpinner || document.getElementById('loadingSpinner');
    mainContentElement = mainContentElement || document.getElementById('mainContent');
    initialMessageElement = initialMessageElement || document.getElementById('initialMessage');
    errorMessageElement = errorMessageElement || document.getElementById('errorMessage');

    // Add debug info
    if (debugInfoElement) {
        debugURLParameters(); // Show URL params in debug info
        debugInfoElement.innerHTML += `<br><strong>Error Type:</strong> ${error?.name || 'N/A'}`;
        debugInfoElement.innerHTML += `<br><strong>Error Message:</strong><br><span style="color:red;">${error?.message || 'Unknown error'}</span>`;
        if (error?.stack) {
            debugInfoElement.innerHTML += `<br><strong>Stack Trace:</strong><br><code style="font-size:10px; white-space: pre-wrap;">${error.stack}</code>`;
        }
    } else {
        console.error("Debug info element not found!");
    }


    if (errorTextElement) {
        errorTextElement.textContent = `${message}. See details below.`; // More specific message
    } else {
        console.error("Error text element not found!");
    }

    // Manage UI visibility
    if (loadingSpinner) {
        loadingSpinner.classList.add('hidden');
        loadingSpinner.style.display = 'none'; // Force hide
         console.log("Spinner hidden by handleError.");
    } else {
         console.error("Loading spinner not found in handleError!");
    }
    if (mainContentElement) mainContentElement.classList.add('hidden');
    if (initialMessageElement) initialMessageElement.style.display = 'none';
    if (errorMessageElement) {
         errorMessageElement.classList.remove('hidden');
         errorMessageElement.style.display = 'flex'; // Force show
         console.log("Error message shown by handleError.");
    } else {
        console.error("Error message element not found!");
        alert(`Critical Error: ${message}\n${error?.message}`); // Fallback alert
    }
}

// --- Initialize Dashboard Data Logic ---
function initializeDashboard() {
    console.log("--- initializeDashboard START ---");
    const params = new URLSearchParams(window.location.search);
    const dataElement = document.getElementById('embeddedPsrData');
    let dataLoaded = false;
    let rawData = null;

    try {
        // --- Parameter Parsing Helpers (keep as is) ---
        const getParam = (keyBase) => { /* ... existing code ... */ };
        const parseNumeric = (keyName, value, defaultValue = 0) => { /* ... existing code ... */ };
        const decodeField = (fieldName) => { /* ... existing code ... */ };


        if (params.toString().length > 0 && (params.has('userName') || params.has('username'))) {
            console.log("--- Parsing URL Parameters ---");
            // ... (parsing all parameters as before) ...
            const fetchedUserName = getParam('userName') || getParam('username') || 'User'; // Default if missing
            const fetchedAge = parseNumeric('age', getParam('age'), 30); // Default age

             // Estimate minimum payments more realistically (example)
             const fetchedCreditCardDebt = parseNumeric('creditCardDebt', getParam('creditCardDebt') || getParam('creditcard'));
             const fetchedBankLoans = parseNumeric('bankLoans', getParam('bankLoans') || getParam('loans'));
             // Example: 3% of balance or $25, whichever is higher for CC
             const ccMinPayment = Math.max(fetchedCreditCardDebt * 0.03, 25);
             // Example: 1% of balance + estimated interest (e.g., 6.5% APR / 12) or $50 for loans
             const loanMinPayment = Math.max(fetchedBankLoans * 0.01 + (fetchedBankLoans * (0.065 / 12)), 50);


            rawData = {
                userInput: {
                     personalInfo: { userName: fetchedUserName, age: fetchedAge },
                     income: {
                        mainJobIncome: parseNumeric('mainJobIncome', getParam('mainJobIncome')),
                        secondJob: parseNumeric('secondJobIncome', getParam('secondJobIncome') || getParam('secondJob')),
                        otherIncome: parseNumeric('otherIncome', getParam('otherIncome'))
                    },
                    expenses: {
                        housing: parseNumeric('housing', getParam('housing')),
                        transportation: parseNumeric('transportation', getParam('transportation')),
                        utilities: parseNumeric('utilities', getParam('utilities')),
                        groceriesEssentials: parseNumeric('groceries-essentials', getParam('groceries-essentials') || getParam('groceries')),
                        insurance: parseNumeric('insurance', getParam('insurance')),
                        medical: parseNumeric('medical', getParam('medical')),
                        care: parseNumeric('care', getParam('care')),
                        subscriptions: parseNumeric('subscriptions', getParam('subscriptions')),
                        taxes: parseNumeric('taxes', getParam('taxes'))
                     },
                    savings: {
                        emergency: parseNumeric('emergencySavings', getParam('emergencySavings') || getParam('emergency')),
                        savings: parseNumeric('currentSavings', getParam('currentSavings') || getParam('savings')),
                        retirement: parseNumeric('retirementFund', getParam('retirementFund') || getParam('retirement')),
                        // Let's try parsing an emergency goal if provided, e.g., &emergencyGoal=10000
                        emergencyFundTarget: parseNumeric('emergencyFundTarget', getParam('emergencyFundTarget'), 0) // Default 0 if not specified
                    },
                    debts: [
                        // Only include debts if balance > 0
                        ...(fetchedCreditCardDebt > 0 ? [{ type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: 22.5, minPayment: ccMinPayment }] : []),
                        ...(fetchedBankLoans > 0 ? [{ type: "Bank Loans", balance: fetchedBankLoans, interestRate: 6.5, minPayment: loanMinPayment }] : [])
                    ],
                    financials: {
                        financialTools: decodeField('financialTools'),
                        challenges: decodeField('challenges'),
                        upcomingPurchase: decodeField('upcomingPurchases')
                    }
                },
                aiOutput: {
                    analysis: decodeField('aiAnalysis') || 'Analysis not provided.', // Default text
                    recommendations: decodeField('recommendations') || 'Recommendations not provided.', // Default text
                    userProgress: decodeField('userProgressHistory') || decodeField('userProgress') || 'Progress history not available.' // Default text
                }
            };

            console.log("--- Validating Parsed URL Data ---");
            // Refined Validation: Check if we have *some* financial activity
            const hasAnyFinancials = Object.values(rawData.userInput.income || {}).some(v => v > 0) ||
                                   Object.values(rawData.userInput.expenses || {}).some(v => v > 0) ||
                                   Object.values(rawData.userInput.savings || {}).some(v => v > 0) ||
                                   (rawData.userInput.debts || []).length > 0;

            if (hasAnyFinancials) {
                dashboardData = rawData;
                dataLoaded = true;
                console.log(">>> Validation PASSED (URL data has financial activity). Raw data:", JSON.stringify(rawData).substring(0, 500) + "..."); // Log truncated data
            } else {
                console.warn("!!! Validation FAILED (URL data lacks income, expenses, savings, or debt). Discarding URL data.");
            }
        } else {
             console.log("--- No valid URL parameters detected (missing userName or empty query string) ---");
        }

        // ... (Attempt to load embedded JSON if !dataLoaded - keep as is) ...
         if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
             console.log("--- Attempting to load data from embedded JSON ---");
             try {
                 const embeddedJson = JSON.parse(dataElement.textContent);
                 // Add more robust check for embedded data structure
                 if (typeof embeddedJson === 'object' && embeddedJson !== null && embeddedJson.userInput && embeddedJson.userInput.personalInfo) {
                     dashboardData = embeddedJson;
                     dataLoaded = true;
                     console.log(">>> Data loaded from embedded JSON.");
                 } else {
                     console.warn("!!! Embedded content is not valid JSON or lacks expected structure (userInput/personalInfo).");
                 }
             } catch (jsonErr) {
                 console.error("!!! Error parsing embedded JSON:", jsonErr);
                 // Optionally, add this error detail to the main error display if needed
                 // debugInfoElement.innerHTML += `<br><strong>Embedded JSON Parse Error:</strong> ${jsonErr.message}`;
             }
         }

        if (dataLoaded && dashboardData) {
            console.log(">>> Data loaded successfully. Calling processAndDisplayData...");
            processAndDisplayData(dashboardData);
             console.log(">>> Returned from processAndDisplayData call.");
        } else {
             console.warn("No valid data loaded from URL or embedded JSON. Displaying initial message.");
             loadingSpinner?.classList.add('hidden');
             loadingSpinner?.style.display = 'none';
             mainContentElement?.classList.add('hidden');
             document.getElementById('chatInterfaceCard')?.style.display = 'none'; // Hide chat if no data
             initialMessageElement.style.display = 'block'; // Show the 'Upload or use URL' message
        }
        console.log("--- initializeDashboard END ---");

    } catch (err) {
        console.error("--- initializeDashboard CRITICAL ERROR ---", err);
        handleError("Dashboard initialization failed", err); // Use the central error handler
    }
}


// --- Main Data Processing & Display Function ---
function processAndDisplayData(data) {
    if (!data || typeof data !== 'object' || !data.userInput) {
        console.error("Invalid data received by processAndDisplayData", data);
        handleError("Invalid data format for processing", new Error("Data structure is missing userInput."));
        return;
    }
    console.log("--- processAndDisplayData START ---");
    dashboardData = data; // Ensure global data is set

    try {
        console.log("1. Calculating totals...");
        const totals = calculateTotals(data);
        console.log("Totals calculated:", totals);

        console.log("2. Calculating ratios...");
        const ratios = calculateRatios(data, totals);
        console.log("Ratios calculated:", ratios);

        console.log("3. Updating basic info UI...");
        updateReportBasics(data, totals);
        console.log("Basic info UI updated.");

        console.log("4. Updating ratios UI...");
        updateRatiosDisplay(ratios);
        console.log("Ratios UI updated.");

        console.log("5. Updating goals UI...");
        updateGoalsDisplay(data, totals); // Pass totals if needed for context
        console.log("Goals UI updated.");

        console.log("6. Updating debts UI...");
        updateDebtsDisplay(data, totals); // Pass totals object which now includes min payments
        console.log("Debts UI updated.");

        // Defer chart rendering
        console.log("7. Scheduling chart rendering...");
        requestAnimationFrame(() => {
             console.log("7a. Executing chart rendering (inside requestAnimationFrame)...");
             try {
                renderCharts(data);
                console.log("Charts rendered successfully.");
             } catch (chartError) {
                 console.error("--- Error during renderCharts ---", chartError);
                 handleError("Failed to render charts", chartError);
                 // Optionally hide chart areas or show specific error messages in chart divs
                 document.getElementById('incomeChart').innerHTML = '<p class="text-red-600 text-center p-4">Error loading income chart.</p>';
                 document.getElementById('expenseChart').innerHTML = '<p class="text-red-600 text-center p-4">Error loading expense chart.</p>';
             }
        });


        console.log("8. Updating AI display UI...");
        updateUIDisplayFromAI(data);
        console.log("AI display UI updated.");

        console.log("9. Initializing chat...");
        initializeChat();
        console.log("Chat initialized.");

        console.log("10. Making main content visible...");
        errorMessageElement?.classList.add('hidden'); // Ensure error message is hidden
        initialMessageElement.style.display = 'none'; // Hide initial message
        mainContentElement?.classList.remove('hidden'); // Show dashboard
        mainContentElement?.style.display = 'block'; // Ensure it's displayed
        console.log("Main content should now be visible.");

    } catch (processingError) {
        console.error("--- processAndDisplayData ERROR ---", processingError);
        handleError("Error processing or displaying data", processingError);
    } finally {
        // Ensure spinner is hidden regardles of success/failure within the try block
         console.log("Executing finally block in processAndDisplayData.");
         loadingSpinner = loadingSpinner || document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.classList.add('hidden');
             loadingSpinner.style.display = 'none'; // Force hide
             console.log("Spinner hidden by processAndDisplayData finally block.");
        } else {
            console.warn("Spinner element not found in finally block.");
        }
        console.log("--- processAndDisplayData END ---");
    }
}

function calculateTotals(data) {
    const totals = {
        totalIncome: 0,
        totalExpenses: 0,
        netFlow: 0,
        totalDebt: 0,
        totalSavings: 0,
        totalMinPayments: 0 // Added for debt calculation
    };
    // Ensure data structure exists before accessing
    const income = data?.userInput?.income || {};
    const expenses = data?.userInput?.expenses || {};
    const savings = data?.userInput?.savings || {};
    const debts = data?.userInput?.debts || [];

    totals.totalIncome = Object.values(income).reduce((sum, value) => sum + (Number(value) || 0), 0);
    totals.totalExpenses = Object.values(expenses).reduce((sum, value) => sum + (Number(value) || 0), 0);
    totals.netFlow = totals.totalIncome - totals.totalExpenses;
    totals.totalDebt = debts.reduce((sum, debt) => sum + (Number(debt.balance) || 0), 0);
    totals.totalMinPayments = debts.reduce((sum, debt) => sum + (Number(debt.minPayment) || 0), 0);

    // Total savings includes emergency, general, and retirement
    totals.totalSavings = (Number(savings.emergency) || 0) + (Number(savings.savings) || 0) + (Number(savings.retirement) || 0);

    return totals;
}


function calculateRatios(data, totals) {
    const ratios = {
        savingsRate: 0,         // Monthly Savings Contribution / Gross Monthly Income
        emergencyCoverage: 0,   // Current Emergency Fund Balance / Monthly Expenses (in months)
        dtiRatio: 0             // Total Monthly Minimum Debt Payments / Gross Monthly Income
    };
    const savingsInput = data?.userInput?.savings || {};
    const expenses = data?.userInput?.expenses || {}; // Needed again for emergency fund target calc

    // Savings Rate: Estimate monthly contribution. This is tricky without explicit input.
    // Option 1: Use Net Flow if positive? (Assumes all net flow is saved)
    // Option 2: Assume a fixed % goal? (Less accurate)
    // Option 3: Look for a specific input field (e.g., 'monthlySavingsContribution') - Preferred if available.
    // Let's use positive Net Flow as a proxy for now, but acknowledge its limitation.
    const monthlySavingsContribution = Math.max(0, totals.netFlow); // Proxy - use positive net flow
    if (totals.totalIncome > 0) {
        // Use the proxy contribution for the rate calculation
         ratios.savingsRate = (monthlySavingsContribution / totals.totalIncome) * 100;
         // If we had a dedicated 'monthly savings' input:
         // const monthlyContribution = Number(data.userInput.savings.monthlyContribution) || 0;
         // ratios.savingsRate = (monthlyContribution / totals.totalIncome) * 100;
    }

    // Emergency Fund Coverage (Months)
    const currentEmergencyFund = Number(savingsInput.emergency) || 0;
    if (totals.totalExpenses > 0) {
         ratios.emergencyCoverage = currentEmergencyFund / totals.totalExpenses; // Result is in months
    }

    // Debt-to-Income (DTI) Ratio (using minimum payments)
    if (totals.totalIncome > 0) {
         ratios.dtiRatio = (totals.totalMinPayments / totals.totalIncome) * 100;
    }

    return ratios;
}

function updateRatiosDisplay(ratios) {
    // Savings Rate
    updateElementText('savingsRateValue', ratios.savingsRate, (val) => formatPercentage(val, 1));
    const savingsRatePercent = Math.min(100, Math.max(0, ratios.savingsRate || 0)); // Clamp between 0-100
    const savingsBar = document.getElementById('savingsRateBar');
    if (savingsBar) {
        savingsBar.style.width = `${savingsRatePercent}%`;
        // Recommendation: Poor < 5%, Fair 5-10%, Good 10-15%, Excellent > 15%
        savingsBar.className = `ratio-bar savings-rate ${savingsRatePercent >= 15 ? 'good' : savingsRatePercent >= 10 ? 'ok' : 'poor'}`; // Adjust classes if needed
    }

    // Emergency Fund Coverage (Display in Months)
    updateElementText('emergencyCoverageValue', ratios.emergencyCoverage.toFixed(1) + ' months'); // Display as months
    // Target: 3-6 months. Bar shows progress towards 6 months.
    const emergencyCoverageMonths = ratios.emergencyCoverage || 0;
    const emergencyProgressPercent = Math.min(100, Math.max(0, (emergencyCoverageMonths / 6) * 100)); // Progress towards 6 months
    const emergencyBar = document.getElementById('emergencyCoverageBar');
    if (emergencyBar) {
        emergencyBar.style.width = `${emergencyProgressPercent}%`;
        // Recommendation: Poor < 1 month, Fair 1-3 months, Good 3-6 months, Excellent > 6 months
        emergencyBar.className = `ratio-bar emergency-coverage ${emergencyCoverageMonths >= 3 ? 'good' : emergencyCoverageMonths >= 1 ? 'ok' : 'poor'}`; // Adjust classes
    }


    // DTI Ratio
    updateElementText('dtiRatioValue', ratios.dtiRatio, (val) => formatPercentage(val, 1));
    const dtiPercent = Math.min(100, Math.max(0, ratios.dtiRatio || 0)); // Clamp 0-100
    const dtiBar = document.getElementById('dtiRatioBar');
    if (dtiBar) {
        dtiBar.style.width = `${dtiPercent}%`;
        // General guideline: Excellent < 15%, Good 15-36%, Fair 37-43%, Poor > 43%
         dtiBar.className = `ratio-bar dti-ratio ${dtiPercent > 43 ? 'high' : dtiPercent > 36 ? 'warning' : 'good'}`; // Use standard DTI colors
    }
}


function updateGoalsDisplay(data, totals) {
    const savingsInput = data?.userInput?.savings || {};
    const financialsInput = data?.userInput?.financials || {};
    const upcomingPurchaseString = financialsInput.upcomingPurchase || '';

    // --- Emergency Fund Goal ---
    const emergencyCurrent = Number(savingsInput.emergency) || 0;
    // Use target from URL/JSON if available, otherwise default to 3 months expenses
    const emergencyGoalTarget = Number(savingsInput.emergencyFundTarget) || (totals.totalExpenses * 3);
    const emergencyGoalDisplay = document.getElementById('emergencyGoalDisplay');
    const emergencyProgressBar = document.getElementById('emergencyProgressBar');

    if (emergencyGoalTarget > 0 && emergencyGoalDisplay && emergencyProgressBar) {
        emergencyGoalDisplay.style.display = 'block';
        const progress = Math.min(100, Math.max(0, (emergencyCurrent / emergencyGoalTarget) * 100));
        emergencyProgressBar.style.width = `${progress}%`;
        emergencyProgressBar.textContent = `${progress.toFixed(0)}%`; // Show percentage on bar
        const statusEl = emergencyGoalDisplay.querySelector('.goal-status');
        if (statusEl) {
            statusEl.textContent = `Target: ${formatCurrency(emergencyGoalTarget)} (${(emergencyCurrent / emergencyGoalTarget * 100).toFixed(0)}% funded)`;
        }
    } else if (emergencyGoalDisplay) {
        emergencyGoalDisplay.style.display = 'none'; // Hide if no valid target
    }

    // --- Upcoming Purchase Goal (Attempt to parse first one) ---
    const purchaseGoalDisplay = document.getElementById('purchaseGoalDisplay');
    const purchaseProgressBar = document.getElementById('purchaseProgressBar');
    const purchaseGoalNameEl = document.getElementById('purchaseGoalName');
    const noGoalsMessage = document.getElementById('noGoalsMessage');
    let purchaseGoalFound = false;

    if (upcomingPurchaseString && purchaseGoalDisplay && purchaseProgressBar && purchaseGoalNameEl) {
        // Try to extract the first item: "#1) Name, $Amount, Date"
        const match = upcomingPurchaseString.match(/#\d+\)\s*(.*?),\s*\$?([\d,.]+)/);
        if (match && match[1] && match[2]) {
            const goalName = match[1].trim();
            const goalAmountStr = match[2].replace(/,/g, ''); // Remove commas
            const goalAmount = parseFloat(goalAmountStr);
            const generalSavings = Number(savingsInput.savings) || 0;

            if (goalName && !isNaN(goalAmount) && goalAmount > 0) {
                purchaseGoalFound = true;
                purchaseGoalDisplay.style.display = 'block';
                purchaseGoalNameEl.textContent = goalName;
                const progress = Math.min(100, Math.max(0, (generalSavings / goalAmount) * 100));
                purchaseProgressBar.style.width = `${progress}%`;
                purchaseProgressBar.textContent = `${progress.toFixed(0)}%`;
                 const statusEl = purchaseGoalDisplay.querySelector('.goal-status');
                 if (statusEl) {
                    statusEl.textContent = `Target: ${formatCurrency(goalAmount)} (${formatCurrency(generalSavings)} saved)`;
                 }
            }
        }
    }

    // Hide displays if goals not found/parsed
    if (!purchaseGoalFound && purchaseGoalDisplay) {
        purchaseGoalDisplay.style.display = 'none';
    }
    if (emergencyGoalTarget <= 0 && !purchaseGoalFound && noGoalsMessage) {
         noGoalsMessage.style.display = 'block';
    } else if (noGoalsMessage) {
         noGoalsMessage.style.display = 'none';
    }

     // Update the simple text fields in the Savings Overview card too
     updateElementText('emergencySavings', savingsInput.emergency, formatCurrency);
     updateElementText('currentSavings', savingsInput.savings, formatCurrency);
     updateElementText('retirementFund', savingsInput.retirement, formatCurrency);
}

function updateDebtsDisplay(data, totals) { // Pass totals object
    const debtsTableBody = document.getElementById('debtsTable')?.getElementsByTagName('tbody')[0];
    if (!debtsTableBody) {
        console.error("Debt table body not found!");
        return;
    }
    debtsTableBody.innerHTML = ''; // Clear existing rows

    const debts = data?.userInput?.debts || [];

    if (debts.length === 0) {
        debtsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No debt information provided.</td></tr>';
    } else {
        debts.forEach(debt => {
            const row = debtsTableBody.insertRow();
            row.innerHTML = `
                <td>${debt.type || 'N/A'}</td>
                <td class="balance-col">${formatCurrency(debt.balance)}</td>
                <td>${(Number(debt.interestRate) || 0).toFixed(1)}%</td>
                <td class="balance-col">${formatCurrency(debt.minPayment)}</td>
            `;
        });
    }

    // Update totals using the passed 'totals' object
    updateElementText('totalDebtBalance', totals.totalDebt, formatCurrency);
    updateElementText('totalMinPayments', totals.totalMinPayments, formatCurrency);

     // Update other financial info card
     const financials = data?.userInput?.financials || {};
     updateElementText('financialTools', financials.financialTools || 'N/A');
     updateElementText('challenges', financials.challenges || 'N/A');
     // Display the raw upcoming purchase string here, details are in the goals card
     updateElementText('purchaseGoals', financials.upcomingPurchase || 'N/A');
}

function renderCharts(data) {
    const incomeData = data?.userInput?.income || {};
    const expenseData = data?.userInput?.expenses || {};

    // Filter out zero values for cleaner charts
    const incomeLabels = Object.keys(incomeData).filter(k => Number(incomeData[k]) > 0);
    const incomeValues = incomeLabels.map(k => Number(incomeData[k]));

    const expenseLabels = Object.keys(expenseData).filter(k => Number(expenseData[k]) > 0);
    const expenseValues = expenseLabels.map(k => Number(expenseData[k]));

    const commonLayout = {
        height: 350,
        margin: { t: 40, b: 100, l: 60, r: 20 }, // Increased bottom margin for labels
        showlegend: false,
        yaxis: {
            title: 'Amount ($)',
            tickformat: ',.0f' // Format y-axis ticks as currency without decimals
        },
        xaxis: {
            tickangle: -45 // Angle labels to prevent overlap
        },
        paper_bgcolor: 'rgba(0,0,0,0)', // Transparent background
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            family: 'Inter, sans-serif',
            size: 11,
            color: '#374151'
        }
    };

    const incomeLayout = {
        ...commonLayout,
        title: 'Monthly Income Breakdown'
        // xaxis: { title: 'Income Sources' } // Removed redundant axis title
    };

    const expenseLayout = {
        ...commonLayout,
        title: 'Monthly Expense Breakdown'
        // xaxis: { title: 'Expense Categories' } // Removed redundant axis title
    };

    const incomeTrace = {
        x: incomeLabels.map(label => label.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase())), // Add spaces for readability
        y: incomeValues,
        type: 'bar',
        marker: { color: '#4f46e5' },
        text: incomeValues.map(v => formatCurrency(v)), // Add text labels to bars
        textposition: 'outside'
    };

    const expenseTrace = {
         x: expenseLabels.map(label => label.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase())), // Add spaces
        y: expenseValues,
        type: 'bar',
        marker: { color: '#ef4444' },
        text: expenseValues.map(v => formatCurrency(v)), // Add text labels
        textposition: 'outside'
    };

    const plotlyConfig = {
        displaylogo: false,
        responsive: true, // Make charts responsive
        modeBarButtonsToRemove: ['sendDataToCloud', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d', 'hoverClosestPie', 'toggleSpikelines', 'hoverCompareCartesian']
    };

    // Check if Plotly is available
    if (typeof Plotly !== 'undefined' && Plotly.newPlot) {
        if (incomeLabels.length > 0) {
            Plotly.newPlot('incomeChart', [incomeTrace], incomeLayout, plotlyConfig);
        } else {
             document.getElementById('incomeChart').innerHTML = '<p class="text-center text-gray-500 pt-10">No income data to display.</p>';
        }

        if (expenseLabels.length > 0) {
            Plotly.newPlot('expenseChart', [expenseTrace], expenseLayout, plotlyConfig);
        } else {
             document.getElementById('expenseChart').innerHTML = '<p class="text-center text-gray-500 pt-10">No expense data to display.</p>';
        }
    } else {
        console.error("Plotly library is not loaded or newPlot function is missing.");
        // Display error in chart areas
        document.getElementById('incomeChart').innerHTML = '<p class="text-red-600 text-center p-4">Charting library failed to load.</p>';
        document.getElementById('expenseChart').innerHTML = '<p class="text-red-600 text-center p-4">Charting library failed to load.</p>';
    }
}

// --- Update AI Display Function (Refined) ---
function updateUIDisplayFromAI(data) {
    const aiOutput = data?.aiOutput || {};
    const analysisEl = document.getElementById('aiAnalysis');
    const recommendationsList = document.getElementById('recommendationsList');
    const progressContentEl = document.getElementById('progressContent');

    // AI Analysis
    if (analysisEl) {
        analysisEl.innerHTML = (aiOutput.analysis || 'No analysis provided.').replace(/\n/g, '<br>'); // Simple formatting
    }

    // Recommendations
    if (recommendationsList) {
        recommendationsList.innerHTML = ''; // Clear previous
        const recs = aiOutput.recommendations || 'No recommendations provided.';
        recs.split('\n').forEach(rec => {
            const trimmedRec = rec.trim();
            if (trimmedRec && trimmedRec !== '-') { // Ignore empty lines or just dashes
                const li = document.createElement('li');
                // Basic keyword-based styling (example)
                if (trimmedRec.toLowerCase().includes('critical') || trimmedRec.toLowerCase().includes('urgent')) {
                    li.className = 'critical';
                } else if (trimmedRec.toLowerCase().includes('warning') || trimmedRec.toLowerCase().includes('consider')) {
                    li.className = 'warning';
                }
                li.textContent = trimmedRec.startsWith('- ') ? trimmedRec.substring(2) : trimmedRec; // Remove leading "- " if present
                recommendationsList.appendChild(li);
            }
        });
         if (recommendationsList.children.length === 0) {
              recommendationsList.innerHTML = '<li>No specific recommendations available.</li>';
         }
    }

     // Progress History (for modal)
     if (progressContentEl) {
         progressContentEl.textContent = aiOutput.userProgress || 'No progress history available.';
     }
}


// --- Chat Functionality (Mostly unchanged, check selectors) ---
function initializeChat() {
    console.log("--- initializeChat START ---");
    const chatInput = document.getElementById('chatInput');
    const chatSendButton = document.getElementById('chatSendButton');
    const chatHistory = document.getElementById('chatHistory');
    const chatInterfaceCard = document.getElementById('chatInterfaceCard');

    // Ensure all elements exist
    if (!chatInput || !chatSendButton || !chatHistory || !chatInterfaceCard) {
        console.error("One or more Chat UI elements not found! Aborting chat initialization.");
        // Optionally hide the chat card if elements are missing
        if(chatInterfaceCard) chatInterfaceCard.style.display = 'none';
        return;
    }

    // Show chat card only if data was successfully processed
    chatInterfaceCard.style.display = 'grid';

    if (!supabase) {
        addMessageToChat("System", "Chat service connection failed (Supabase not initialized).", true);
        enableChatInput(false);
        setChatStatus("Chat unavailable", false);
        return;
    }

    // Check Supabase functions capability more directly (optional but good)
    if (!supabase.functions) {
         addMessageToChat("System", "Chat service connection failed (Supabase client missing functions capability).", true);
        enableChatInput(false);
        setChatStatus("Chat unavailable", false);
         return;
    }

    enableChatInput(true);
    chatHistory.innerHTML = ''; // Clear previous messages
    addMessageToChat("Assistant", "Hello! Ask me anything about the financial data shown on your dashboard.", false); // More engaging prompt
    setChatStatus("", false); // Clear any previous status


    // Remove previous listeners before adding new ones to prevent duplicates if re-initialized
    chatSendButton.removeEventListener('click', handleChatSubmit);
    chatInput.removeEventListener('keydown', handleChatEnterKey); // Use named function

    // Add listeners
    chatSendButton.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keydown', handleChatEnterKey); // Use named function

    console.log("--- initializeChat END ---");
}

// Named function for the Enter key listener
function handleChatEnterKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        handleChatSubmit();
    }
}

function enableChatInput(enabled) {
    const chatInput = document.getElementById('chatInput');
    const chatSendButton = document.getElementById('chatSendButton');
    if (chatInput && chatSendButton) {
        chatInput.disabled = !enabled;
        chatSendButton.disabled = !enabled;
        chatInput.placeholder = enabled ? "Ask about your finances..." : "Chat unavailable";
        // Adjust opacity for visual feedback
        chatInput.style.opacity = enabled ? '1' : '0.6';
        chatSendButton.style.opacity = enabled ? '1' : '0.6';
        chatSendButton.style.cursor = enabled ? 'pointer' : 'not-allowed';
    }
}

async function sendToBackendChatFunction() {
    // ... (keep existing context building, but ensure dashboardData is valid) ...
     if (!dashboardData?.userInput?.personalInfo) { // Check a nested required field
         addMessageToChat("System", "Error: Financial data seems incomplete or not loaded correctly.", true);
         setChatStatus("Error: Data missing", false);
         enableChatInput(true); // Re-enable input maybe? Or leave disabled? Depends on desired UX.
         return;
     }
    // ... (rest of the function: build context, check supabase, call fetch) ...

     const backendEndpoint = `${SUPABASE_URL}/functions/v1/smooth-function`; // Construct URL properly

     console.log(`Sending ${messagesForBackend.length} messages to backend: ${backendEndpoint}`);
     console.log("Payload:", JSON.stringify({ messages: messagesForBackend }).substring(0, 300) + "..."); // Log truncated payload

     setChatStatus("Thinking...", true);
     enableChatInput(false);

     try {
        const { data, error } = await supabase.functions.invoke('smooth-function', {
            body: { messages: messagesForBackend },
        });

        setChatStatus("", false); // Clear thinking indicator

        if (error) {
            // Handle Supabase function invocation errors
            console.error("Supabase function invocation error:", error);
            throw new Error(`Backend Error: ${error.message || 'Failed to invoke function'}`);
        }

        // Check the structure of the successful response 'data'
        if (data && data.assistantResponse && data.assistantResponse.content) {
            addMessageToChat("Assistant", data.assistantResponse.content);
            chatMessages.push(data.assistantResponse); // Add AI response to history
        } else {
             console.error("Unexpected response format from backend:", data);
            throw new Error("Received an unexpected response format from the AI service.");
        }

    } catch (error) {
         console.error("Error during chat interaction:", error);
         addMessageToChat("System", `Sorry, I encountered an error: ${error.message}`, true);
         setChatStatus("Error", false);
    } finally {
         enableChatInput(true); // Always re-enable input
    }
}

// --- Modals and Other Helpers (Keep as is, ensure IDs match HTML) ---
function initModals() { /* ... */ }
function openModal(modalId) { /* ... */ }
function closeModal(modalId) { /* ... */ }
function initSaveButton() { /* ... */ }
function initUploadButton() { /* ... */ }
function useDemoData() { /* ... */ } // Ensure demo data structure matches expected format

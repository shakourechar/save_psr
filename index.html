<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartWealth Navigator â€“ Personal Finance Dashboard</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=EB+Garamond:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.5/dist/umd/supabase.min.js"></script>
  <!-- Google APIs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    :root{--primary-color:#0f766e}
    body{font-family:Inter,Arial,sans-serif;background:#f9fafb;color:#111827}
    header{background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .card{background:#fff;border-radius:0.75rem;padding:1rem;box-shadow:0 1px 4px rgba(0,0,0,.05)}
    .ratio-bar{height:0.5rem;border-radius:0.25rem;background:#e5e7eb}
    .ratio-bar>span{display:block;height:100%;border-radius:0.25rem}
    .ratio-bar.good>span{background:#10b981}
    .ratio-bar.ok>span{background:#f59e0b}
    .ratio-bar.poor>span{background:#ef4444}
    .ratio-bar.high>span{background:#ef4444}
    .floating-btn{position:fixed;top:0.75rem;left:0.75rem;width:2.5rem;height:2.5rem;border-radius:9999px;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 6px rgba(0,0,0,.1);cursor:pointer;z-index:50}
    .floating-btn:hover{background:#047857}
    @media(max-width:768px){.grid-cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Floating scrollâ€‘toâ€‘bottom button -->
  <button id="scrollBottom" class="floating-btn hidden" title="Scroll to bottom">â†“</button>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="flex-1 flex items-center justify-center p-8 hidden">
    <div class="animate-spin h-12 w-12 border-4 border-teal-500 border-t-transparent rounded-full"></div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="flex-1 flex-col items-center justify-center p-8 hidden">
    <h2 class="text-xl font-semibold text-red-600 mb-4">Something went wrong</h2>
    <pre id="errorText" class="whitespace-pre-wrap text-sm text-gray-700"></pre>
    <button id="retryButton" class="mt-4 px-4 py-2 bg-teal-600 text-white rounded">Retry</button>
    <button id="manualEntryButton" class="mt-4 ml-2 px-4 py-2 bg-gray-600 text-white rounded">Manual Upload</button>
    <div id="debugInfo" class="mt-6 text-xs text-left max-h-64 overflow-auto"></div>
  </div>

  <!-- Initial prompt / manual upload -->
  <div id="initialUploadPrompt" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-6">
    <h1 class="text-2xl font-semibold">SmartWealth Navigator</h1>
    <p class="text-gray-600">Upload your PSR file or open the dashboard with a valid link.</p>
    <input id="fileInput" type="file" accept="application/json" class="hidden" />
    <button id="uploadBtn" class="px-6 py-3 bg-teal-600 text-white rounded">Choose File</button>
    <button id="useDemoBtn" class="px-6 py-3 bg-gray-600 text-white rounded">Try Demo Data</button>
  </div>

  <!-- Main Content -->
  <main id="mainContent" class="flex-1 flex-col space-y-6 p-4 hidden">
    <!-- Header -->
    <header class="flex flex-wrap items-center justify-between p-4 rounded-lg">
      <div>
        <h2 class="text-2xl font-semibold mb-1">Hello, <span id="userName">User</span></h2>
        <p class="text-sm text-gray-500">Tier: <span id="chatTierDisplay">-</span> Â· Model: <span id="chatModelDisplay">-</span> Â· Usage: <span id="chatUsageDisplay">-</span></p>
      </div>
      <div class="space-x-2 mt-4 md:mt-0">
        <button id="downloadBtn" class="px-4 py-2 bg-teal-600 text-white rounded">Save Report</button>
        <button id="proFeatureButton" class="px-4 py-2 bg-amber-600 text-white rounded hidden">Pro Feature</button>
      </div>
    </header>

    <!-- Dashboard Grid -->
    <section class="grid grid-cols-2 gap-4">
      <!-- Income Chart -->
      <div class="card">
        <h3 class="font-semibold mb-2">Income Breakdown</h3>
        <div id="incomeChart" class="h-72 flex items-center justify-center"><p class="text-gray-400">Chart loadingâ€¦</p></div>
      </div>
      <!-- Expense Chart -->
      <div class="card">
        <h3 class="font-semibold mb-2">Expense Breakdown</h3>
        <div id="expenseChart" class="h-72 flex items-center justify-center"><p class="text-gray-400">Chart loadingâ€¦</p></div>
      </div>
      <!-- Ratios & Goals -->
      <div class="card col-span-2 space-y-4">
        <h3 class="font-semibold">Key Ratios</h3>
        <div class="space-y-2">
          <div>
            <p class="text-sm">Savings Rate: <span id="savingsRateValue">-</span></p>
            <div class="ratio-bar savings-rate"><span id="savingsRateBar"></span></div>
          </div>
          <div>
            <p class="text-sm">Emergency Coverage: <span id="emergencyCoverageValue">-</span></p>
            <div class="ratio-bar emergency-coverage"><span id="emergencyCoverageBar"></span></div>
          </div>
          <div>
            <p class="text-sm">Debtâ€‘toâ€‘Income: <span id="dtiRatioValue">-</span></p>
            <div class="ratio-bar dti-ratio"><span id="dtiRatioBar"></span></div>
          </div>
        </div>
        <h3 class="font-semibold mt-4">Goals</h3>
        <div id="goalsContainer" class="space-y-2">
          <div id="emergencyGoalDisplay" class="hidden">
            <p class="text-sm mb-1">Emergency Fund â€“ <span class="goal-status"></span></p>
            <div class="ratio-bar"><span id="emergencyProgressBar"></span></div>
          </div>
          <div id="purchaseGoalDisplay" class="hidden">
            <p class="text-sm mb-1"><span id="purchaseGoalName"></span> â€“ <span class="goal-status"></span></p>
            <div class="ratio-bar"><span id="purchaseProgressBar"></span></div>
          </div>
          <p id="noGoalsMessage" class="text-gray-500">No active goals.</p>
        </div>
      </div>

      <!-- Debts -->
      <div class="card col-span-2 overflow-x-auto">
        <h3 class="font-semibold mb-2">Debts</h3>
        <table id="debtsTable" class="min-w-full text-sm text-left">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="py-1">Type</th><th class="py-1">Balance</th><th class="py-1">Rate</th><th class="py-1">Min&nbsp;Pmt</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot class="border-t border-gray-200 text-right">
            <tr><td class="font-semibold">Totals</td><td id="totalDebtBalance">-</td><td></td><td id="totalMinPayments">-</td></tr>
          </tfoot>
        </table>
      </div>

    </section>

    <!-- Chat Section -->
    <section class="card space-y-4" id="chatInterfaceCard">
      <div class="max-h-60 overflow-y-auto space-y-2" id="chatMessages"></div>
      <div class="flex items-center space-x-2">
        <input id="chatInput" class="flex-1 border rounded px-3 py-2" placeholder="Ask anythingâ€¦" />
        <button id="sendMsgBtn" class="px-4 py-2 bg-teal-600 text-white rounded">Send</button>
        <button id="summarizeBtn" title="Get summary" class="px-2 py-2 bg-amber-500 text-white rounded">â‡±</button>
      </div>
    </section>
  </main>

  <!-- Hidden JSON download anchor -->
  <a id="downloadAnchor" class="hidden"></a>

<script>
// â”€â”€ GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON = 'YOUR_SUPABASE_ANON_KEY';
const EDGE_CHAT_URL = 'YOUR_EDGE_FUNCTION_URL'; // POST {messages, userId}
const EDGE_SUMMARY_URL = 'YOUR_CHAT_SUMMARY_FUNCTION_URL'; // POST {messages, userId}
let supabase = null;
let dashboardData = {};
let chatMessages = [];
let currentUserId = null;
let effectiveTier = 'basic';
let initialUsageInfo = null;

// â”€â”€ DOM SHORTCUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const qs = id => document.getElementById(id);

// Elements
const el = {
  spinner: qs('loadingSpinner'),
  errorBox: qs('errorMessage'),
  errorText: qs('errorText'),
  prompt: qs('initialUploadPrompt'),
  fileInput: qs('fileInput'),
  uploadBtn: qs('uploadBtn'),
  demoBtn: qs('useDemoBtn'),
  main: qs('mainContent'),
  chatBox: qs('chatMessages'),
  chatInput: qs('chatInput'),
  sendBtn: qs('sendMsgBtn'),
  summaryBtn: qs('summarizeBtn'),
  scrollBtn: qs('scrollBottom'),
  downloadBtn: qs('downloadBtn')
};

// â”€â”€ SMALL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtCur = v => isFinite(v)?v.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}):'â€“';
const fmtPct = v => isFinite(v)?(v*100).toFixed(1)+'%':'â€“';
const safe = (fn,d='N/A')=>{try{const v=fn();return(v===null||v===undefined||v==='')?d:v}catch{ return d }};
const b64 = str=>btoa(unescape(encodeURIComponent(str)));
const unb64 = str=>decodeURIComponent(escape(atob(str)));

// â”€â”€ INITIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded',()=>{
  el.uploadBtn.onclick = () => el.fileInput.click();
  el.fileInput.onchange = e => handleFileUpload(e.target.files[0]);
  el.demoBtn.onclick = useDemoData;
  el.sendBtn.onclick = sendChat;
  el.summaryBtn.onclick = summarizeChat;
  el.downloadBtn.onclick = saveReport;
  el.scrollBtn.onclick = ()=> el.chatBox.scrollTo({top:el.chatBox.scrollHeight,behavior:'smooth'});
  parseStartup();
});

function show(section){
  ['spinner','errorBox','prompt','main'].forEach(k=>{el[k].classList.add('hidden')});
  if(section && el[section]) el[section].classList.remove('hidden');
}

// â”€â”€ XTL PARSING & URL PARAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseStartup(){
  const params = new URLSearchParams(location.search);
  const hasData = params.has('data') && params.get('data')!=='null';
  const xtl = params.get('xtl')||'';
  if(validateXTL(xtl)){
    currentUserId = xtl.slice(11);
    effectiveTier = xtl.slice(6,11)==='16j59'?'pro':'basic';
  }
  if(hasData){
    try{
      dashboardData = JSON.parse(unb64(params.get('data')));
      processAndDisplayData(dashboardData);
    }catch(err){
      showError('Invalid data parameter',err);
    }
  }else{
    show('prompt');
  }
}

function validateXTL(code){
  if(code.length!==21) return false;
  const seg=code.slice(6,11);
  if(seg!=='16j59' && seg!=='83n45'){ showError('Access denied: invalid xtl'); return false; }
  return true;
}

// â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFileUpload(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const obj = JSON.parse(e.target.result);
      // precedence rule: file xtl overrides
      if(obj?.metadata?.xtl && validateXTL(obj.metadata.xtl)){
        currentUserId = obj.metadata.xtl.slice(11);
        effectiveTier = obj.metadata.xtl.slice(6,11)==='16j59'?'pro':'basic';
      }
      dashboardData = obj;
      processAndDisplayData(dashboardData);
    }catch(err){ showError('Invalid JSON file',err); }
  };
  reader.readAsText(file);
}

// â”€â”€ SUPABASE & USAGE FETCH (simplified) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initSupabase(){
  if(supabase) return;
  supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
  // basic usage fetch omitted for brevity â€“ relies on RLS in DB
}

// â”€â”€ DATA PROCESSING (totals, ratios, goals)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processAndDisplayData(data){
  try{
    show('spinner');
    initSupabase();
    // basic info
    qs('userName').textContent = safe(()=>data.userInput.personalInfo.userName,'User');
    // totals
    const inc=data.userInput.income||{};
    const exp=data.userInput.expenses||{};
    const debts=data.userInput.debts||[];
    const totalInc = Object.values(inc).reduce((a,b)=>a+Number(b||0),0);
    const totalExp = Object.values(exp).reduce((a,b)=>a+Number(b||0),0) + debts.reduce((a,b)=>a+Number(b.minPayment||0),0);
    const net = totalInc - totalExp;
    qs('totalIncome').textContent = fmtCur(totalInc);
    qs('totalExpenses').textContent = fmtCur(totalExp);
    qs('netFlow').textContent = fmtCur(net);
    // ratios
    const dti = totalInc? debts.reduce((a,b)=>a+Number(b.minPayment||0),0)/totalInc:0;
    const savingsRate = totalInc? Math.max(0,net)/totalInc:0;
    const coreExp = ['housing','utilities','transportation','groceriesEssentials','insurance','medical','care','subscriptions','taxes'].reduce((a,k)=>a+Number(exp[k]||0),0)+debts.reduce((a,b)=>a+Number(b.minPayment||0),0);
    const emergencyMonths = coreExp? (Number(data.userInput.savings?.emergency||0))/coreExp:0;
    updateRatio('savings',savingsRate);
    updateRatio('emergency',emergencyMonths/6);
    updateRatio('dti',dti,true);
    // debts table
    renderDebts(debts);
    // charts
    renderCharts(inc,exp);
    // chat ready
    show('main');
  }catch(err){ showError('Processing error',err); }
}
function updateRatio(key,val,flip){
  const pct = Math.min(1,Math.max(0,val));
  const bar = qs(key==='savings'?'savingsRateBar':key==='emergency'?'emergencyCoverageBar':'dtiRatioBar');
  const txt = qs(key==='savings'?'savingsRateValue':key==='emergency'?'emergencyCoverageValue':'dtiRatioValue');
  bar.style.width = (pct*100)+'%';
  bar.parentElement.classList.remove('good','ok','poor','high','warning');
  const cls = key==='dti'? (val>0.43?'high':val>=0.36?'warning':'good') : (val>= (key==='savings'?0.1: (key==='emergency'?0.5:0)) ? 'good': val>=0.25?'ok':'poor');
  bar.parentElement.classList.add(cls);
  txt.textContent = key==='emergency'?val.toFixed(1)+' mo':fmtPct(val);
}
function renderDebts(list){
  const tbody = qs('debtsTable').querySelector('tbody');
  tbody.innerHTML='';
  let totalBal=0, totalMin=0;
  list.forEach(d=>{
    totalBal+=Number(d.balance||0);
    totalMin+=Number(d.minPayment||0);
    tbody.insertAdjacentHTML('beforeend',`<tr class="border-b border-gray-100"><td>${d.type}</td><td>${fmtCur(d.balance)}</td><td>${Number(d.interestRate).toFixed(1)}%</td><td>${fmtCur(d.minPayment)}</td></tr>`);
  });
  qs('totalDebtBalance').textContent = fmtCur(totalBal);
  qs('totalMinPayments').textContent = fmtCur(totalMin);
}
function renderCharts(income,expense){
  const incLab=[],incVal=[],expLab=[],expVal=[];
  Object.entries(income).forEach(([k,v])=>{ if(v>0){incLab.push(labelize(k));incVal.push(v);} });
  Object.entries(expense).forEach(([k,v])=>{ if(v>0){expLab.push(labelize(k));expVal.push(v);} });
  const common={hole:.4,type:'pie',textinfo:'percent',hoverinfo:'label+value+percent'};
  Plotly.newPlot('incomeChart',[{...common,labels:incLab,values:incVal}],{margin:{t:20},title:{text:'Income'}});
  Plotly.newPlot('expenseChart',[{...common,labels:expLab,values:expVal}],{margin:{t:20},title:{text:'Expenses'}});
}
const labelize = s=> s.replace(/([A-Z])/g,' $1').replace(/^./,c=>c.toUpperCase());

// â”€â”€ CHAT FEATURES (basic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMsg(text,from){
  el.chatBox.insertAdjacentHTML('beforeend',`<div class="${from==='user'?'text-right':''}"><span class="inline-block px-3 py-2 rounded ${from==='user'?'bg-teal-600 text-white':'bg-gray-200'}">${text}</span></div>`);
  el.chatBox.scrollTop = el.chatBox.scrollHeight;
  if(el.chatBox.scrollHeight>el.chatBox.clientHeight) el.scrollBtn.classList.remove('hidden');
  chatMessages.push({role:from==='user'?'user':'assistant',content:text});
  if(chatMessages.length>12) chatMessages.splice(0,chatMessages.length-12); // keep last 12 (6 each)
}
async function sendChat(){
  const txt = el.chatInput.value.trim(); if(!txt) return;
  appendMsg(txt,'user');
  el.chatInput.value='';
  appendMsg('â€¦','ai');
  try{
    const res = await fetch(EDGE_CHAT_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:chatMessages.slice(-12),userId:currentUserId, tier:effectiveTier})});
    const ans = await res.json();
    el.chatBox.lastChild.remove();
    appendMsg(ans.content||'No reply','ai');
  }catch(err){ el.chatBox.lastChild.remove(); appendMsg('Error contacting AI','ai'); console.error(err); }
}
async function summarizeChat(){
  try{
    const res = await fetch(EDGE_SUMMARY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:chatMessages.slice(-12),userId:currentUserId})});
    const ans = await res.json();
    appendMsg('ğŸ“ Summary saved to report','ai');
    dashboardData.aiOutput = dashboardData.aiOutput||{};
    dashboardData.aiOutput.recommendations = ans.summary;
  }catch(err){ console.error(err); }
}

// â”€â”€ SAVE REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveReport(){
  dashboardData.metadata = {xtl:b64(location.search.match(/xtl=([^&]+)/)?.[1]||'')};
  const blob = new Blob([JSON.stringify(dashboardData,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = qs('downloadAnchor');
  a.href = url; a.download = `SWN_${Date.now()}.json`; a.click();
  URL.revokeObjectURL(url);
  // TODO: also push to Google Drive via Picker API if authorised
}

// â”€â”€ DEMO DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useDemoData(){
  dashboardData = {
    userInput:{personalInfo:{userName:'Demo'},income:{mainJobIncome:5000,otherIncome:500},expenses:{housing:1500,utilities:250,transportation:400,groceriesEssentials:600,insurance:300,subscriptions:80,taxes:1000},savings:{emergency:5000},debts:[{type:'Credit Card',balance:3000,interestRate:22,minPayment:120}]},
    aiOutput:{analysis:'Demo'},metadata:{xtl:''}
  };
  processAndDisplayData(dashboardData);
}

// â”€â”€ ERROR HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg,err){
  console.error(msg,err);
  el.errorText.textContent = msg + (err? '\n'+err.message:'');
  show('errorBox');
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartWealth Navigator - Financial Health Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    h1, h2, h3, h4 {
      font-family: 'EB Garamond', serif;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    header img {
      width: 64px; /* Adjust size as needed */
      height: auto; /* Maintain aspect ratio */
      margin-right: 20px;
      margin-bottom: 10px; /* Add margin for smaller screens */
    }
     header div h1 {
       margin: 0;
       font-size: 1.8rem; /* Adjust size */
       color: #333;
     }
     header div h2 {
        margin: 0;
        font-size: 1.1rem; /* Adjust size */
        color: #555;
        font-family: 'Inter', sans-serif; /* Use body font for subtitle */
        font-weight: 400;
     }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer; /* Keep pointer for modal */
      transition: box-shadow 0.2s ease-in-out;
    }
    .card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .card-title {
      font-size: 1.3rem; /* Slightly smaller title */
      margin-bottom: 10px;
      color: #4b6777; /* Use a theme color */
    }
    .metric-number {
      font-size: 1.8rem; /* Slightly smaller metric */
      font-weight: bold;
      margin-bottom: 5px;
      color: #2c2c2c;
    }
     .metric-desc { /* Style for description text */
         font-size: 0.9rem;
         color: #6c757d; /* Muted color */
     }
    .chart-card {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* Modal styles */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); /* Darker background */
      display: none; justify-content: center; align-items: center;
      z-index: 1000; /* Ensure it's on top */
      backdrop-filter: blur(3px); /* Optional blur effect */
    }
    .modal-content {
      background: #fff; padding: 30px; border-radius: 8px;
      max-width: 500px; width: 90%; position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .modal-close {
      position: absolute; top: 10px; right: 15px; cursor: pointer;
      font-size: 1.5rem; font-weight: bold; color: #aaa;
      line-height: 1;
    }
     .modal-close:hover { color: #333; }
    .save-button {
      background: #4b6777; /* Theme color */
      color: #fff; padding: 10px 20px; border: none;
      border-radius: 4px; cursor: pointer; font-size: 1rem;
      margin-top: 20px; display: block; /* Make it block level */
      width: fit-content; /* Fit content width */
      margin-left: auto; margin-right: auto; /* Center button */
    }
    .save-button:hover { background: #3a506b; /* Darker shade */ }
     /* Utility for list styling */
     ul { list-style: disc; padding-left: 20px; margin-top: 5px;}
     li { margin-bottom: 5px; }
     #errorMessage { color: #c1432e; font-weight: bold; text-align: center; padding: 20px; }
     #loadingMessage { text-align: center; padding: 20px; font-size: 1.1em; color: #6c757d;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="images/SWN Logo-2.jpg" alt="SmartWealth Navigator Logo">
      <div>
        <h1>SmartWealth Navigator</h1>
        <h2>Financial Health Dashboard</h2>
      </div>
    </header>

    <div id="loadingMessage">Loading report data...</div>
    <div id="errorMessage" style="display: none;"></div>

    <div id="mainContent" style="display: none;">

      <section id="financial-overview" class="mb-8">
        <div class="card" data-metric="overview"> <h2 class="card-title">Financial Overview</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <div class="card" data-metric="income">
              <h3 class="card-title">Income</h3>
              <div class="metric-number" id="incomeValue">$0/mo</div>
              <p class="metric-desc" id="incomeDesc">$0/year</p>
            </div>
            <div class="card" data-metric="expenses">
              <h3 class="card-title">Expenses</h3>
              <div class="metric-number" id="expensesValue">$0/mo</div>
              <p class="metric-desc" id="expensesDesc">$0/year</p>
            </div>
            <div class="card" data-metric="savings">
              <h3 class="card-title">Savings</h3>
              <div class="metric-number" id="savingsValue">$0</div>
              <p class="metric-desc" id="savingsDesc">Total Reported</p>
            </div>
            <div class="card" data-metric="debt">
              <h3 class="card-title">Debt</h3>
              <div class="metric-number" id="debtValue">$0</div>
              <p class="metric-desc" id="debtDesc">Monthly Min: $0</p>
            </div>
            <div class="card" data-metric="networth">
              <h3 class="card-title">Net Worth</h3>
              <div class="metric-number" id="netWorthValue">$0</div>
              <p class="metric-desc" id="netWorthDesc">...</p>
            </div>
          </div>
        </div>
      </section>

      <section id="chartsSection" class="mb-8">
         <h2 class="card-title mb-4 pl-1">Visualizations</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="chart-card" data-metric="expensesChart">
            <h3 class="card-title">Expenses Breakdown</h3>
            <canvas id="expensesBreakdownChart" style="width:100%; height:300px;"></canvas>
          </div>
          <div class="chart-card" data-metric="debtIncomeChart">
            <h3 class="card-title">Debt Payments vs Income</h3>
             <p class="metric-desc mb-2">Ratio: <span id="dtiRatioValue" class="font-semibold">0%</span></p>
            <canvas id="debtIncomeChart" style="width:100%; height:270px;"></canvas>
          </div>
          <div class="chart-card" data-metric="emergencySavingsChart">
            <h3 class="card-title">Emergency Savings</h3>
             <p class="metric-desc mb-2">Coverage: <span id="emergencyMonthsValue" class="font-semibold">0 months</span> (Goal: 6 months)</p>
            <canvas id="emergencySavingsChart" style="width:100%; height:270px;"></canvas>
          </div>
        </div>
      </section>

      <section id="analysisSection" class="mb-8">
         <h2 class="card-title mb-4 pl-1">Analysis & Recommendations</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card" data-metric="analysis">
            <h3 class="card-title">Strengths & Weaknesses</h3>
            <div id="strengthsList"> <h4>Strengths</h4> <p class="text-gray-500 italic">Loading...</p> </div>
            <div id="weaknessesList" class="mt-4"> <h4>Weaknesses</h4> <p class="text-gray-500 italic">Loading...</p> </div>
          </div>
          <div class="card" data-metric="recommendations">
            <h3 class="card-title">Personalized Recommendations</h3>
            <div id="recommendationsList"> <p class="text-gray-500 italic">Loading...</p> </div>
          </div>
        </div>
      </section>

      <button id="saveButton" class="save-button">Save Full Report Data (JSON)</button>
    </div> </div> <div id="modal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <h3 id="modalTitle" class="card-title">Metric Details</h3>
      <p id="modalContent">Definition and summary grading will appear here.</p>
       <div id="modalDetails" class="mt-4 text-sm text-gray-700"></div>
    </div>
  </div>

  <script>
    let fetchedReportData = {}; // Store fetched data globally for save button

    // Helper function to format currency
    function formatCurrency(value) {
        const number = Number(value);
        if (isNaN(number)) return '$0'; // Simpler default for cards
        // Format without cents if it's a whole number for cleaner look in cards
        const options = { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 };
        if (number % 1 !== 0) { // Add cents if not a whole number
             options.minimumFractionDigits = 2;
             options.maximumFractionDigits = 2;
        }
        return number.toLocaleString('en-US', options);
    }
     function formatCurrencyWithCents(value) {
         const number = Number(value);
         if (isNaN(number)) return '$0.00';
         return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
     }
    function formatPercent(value, decimals = 1) {
        const number = Number(value);
        if (isNaN(number)) return '0%';
        return `${number.toFixed(decimals)}%`;
    }
     function formatMonths(value) {
         const number = Number(value);
         if (isNaN(number)) return '0 mo';
         return `${number.toFixed(2)} mo`;
     }

    // Fetch dynamic JSON data from the static file
    async function fetchData() {
      const dataFile = 'psr.json'; // The file Pipedream creates
      const loadingMsg = document.getElementById('loadingMessage');
      const errorMsg = document.getElementById('errorMessage');
      const mainContent = document.getElementById('mainContent');

      loadingMsg.style.display = 'block';
      errorMsg.style.display = 'none';
      mainContent.style.display = 'none';

      try {
        const response = await fetch(dataFile);
        if (!response.ok) {
          throw new Error(`Network response was not ok (${response.status}). Could not load ${dataFile}.`);
        }
        const data = await response.json();
        fetchedReportData = data; // Store data globally
        loadingMsg.style.display = 'none';
        mainContent.style.display = 'block';
        return data;
      } catch (error) {
        console.error("Fetch error:", error);
        errorMsg.textContent = `Failed to load report data: ${error.message}`;
        errorMsg.style.display = 'block';
        loadingMsg.style.display = 'none';
        return null; // Return null to indicate failure
      }
    }

    // Update text content of the financial overview section
    function updateReport(data) {
      if (!data || !data.aiCalculations || !data.userInput) return; // Basic check

      const incomeData = data.aiCalculations.incomeSummary || {};
      const expenseData = data.aiCalculations.expenseSummary || {};
      const savingsData = data.aiCalculations.savingsSummary || {};
      const debtData = data.aiCalculations.debtSummary || {};
      const netWorthData = data.aiCalculations.netWorth || {};
      const debtInput = data.userInput.debtsAndLiabilities || {};

      document.getElementById('incomeValue').innerText = formatCurrency(incomeData.totalMonthlyIncome) + '/mo';
      document.getElementById('incomeDesc').innerText = formatCurrency(incomeData.totalAnnualIncome) + '/year';
      document.getElementById('expensesValue').innerText = formatCurrency(expenseData.totalMonthlyExpenses) + '/mo';
      document.getElementById('expensesDesc').innerText = formatCurrency(expenseData.totalAnnualExpenses) + '/year';
      document.getElementById('savingsValue').innerText = formatCurrency(savingsData.totalSavingsReported);
      document.getElementById('debtValue').innerText = formatCurrency(debtData.totalDebtCalculated);
      document.getElementById('debtDesc').innerText = `Monthly Min: ${formatCurrency(debtInput.totalMinimumMonthlyDebtPayments)}`;
      document.getElementById('netWorthValue').innerText = formatCurrency(netWorthData.calculatedNetWorth);
      document.getElementById('netWorthDesc').innerText = netWorthData.netWorthStatus || '...';
    }

    // Render charts using Plotly.js
    function renderCharts(data) {
       if (!data || !data.aiCalculations || !data.userInput) return; // Basic check

       const calc = data.aiCalculations || {};
       const input = data.userInput || {};
       const analysis = data.aiAnalysisAndRecommendations || {}; // For potential future use


        try {
            // --- Expenses Breakdown Pie Chart ---
            const expenseInputData = input.monthlyExpenses || {};
            const expenseCategories = ['Housing', 'Utilities', 'Transportation', 'Food/Essentials', 'Insurance', 'Medical', 'Care', 'Subscriptions', 'Other'];
            const expenseValues = [
                 parseFloat(expenseInputData.housing || 0),
                 parseFloat(expenseInputData.utilities || 0),
                 parseFloat(expenseInputData.transportation || 0),
                 parseFloat(expenseInputData.foodAndEssentials || 0),
                 parseFloat(expenseInputData.insurance || 0),
                 parseFloat(expenseInputData.medical || 0),
                 parseFloat(expenseInputData.childOrElderCare || 0),
                 parseFloat(expenseInputData.subscriptions || 0),
                 parseFloat(expenseInputData.otherMonthlyExpenses || 0)
             ];
            const filteredExpenses = expenseValues.map((value, index) => ({ label: expenseCategories[index], value: value }))
                                                  .filter(item => item.value > 0);

            if (document.getElementById('expensesBreakdownChart') && filteredExpenses.length > 0) {
                 const expensesChartData = [{
                   values: filteredExpenses.map(item => item.value),
                   labels: filteredExpenses.map(item => item.label),
                   type: 'pie',
                   textinfo: 'percent', // Show percentage on slices
                   hoverinfo: 'label+value',
                   insidetextorientation: 'radial',
                   marker: { colors: ['#ce9e62', '#4b6777', '#c1432e', '#354f5f', '#6c757d', '#a65d57', '#2d5a27', '#842029', '#495057'] } // Use theme colors
                 }];
                 const expensesLayout = {
                     // title: 'Expenses Breakdown', // Title is in card
                     showlegend: true,
                     legend: { x: 0.5, y: -0.1, orientation: "h", xanchor: 'center' }, // Legend below chart
                     margin: { l: 20, r: 20, t: 30, b: 40 }, // Adjust margins
                     height: 300
                 };
                 Plotly.newPlot('expensesBreakdownChart', expensesChartData, expensesLayout, {responsive: true});
            } else if (document.getElementById('expensesBreakdownChart')) {
                 document.getElementById('expensesBreakdownChart').innerHTML = '<p class="text-center text-gray-500 italic">No expense data for chart.</p>';
            }

            // --- Debt Payments vs Income Pie Chart ---
             // Note: A pie chart isn't the best for DTI ratio, but keeping user's structure for now.
             const monthlyDebtPayment = input.debtsAndLiabilities?.totalMinimumMonthlyDebtPayments ?? 0;
             const monthlyIncome = calc.incomeSummary?.totalMonthlyIncome ?? 0;
             const remainingIncome = Math.max(0, monthlyIncome - monthlyDebtPayment);
             document.getElementById('dtiRatioValue').innerText = formatPercent(calc.ratios?.debtToIncomePercent);

             if (document.getElementById('debtIncomeChart') && monthlyIncome > 0) {
                 const debtIncomeChartData = [{
                   values: [monthlyDebtPayment, remainingIncome],
                   labels: ['Debt Payments', 'Remaining Income'],
                   type: 'pie',
                   textinfo: 'percent',
                   hoverinfo: 'label+value',
                   insidetextorientation: 'radial',
                   marker: { colors: ['#c1432e', '#4b6777'] } // rust, blue
                 }];
                 const debtIncomeLayout = {
                     // title: 'Debt Payments vs Income', // Title is in card
                     showlegend: true,
                     legend: { x: 0.5, y: -0.1, orientation: "h", xanchor: 'center' },
                     margin: { l: 20, r: 20, t: 30, b: 40 },
                     height: 270 // Reduced height to fit text above
                 };
                 Plotly.newPlot('debtIncomeChart', debtIncomeChartData, debtIncomeLayout, {responsive: true});
              } else if (document.getElementById('debtIncomeChart')) {
                  document.getElementById('debtIncomeChart').innerHTML = '<p class="text-center text-gray-500 italic">Income data needed for chart.</p>';
             }

            // --- Emergency Savings Ratio Pie Chart ---
             const emergencyMonths = calc.emergencyFundAnalysis?.emergencyFundMonths ?? 0;
             const goalMonths = 6; // Target goal
             const remainingToGoal = Math.max(0, goalMonths - emergencyMonths);
              document.getElementById('emergencyMonthsValue').innerText = formatMonths(emergencyMonths);


             if (document.getElementById('emergencySavingsChart')) {
                  const emergencySavingsData = [{
                      values: [emergencyMonths, remainingToGoal],
                      labels: ['Coverage (Months)', 'Remaining to Goal'],
                      type: 'pie',
                      textinfo: 'value', // Show months directly
                      hoverinfo: 'label+value',
                      texttemplate: '%{value:.1f} mo', // Format text on slice
                      insidetextorientation: 'radial',
                      marker: { colors: ['#ce9e62', '#e9ecef'] } // gold, silver
                  }];
                  const emergencySavingsLayout = {
                      // title: 'Emergency Savings Coverage', // Title is in card
                      showlegend: true,
                      legend: { x: 0.5, y: -0.1, orientation: "h", xanchor: 'center' },
                      margin: { l: 20, r: 20, t: 30, b: 40 },
                      height: 270 // Reduced height to fit text above
                  };
                  Plotly.newPlot('emergencySavingsChart', emergencySavingsData, emergencySavingsLayout, {responsive: true});
            }

        } catch (error) {
             console.error("Error rendering charts:", error);
             // Optionally display error message in chart areas
             document.getElementById('expensesBreakdownChart').innerHTML = '<p class="text-red-600">Error loading chart.</p>';
             document.getElementById('debtIncomeChart').innerHTML = '<p class="text-red-600">Error loading chart.</p>';
             document.getElementById('emergencySavingsChart').innerHTML = '<p class="text-red-600">Error loading chart.</p>';
        }
    }

    // Update Strengths, Weaknesses, and Recommendations Lists
    function updateAnalysis(data) {
       if (!data || !data.aiAnalysisAndRecommendations) return;

       const analysis = data.aiAnalysisAndRecommendations;

       const renderList = (elementId, title, items) => {
            const container = document.getElementById(elementId);
            if (!container) return;
            let listHtml = `<h4>${title}</h4>`;
            if (items && items.length > 0) {
                 listHtml += '<ul>' + items.map(item => `<li>${item?.text || item}</li>`).join('') + '</ul>'; // Handle object array for recommendations
            } else {
                 listHtml += '<p class="text-gray-500 italic">None provided.</p>';
            }
            container.innerHTML = listHtml;
       };

       renderList('strengthsList', 'Strengths', analysis.strengths);
       renderList('weaknessesList', 'Weaknesses', analysis.areasForImprovement);
       renderList('recommendationsList', 'Recommendations', analysis.recommendations);
    }

    // Initialize modals: when a card is clicked, show metric details
    function initModals(data) {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      const modalDetails = document.getElementById('modalDetails');
      const modalClose = document.getElementById('modalClose');

      if(!modal || !modalClose) return; // Ensure modal elements exist

      document.querySelectorAll('.card[data-metric], .chart-card[data-metric]').forEach(card => {
        card.addEventListener('click', (e) => {
          // Prevent triggering if click is on interactive element inside card (future proofing)
           if (e.target.closest('button, a')) return;

          const metric = card.getAttribute('data-metric');
          let title = "", content = "", detailsHtml = "";

          // Basic definitions - these could be enhanced or pulled from JSON data too
          switch(metric) {
            case 'income':
              title = "Income Details";
              content = "Total monthly and annual income reported.";
              if(data?.aiCalculations?.incomeSummary) {
                 detailsHtml = `
                     <p><strong>Monthly:</strong> ${formatCurrencyWithCents(data.aiCalculations.incomeSummary.totalMonthlyIncome)}</p>
                     <p><strong>Annual:</strong> ${formatCurrencyWithCents(data.aiCalculations.incomeSummary.totalAnnualIncome)}</p>
                     <p><em>(Based on calculated figures)</em></p>
                 `;
              }
              break;
             case 'expenses':
               title = "Expenses Details";
               content = "Total monthly and annual expenses calculated or reported.";
               if (data?.aiCalculations?.expenseSummary) {
                   detailsHtml = `
                     <p><strong>Monthly:</strong> ${formatCurrencyWithCents(data.aiCalculations.expenseSummary.totalMonthlyExpenses)}</p>
                     <p><strong>Annual:</strong> ${formatCurrencyWithCents(data.aiCalculations.expenseSummary.totalAnnualExpenses)}</p>
                     <p><em>(Based on calculated figures)</em></p>
                 `;
               }
               break;
             case 'savings':
               title = "Savings Details";
               content = "Total reported savings balance.";
                if (data?.aiCalculations?.savingsSummary) {
                   detailsHtml = `<p><strong>Total Balance:</strong> ${formatCurrencyWithCents(data.aiCalculations.savingsSummary.totalSavingsReported)}</p>`;
                }
               break;
             case 'debt':
               title = "Debt Details";
               content = "Total calculated or reported debt and minimum monthly payments.";
                if (data?.aiCalculations?.debtSummary || data?.userInput?.debtsAndLiabilities) {
                    detailsHtml = `
                     <p><strong>Total Debt:</strong> ${formatCurrencyWithCents(data.aiCalculations?.debtSummary?.totalDebtCalculated)}</p>
                     <p><strong>Min. Monthly Payments:</strong> ${formatCurrencyWithCents(data.userInput?.debtsAndLiabilities?.totalMinimumMonthlyDebtPayments)}</p>
                     `;
                }
               break;
             case 'networth':
               title = "Net Worth Details";
               content = "Calculated as total assets minus total liabilities.";
                if (data?.aiCalculations?.netWorth) {
                   detailsHtml = `
                     <p><strong>Calculated Value:</strong> ${formatCurrencyWithCents(data.aiCalculations.netWorth.calculatedNetWorth)}</p>
                     <p><strong>Status:</strong> ${data.aiCalculations.netWorth.netWorthStatus || 'N/A'}</p>
                     `;
               }
               break;
             case 'expensesChart':
               title = "Expenses Breakdown";
               content = "Distribution of monthly expenses across categories based on input.";
               // Could potentially list top categories here from data
               break;
             case 'debtIncomeChart':
               title = "Debt-to-Income (DTI) Ratio";
               content = "Percentage of gross monthly income used for minimum monthly debt payments.";
                if (data?.aiCalculations?.ratios) {
                     detailsHtml = `<p><strong>Calculated DTI:</strong> ${formatPercent(data.aiCalculations.ratios.debtToIncomePercent)}</p>`;
                     // Add assessment text here too if available
                     if(data.aiAnalysisAndRecommendations?.ratioAssessments?.dtiAssessmentLabel) {
                         detailsHtml += `<p><strong>Assessment:</strong> ${data.aiAnalysisAndRecommendations.ratioAssessments.dtiAssessmentLabel}</p>`;
                     }
                }
               break;
             case 'emergencySavingsChart':
               title = "Emergency Savings Coverage";
               content = "Number of months essential expenses can be covered by reported savings (goal typically 3-6 months).";
               if (data?.aiCalculations?.emergencyFundAnalysis) {
                   detailsHtml = `<p><strong>Calculated Coverage:</strong> ${formatMonths(data.aiCalculations.emergencyFundAnalysis.emergencyFundMonths)}</p>`;
                   // Add assessment text here too if available
                    if(data.aiAnalysisAndRecommendations?.ratioAssessments?.emergencyFundAssessmentLabel) {
                        detailsHtml += `<p><strong>Assessment:</strong> ${data.aiAnalysisAndRecommendations.ratioAssessments.emergencyFundAssessmentLabel}</p>`;
                    }
               }
               break;
              case 'analysis':
                 title = "Strengths & Weaknesses";
                 content = "Summary generated based on financial data.";
                 break;
              case 'recommendations':
                 title = "Personalized Recommendations";
                 content = "Actionable steps based on financial assessment.";
                 break;
            default:
              title = "Details";
              content = "Information relating to this section.";
          }
          modalTitle.innerText = title;
          modalContent.innerText = content;
          modalDetails.innerHTML = detailsHtml; // Add specific data to modal
          modal.style.display = 'flex';
        });
      });

      modalClose.addEventListener('click', () => { modal.style.display = 'none'; });
      window.addEventListener('click', (event) => { if (event.target === modal) { modal.style.display = 'none'; } });
    }

    // Initialize Save button to download the *fetched* JSON data locally
    function initSaveButton() {
      document.getElementById('saveButton').addEventListener('click', () => {
        // Use the globally stored fetchedReportData
        if (!fetchedReportData || Object.keys(fetchedReportData).length === 0) {
             alert("No report data available to save.");
             return;
        }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fetchedReportData, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        // Try to get username for filename, fallback to 'user'
        const filenameUser = fetchedReportData?.userInput?.personalInfo?.userName?.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'user';
        a.download = `financial_report_${filenameUser}_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    // Main initialization function: fetch data and update dashboard
    async function init() {
      const data = await fetchData();
      // Only proceed if data was successfully fetched
      if (data) {
          updateReport(data);
          renderCharts(data);
          updateAnalysis(data);
          initModals(data); // Pass data to modals if they need dynamic content
          initSaveButton(); // Initialize save button after data is available
      }
    }

    // Run init when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

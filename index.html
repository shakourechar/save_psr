<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    .header-font {
      font-family: 'EB Garamond', serif;
    }
    .dashboard-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }
  </style>
</head>
<body class="min-h-screen">
  <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>
  
  <!-- Loading spinner -->
  <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
    <div class="text-center">
      <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-700">Loading your financial dashboard...</p>
    </div>
  </div>
  
  <!-- Error Message -->
  <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white z-50">
    <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg max-w-lg">
      <h3 class="font-bold text-lg mb-2">Error Loading Dashboard</h3>
      <p id="errorText" class="mb-4">Unable to load financial data. Please try again later.</p>
      <div id="debugInfo" class="mb-4 max-h-40 overflow-auto bg-gray-100 p-2 rounded text-xs"></div>
      <div class="flex justify-center">
        <button id="retryButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded mr-2">
          Retry
        </button>
        <button id="manualEntryButton" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded">
          Use Demo Data
        </button>
      </div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="mainContent" class="container mx-auto px-4 py-8 max-w-7xl hidden">
    <!-- Dashboard Header -->
    <header class="mb-8">
      <h1 id="dashboard-title" class="header-font text-3xl md:text-4xl font-bold text-gray-800 mb-2">SmartWealth Navigator</h1>
      <p id="dashboard-subtitle" class="text-gray-600">Financial insights for <span id="userName">you</span></p>
    </header>

    <!-- Financial Overview -->
    <section class="mb-10">
      <h2 class="header-font text-2xl font-bold text-gray-800 mb-4">Financial Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Income Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Income</h3>
          <div class="flex justify-between items-center mb-4">
            <span class="stat-label">Total Income</span>
            <span id="totalIncome" class="stat-value text-green-600">$0</span>
          </div>
          <div id="incomeBreakdown" class="space-y-2">
            <!-- Income breakdown will be inserted here -->
          </div>
        </div>
        
        <!-- Expenses Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Expenses</h3>
          <div class="flex justify-between items-center mb-4">
            <span class="stat-label">Total Expenses</span>
            <span id="totalExpenses" class="stat-value text-red-600">$0</span>
          </div>
          <div id="expensesBreakdown" class="space-y-2">
            <!-- Expenses breakdown will be inserted here -->
          </div>
        </div>
        
        <!-- Cash Flow Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Cash Flow</h3>
          <div class="flex justify-between items-center mb-2">
            <span class="stat-label">Net Cash Flow</span>
            <span id="netCashFlow" class="stat-value">$0</span>
          </div>
          <div class="bg-gray-200 h-2 rounded-full mb-4">
            <div id="cashFlowProgress" class="h-2 rounded-full" style="width: 0%"></div>
          </div>
          <div class="text-sm text-gray-600">
            <div id="cashFlowMessage"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Simple version for demonstration -->
    <section class="mb-10">
      <h2 class="header-font text-2xl font-bold text-gray-800 mb-4">Financial Summary</h2>
      <div class="dashboard-card p-6">
        <div id="summaryContent" class="prose max-w-none">
          <!-- Summary content will be inserted here -->
        </div>
      </div>
    </section>
    
    <footer class="text-center text-gray-500 text-sm py-4">
      <p>SmartWealth Navigator Â© 2025 | Data updated: <span id="updateDate">Today</span></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set current date
      const today = new Date();
      document.getElementById('updateDate').textContent = today.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
      
      // Add event listeners for buttons
      document.getElementById('retryButton').addEventListener('click', function() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('loadingSpinner').classList.remove('hidden');
        setTimeout(initializeDashboard, 500); // Small timeout to show loading spinner
      });
      
      document.getElementById('manualEntryButton').addEventListener('click', function() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('loadingSpinner').classList.remove('hidden');
        useDemoData();
      });
      
      // Initialize dashboard with data
      initializeDashboard();
    });

    // Format currency values
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }
    
    // Debug function to check URL parameters
    function debugURLParameters() {
      const params = new URLSearchParams(window.location.search);
      let debugInfo = document.getElementById('debugInfo');
      let paramsText = '<strong>URL Parameters:</strong><br>';
      
      if (params.toString() === '') {
        paramsText += 'No URL parameters found!<br>';
      } else {
        paramsText += '<table style="width:100%; border-collapse: collapse;">';
        paramsText += '<tr><th style="text-align:left;border-bottom:1px solid #ddd;padding:2px">Parameter</th><th style="text-align:left;border-bottom:1px solid #ddd;padding:2px">Value</th></tr>';
        
        for (const [key, value] of params.entries()) {
          paramsText += `<tr><td style="border-bottom:1px solid #eee;padding:2px">${key}</td><td style="border-bottom:1px solid #eee;padding:2px">${value || '(empty)'}</td></tr>`;
        }
        paramsText += '</table>';
      }
      
      paramsText += '<br><strong>Browser Info:</strong><br>';
      paramsText += `User Agent: ${navigator.userAgent}<br>`;
      
      debugInfo.innerHTML = paramsText;
      return paramsText;
    }
    
    // Function to use demo data if actual data loading fails
    function useDemoData() {
      const demoData = {
        userInput: {
          personalInfo: {
            userName: "Demo User",
            age: 35
          },
          income: {
            mainJobIncome: 5000,
            secondJob: 1200,
            otherIncome: 300
          },
          savings: {
            emergency: 15000,
            savings: 25000,
            retirement: 120000
          },
          expenses: {
            housing: 1800,
            transportation: 500,
            utilities: 300,
            groceriesEssentials: 600,
            insurance: 400,
            medical: 200,
            care: 100,
            subscriptions: 150,
            taxes: 1200
          },
          debts: [
            {
              type: "Credit Card",
              balance: 4500,
              interestRate: 22.5,
              minPayment: 150
            },
            {
              type: "Bank Loans",
              balance: 15000,
              interestRate: 6.5,
              minPayment: 300
            }
          ]
        }
      };
      
      renderDashboard(demoData);
      console.log("Demo data loaded successfully");
    }
    
    // Function to log and handle errors
    function handleError(message, error) {
      console.error(message, error);
      const debugOutput = debugURLParameters();
      document.getElementById("errorText").innerText = `${message}: ${error.message || 'Unknown error'}`;
      document.getElementById("errorMessage").classList.remove("hidden");
      document.getElementById("loadingSpinner").classList.add("hidden");
      document.getElementById("mainContent").classList.add("hidden");
    }
    
    // Initialize dashboard data
    function initializeDashboard() {
      const params = new URLSearchParams(window.location.search);
      const dataElement = document.getElementById('embeddedPsrData');
      let dataLoaded = false;
      let dashboardData = {};

      try {
        // Check if we have any parameters at all
        if (params.toString() === '') {
          console.warn("No URL parameters found");
        }
        
        // Handle parameters case-insensitively and try multiple variations
        const getParam = (name) => {
          // Try different case variations and formats
          const variations = [
            name,
            name.toLowerCase(),
            name.toUpperCase(),
            name.replace(/([A-Z])/g, '-$1').toLowerCase(), // camelCase to kebab-case
            name.replace(/-([a-z])/g, (g) => g[1].toUpperCase()) // kebab-case to camelCase
          ];
          
          for (const variation of variations) {
            if (params.has(variation)) {
              return params.get(variation);
            }
          }
          return null;
        };
        
        // Try loading from URL parameters first - with more flexible parameter handling
        const userName = getParam('userName') || getParam('username') || getParam('user_name') || getParam('name');
        const mainJobIncome = getParam('mainJobIncome') || getParam('mainjobincome') || getParam('main-job-income') || getParam('income');
        
        // If we have any parameters, try to load data
        if (userName || mainJobIncome || params.toString() !== '') {
          console.log("Found some URL parameters, attempting to parse");
          
          // Helper function to safely parse numeric parameters
          const parseNumeric = (value) => {
            if (!value) return 0;
            // Remove any non-numeric characters except decimal point
            const cleaned = value.toString().replace(/[^0-9.]/g, '');
            return isNaN(Number(cleaned)) ? 0 : Number(cleaned);
          };
          
          dashboardData = {
            userInput: {
              personalInfo: {
                userName: userName || 'User',
                age: parseNumeric(getParam('age'))
              },
              income: {
                mainJobIncome: parseNumeric(mainJobIncome),
                secondJob: parseNumeric(getParam('secondJobIncome') || getParam('secondjob')),
                otherIncome: parseNumeric(getParam('otherIncome') || getParam('other'))
              },
              expenses: {
                housing: parseNumeric(getParam('housing')),
                transportation: parseNumeric(getParam('transportation')),
                utilities: parseNumeric(getParam('utilities')),
                groceriesEssentials: parseNumeric(getParam('groceries-essentials') || getParam('groceries')),
                insurance: parseNumeric(getParam('insurance')),
                medical: parseNumeric(getParam('medical')),
                care: parseNumeric(getParam('care')),
                subscriptions: parseNumeric(getParam('subscriptions')),
                taxes: parseNumeric(getParam('taxes'))
              },
              savings: {
                emergency: parseNumeric(getParam('emergencySavings') || getParam('emergency')),
                savings: parseNumeric(getParam('currentSavings') || getParam('savings')),
                retirement: parseNumeric(getParam('retirementFund') || getParam('retirement'))
              },
              debts: [
                {
                  type: "Credit Card",
                  balance: parseNumeric(getParam('creditCardDebt') || getParam('creditcard')),
                  interestRate: 22.5,
                  minPayment: 50
                },
                {
                  type: "Bank Loans",
                  balance: parseNumeric(getParam('bankLoans') || getParam('loans')),
                  interestRate: 6.5,
                  minPayment: 100
                }
              ]
            }
          };
          
          // Add AI output if available
          const analysis = getParam('aiAnalysis') || getParam('analysis');
          const recommendations = getParam('recommendations') || getParam('recs');
          const userProgress = getParam('userProgressHistory') || getParam('progress');
          
          if (analysis || recommendations || userProgress) {
            dashboardData.aiOutput = {
              analysis: analysis || '',
              recommendations: recommendations || '',
              userProgress: userProgress || ''
            };
          }
          
          // Consider data loaded if we have any income or user filled out at least some fields
          const hasIncome = dashboardData.userInput.income.mainJobIncome > 0 || 
                           dashboardData.userInput.income.secondJob > 0 || 
                           dashboardData.userInput.income.otherIncome > 0;
                           
          const hasExpenses = Object.values(dashboardData.userInput.expenses).some(value => value > 0);
          const hasSavings = Object.values(dashboardData.userInput.savings).some(value => value > 0);
          const hasDebts = dashboardData.userInput.debts.some(debt => debt.balance > 0);
          
          if (hasIncome || hasExpenses || hasSavings || hasDebts) {
            dataLoaded = true;
            console.log("Loaded data from URL parameters");
          } else {
            console.warn("URL parameters found but no financial data was present");
          }
        }
        
        // Try loading from embedded JSON if URL parameters aren't available or valid
        if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
          try {
            const embeddedData = JSON.parse(dataElement.textContent);
            dashboardData = embeddedData;
            dataLoaded = true;
            console.log("Embedded data loaded successfully");
          } catch (jsonErr) {
            console.error("Error parsing embedded JSON:", jsonErr);
          }
        }

        // As a fallback, if we at least have a name, show something
        if (!dataLoaded && userName) {
          dashboardData = {
            userInput: {
              personalInfo: {
                userName: userName,
                age: 30
              },
              income: { mainJobIncome: 0, secondJob: 0, otherIncome: 0 },
              expenses: { housing: 0, transportation: 0, utilities: 0 },
              savings: { emergency: 0, savings: 0, retirement: 0 },
              debts: []
            }
          };
          dataLoaded = true;
          console.log("Created minimal dashboard with just the user's name");
        }

        if (dataLoaded) {
          renderDashboard(dashboardData);
        } else {
          // Last resort - use demo data
          console.log("No valid data found, using demo data");
          useDemoData();
        }
      } catch (err) {
        handleError("Dashboard initialization error", err);
      }
    }
    
    // Render the dashboard with the loaded data
    function renderDashboard(data) {
      try {
        // Set user name
        const userName = data.userInput.personalInfo.userName || 'User';
        document.getElementById('userName').textContent = userName;
        
        // Calculate total income
        const income = data.userInput.income || {};
        const totalIncome = (income.mainJobIncome || 0) + (income.secondJob || 0) + (income.otherIncome || 0);
        document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
        
        // Render income breakdown
        const incomeBreakdownElement = document.getElementById('incomeBreakdown');
        incomeBreakdownElement.innerHTML = '';
        
        if (income.mainJobIncome > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Main Job</span>
              <span class="font-medium">${formatCurrency(income.mainJobIncome)}</span>
            </div>
          `;
        }
        
        if (income.secondJob > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Second Job</span>
              <span class="font-medium">${formatCurrency(income.secondJob)}</span>
            </div>
          `;
        }
        
        if (income.otherIncome > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Other Income</span>
              <span class="font-medium">${formatCurrency(income.otherIncome)}</span>
            </div>
          `;
        }
        
        if (totalIncome === 0) {
          incomeBreakdownElement.innerHTML = '<p class="text-yellow-600">No income data available</p>';
        }
        
        // Calculate total expenses
        const expenses = data.userInput.expenses || {};
        const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + (val || 0), 0);
        document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        
        // Render expenses breakdown
        const expensesBreakdownElement = document.getElementById('expensesBreakdown');
        expensesBreakdownElement.innerHTML = '';
        
        // Add expense items if they exist
        if (expenses.housing > 0) {
          expensesBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Housing</span>
              <span class="font-medium">${formatCurrency(expenses.housing)}</span>
            </div>
          `;
        }
        
        if (expenses.transportation > 0) {
          expensesBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Transportation</span>
              <span class="font-medium">${formatCurrency(expenses.transportation)}</span>
            </div>
          `;
        }
        
        if (expenses.utilities > 0) {
          expensesBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Utilities</span>
              <span class="font-medium">${formatCurrency(expenses.utilities)}</span>
            </div>
          `;
        }
        
        if (totalExpenses === 0) {
          expensesBreakdownElement.innerHTML = '<p class="text-yellow-600">No expense data available</p>';
        }
        
        // Calculate and display net cash flow
        const netCashFlow = totalIncome - totalExpenses;
        const netCashFlowElement = document.getElementById('netCashFlow');
        const cashFlowProgressElement = document.getElementById('cashFlowProgress');
        const cashFlowMessageElement = document.getElementById('cashFlowMessage');
        
        netCashFlowElement.textContent = formatCurrency(netCashFlow);
        
        if (netCashFlow > 0) {
          netCashFlowElement.classList.add('text-green-600');
          cashFlowProgressElement.classList.add('bg-green-500');
          cashFlowMessageElement.textContent = "Positive cash flow! You're earning more than you spend.";
          cashFlowMessageElement.classList.add('text-green-600');
          
          // Calculate percentage of income saved
          if (totalIncome > 0) {
            const savingsRate = (netCashFlow / totalIncome) * 100;
            cashFlowProgressElement.style.width = `${Math.min(savingsRate, 100)}%`;
          }
        } else if (netCashFlow < 0) {
          netCashFlowElement.classList.add('text-red-600');
          cashFlowProgressElement.classList.add('bg-red-500');
          cashFlowMessageElement.textContent = "Negative cash flow. You're spending more than you earn.";
          cashFlowMessageElement.classList.add('text-red-600');
          
          // Show deficit percentage
          if (totalIncome > 0) {
            const deficitRate = Math.min((Math.abs(netCashFlow) / totalIncome) * 100, 100);
            cashFlowProgressElement.style.width = `${deficitRate}%`;
          } else {
            cashFlowProgressElement.style.width = '100%';
          }
        } else {
          cashFlowMessageElement.textContent = "Your income and expenses are balanced.";
          cashFlowMessageElement.classList.add('text-blue-600');
        }
        
        // Generate a basic financial summary
        const savings = data.userInput.savings || {};
        const totalSavings = (savings.emergency || 0) + (savings.savings || 0) + (savings.retirement || 0);
        
        const debts = data.userInput.debts || [];
        const totalDebt = debts.reduce((sum, debt) => sum + (debt.balance || 0), 0);
        
        let summaryHTML = `
          <h3 class="text-lg font-semibold mb-3">Financial Summary for ${userName}</h3>
          <div class="space-y-4">
            <p>Here's an overview of your financial situation:</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 class="font-semibold mb-2">Income & Expenses</h4>
                <ul class="list-disc pl-5 space-y-1">
                  <li>Monthly Income: ${formatCurrency(totalIncome)}</li>
                  <li>Monthly Expenses: ${formatCurrency(totalExpenses)}</li>
                  <li>Net Cash Flow: ${formatCurrency(netCashFlow)}</li>
                </ul>
              </div>
              
              <div>
                <h4 class="font-semibold mb-2">Assets & Liabilities</h4>
                <ul class="list-disc pl-5 space-y-1">
                  <li>Total Savings: ${formatCurrency(totalSavings)}</li>
                  <li>Total Debt: ${formatCurrency(totalDebt)}</li>
                  <li>Net Worth: ${formatCurrency(totalSavings - totalDebt)}</li>
                </ul>
              </div>
            </div>
        `;
        
        // Add recommendations based on the data
        summaryHTML += `
          <div class="mt-4">
            <h4 class="font-semibold mb-2">Recommendations</h4>
            <ul class="list-disc pl-5 space-y-1">
        `;
        
        // Cash flow recommendations
        if (netCashFlow < 0) {
          summaryHTML += `<li class="text-red-600">Your expenses exceed your income. Focus on reducing expenses or increasing income to achieve a positive cash flow.</li>`;
        } else if (netCashFlow > 0 && (netCashFlow / totalIncome) < 0.2 && totalIncome > 0) {
          summaryHTML += `<li class="text-yellow-600">You have a positive cash flow, but consider increasing your savings rate to at least 20% of your income.</li>`;
        } else if (netCashFlow > 0) {
          summaryHTML += `<li class="text-green-600">Excellent cash flow! Consider allocating more to retirement or investment accounts.</li>`;
        }
        
        // Emergency fund recommendations
        const emergencySavings = savings.emergency || 0;
        const monthlyExpenses = totalExpenses;
        
        if (monthlyExpenses > 0) {
          const monthsCovered = emergencySavings / monthlyExpenses;
          if (monthsCovered < 3) {
            summaryHTML += `<li class="text-yellow-600">Your emergency fund covers approximately ${monthsCovered.toFixed(1)} months of expenses. Work toward a goal of 3-6 months.</li>`;
          } else if (monthsCovered >= 6) {
            summaryHTML += `<li class="text-green-600">Great job! Your emergency fund covers ${monthsCovered.toFixed(1)} months of expenses.</li>`;
          }
        }
        
        // Debt recommendations
        if (totalDebt > 0) {
          const highInterestDebt = debts.find(debt => (debt.interestRate || 0) > 10 && (debt.balance || 0) > 0);
          if (highInterestDebt) {
            summaryHTML += `<li class="text-red-600">Prioritize paying down your high-interest ${highInterestDebt.type} debt (${highInterestDebt.interestRate}% interest rate).</li>`;
          }
        } else {
          summaryHTML += `<li class="text-green-600">You're debt-free! Focus on building savings and investments.</li>`;
        }
        
        summaryHTML += `
            </ul>
          </div>
        </div>
        `;
        
        document.getElementById('summaryContent').innerHTML = summaryHTML;
        
        // Hide loading spinner and show content
        document.getElementById('loadingSpinner').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        console.log("Dashboard rendered successfully");
        
      } catch (err) {
        handleError("Error rendering dashboard", err);
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartWealth Navigator - Financial Health Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5; /* Light gray background */
      margin: 0;
      padding: 0;
    }
    h1, h2, h3, h4 {
      font-family: 'EB Garamond', serif;
      color: #333; /* Darker text color */
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #ffffff; /* White background for container */
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    header img {
      height: 60px; /* Adjust logo height */
      margin-right: 15px;
    }
    header h1 {
      color: #2E7D32; /* Primary brand color */
      margin: 0;
      flex-grow: 1; /* Allow title to take available space */
    }
    #saveButton, #uploadButton {
       margin-left: 10px; /* Spacing between buttons */
       padding: 8px 16px;
       background-color: #4CAF50; /* Green background */
       color: white;
       border: none;
       border-radius: 4px;
       cursor: pointer;
       font-size: 0.9em;
       transition: background-color 0.3s ease;
     }
     #uploadButton {
         background-color: #0288D1; /* Blue background for upload */
     }
     #saveButton:hover {
       background-color: #388E3C; /* Darker green on hover */
     }
     #uploadButton:hover {
         background-color: #0277BD; /* Darker blue on hover */
     }
     /* Hide the actual file input */
     #fileInput {
         display: none;
     }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
      color: #4CAF50; /* Green headings for cards */
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* Darker overlay */
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 8px;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    #loadingMessage, #errorMessage {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #555;
    }
     #errorMessage {
         color: #D32F2F; /* Red color for errors */
         display: none; /* Hidden by default */
     }
     #initialMessage {
         text-align: center;
         padding: 20px;
         font-size: 1.1em;
         color: #333;
         display: none; /* Hidden by default */
     }
     #mainContent {
         display: none; /* Hidden until data loads */
     }
    /* Responsive adjustments */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header h1 {
          margin-top: 10px;
      }
      #saveButton, #uploadButton {
          margin-left: 0; /* Align left on small screens */
          margin-top: 10px;
      }
      .grid-container {
         grid-template-columns: 1fr; /* Stack cards vertically */
      }
    }
  </style>
</head>
<body>

  <script id="embeddedPsrData" type="application/json">
    /* MAKE_COM_JSON_PLACEHOLDER */
  </script>

  <div class="container">
    <header>
      <h1>Financial Health Dashboard</h1>
      <input type="file" id="fileInput" accept=".json" style="display: none;">
      <button id="uploadButton">Upload PSR File</button>
      <button id="saveButton">Save Full Report Data (JSON)</button>
    </header>

    <div id="loadingMessage" style="display: none;">Loading your financial report...</div>
    <div id="errorMessage"></div>
    <div id="initialMessage">Upload a PSR JSON file or generate a new report to view your dashboard.</div>

    <div id="mainContent">
      <div class="grid-container">
        <div class="card">
          <h3>Quick Summary</h3>
          <p><strong>User:</strong> <span id="userName">N/A</span></p>
          <p><strong>Age:</strong> <span id="age">N/A</span></p>
          <p><strong>Total Monthly Income:</strong> <span id="totalIncome">N/A</span></p>
          <p><strong>Total Monthly Expenses:</strong> <span id="totalExpenses">N/A</span></p>
          <p><strong>Monthly Net Flow:</strong> <span id="netFlow">N/A</span></p>
        </div>
        <div class="card">
          <h3>Savings Overview</h3>
          <p><strong>Emergency Savings:</strong> <span id="emergencySavings">N/A</span></p>
          <p><strong>Current General Savings:</strong> <span id="currentSavings">N/A</span></p>
          <p><strong>Retirement Fund:</strong> <span id="retirementFund">N/A</span></p>
        </div>
      </div>

      <div class="grid-container">
        <div class="card">
          <h3>Income Breakdown</h3>
          <div id="incomeChart" style="width:100%;height:300px;"></div>
        </div>
        <div class="card">
          <h3>Expense Breakdown</h3>
          <div id="expenseChart" style="width:100%;height:300px;"></div>
        </div>
      </div>

       <div class="card" style="margin-bottom: 20px;">
            <h3>Financial Tools & Challenges</h3>
            <p><strong>Current Financial Tools:</strong> <span id="financialTools">N/A</span></p>
            <p><strong>Reported Challenges:</strong> <span id="challenges">N/A</span></p>
            <p><strong>Upcoming Purchase Goals:</strong> <span id="purchaseGoals">N/A</span></p>
       </div>

      <div class="card">
        <h3>AI Analysis & Recommendations</h3>
        <div id="aiAnalysis" style="white-space: pre-wrap; margin-bottom: 15px;">N/A</div>
        <button onclick="openModal('recommendationsModal')" class="text-blue-600 hover:underline">View Recommendations</button>
        <button onclick="openModal('progressModal')" class="text-blue-600 hover:underline ml-4">View Progress History</button>
      </div>
     </div> </div><div id="recommendationsModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('recommendationsModal')">&times;</span>
      <h2>Recommendations</h2>
      <div id="recommendationsContent" style="white-space: pre-wrap;"></div>
    </div>
  </div>

  <div id="progressModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('progressModal')">&times;</span>
      <h2>User Progress History</h2>
      <div id="progressContent" style="white-space: pre-wrap;"></div>
    </div>
  </div>

  <script>
    // Global variable to store fetched/uploaded data
    let fetchedReportData = {};
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const mainContent = document.getElementById('mainContent');
    const initialMessage = document.getElementById('initialMessage');

    // Function to safely get nested properties
    function getSafe(fn, defaultVal) {
      try {
        const value = fn();
        return (value === null || value === undefined) ? defaultVal : value;
      } catch (e) {
        return defaultVal;
      }
    }

    // Function to format numbers as currency
    function formatCurrency(value) {
      const number = Number(value);
      if (isNaN(number)) return 'N/A';
      return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    // Function to update the text content of elements
    function updateElementText(id, value, formatter) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = formatter ? formatter(value) : (value || 'N/A');
      } else {
          console.warn(`Element with ID ${id} not found.`);
      }
    }

    // Function to calculate totals
    function calculateTotals(data) {
        const income = data?.userInput?.income || {};
        const expenses = data?.userInput?.expenses || {};
        const totalIncome = (Number(getSafe(() => income.mainJobIncome, 0)) + Number(getSafe(() => income.secondJob, 0)) + Number(getSafe(() => income.otherIncome, 0)));
        const totalExpenses = (
            Number(getSafe(() => expenses.housing, 0)) + Number(getSafe(() => expenses.utilities, 0)) +
            Number(getSafe(() => expenses.transportation, 0)) + Number(getSafe(() => expenses.groceriesEssentials, 0)) +
            Number(getSafe(() => expenses.insurance, 0)) + Number(getSafe(() => expenses.medical, 0)) +
            Number(getSafe(() => expenses.care, 0)) + Number(getSafe(() => expenses.subscriptions, 0)) +
            Number(getSafe(() => expenses.taxes, 0))
        );
        const netFlow = totalIncome - totalExpenses;
        return { totalIncome, totalExpenses, netFlow };
    }


    // Function to update the main report sections
    function updateReport(data) {
        const personalInfo = data?.userInput?.personalInfo || {};
        const savings = data?.userInput?.savings || {};
        const financials = data?.userInput?.financials || {};
        const totals = calculateTotals(data);

        updateElementText('userName', personalInfo.userName);
        updateElementText('age', personalInfo.age);
        updateElementText('totalIncome', totals.totalIncome, formatCurrency);
        updateElementText('totalExpenses', totals.totalExpenses, formatCurrency);
        updateElementText('netFlow', totals.netFlow, formatCurrency);
        updateElementText('emergencySavings', savings.emergency, formatCurrency);
        updateElementText('currentSavings', savings.savings, formatCurrency);
        updateElementText('retirementFund', savings.retirement, formatCurrency);
        updateElementText('financialTools', financials.financialTools);
        updateElementText('challenges', financials.challenges);
        updateElementText('purchaseGoals', financials.upcomingPurchase);
        updateElementText('aiAnalysis', data?.aiOutput?.analysis);
    }

    // Function to render Plotly charts
    function renderCharts(data) {
        try {
            const income = data?.userInput?.income || {};
            const expenses = data?.userInput?.expenses || {};

            // Income Chart
            const incomeValues = [
                getSafe(() => Number(income.mainJobIncome), 0),
                getSafe(() => Number(income.secondJob), 0),
                getSafe(() => Number(income.otherIncome), 0)
            ];
            const incomeLabels = ['Main Job', 'Second Job', 'Other'];
            const incomeChartData = [{ values: incomeValues, labels: incomeLabels, type: 'pie', hole: .4, hoverinfo: 'label+percent+value', textinfo: 'none', marker: { colors: ['#4CAF50', '#8BC34A', '#CDDC39'] } }];
            const incomeLayout = { title: 'Income Sources', showlegend: true, height: 300, margin: { l: 20, r: 20, t: 40, b: 20 } };
            Plotly.newPlot('incomeChart', incomeChartData, incomeLayout, {responsive: true});

            // Expense Chart
            const expenseValues = [
                getSafe(() => Number(expenses.housing), 0), getSafe(() => Number(expenses.utilities), 0),
                getSafe(() => Number(expenses.transportation), 0), getSafe(() => Number(expenses.groceriesEssentials), 0),
                getSafe(() => Number(expenses.insurance), 0), getSafe(() => Number(expenses.medical), 0),
                getSafe(() => Number(expenses.care), 0), getSafe(() => Number(expenses.subscriptions), 0),
                getSafe(() => Number(expenses.taxes), 0)
            ];
            const expenseLabels = ['Housing', 'Utilities', 'Transportation', 'Groceries/Essentials', 'Insurance', 'Medical', 'Care', 'Subscriptions', 'Taxes'];
            const expenseChartData = [{ values: expenseValues, labels: expenseLabels, type: 'pie', hole: .4, hoverinfo: 'label+percent+value', textinfo: 'none', marker: { colors: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688'] } }];
            const expenseLayout = { title: 'Expense Categories', showlegend: true, height: 300, margin: { l: 20, r: 20, t: 40, b: 20 } };
            Plotly.newPlot('expenseChart', expenseChartData, expenseLayout, {responsive: true});
        } catch (chartError) {
            console.error("Error rendering charts:", chartError);
            errorMessage.textContent = `Error displaying charts: ${chartError.message}. Please check the data format.`;
            errorMessage.style.display = 'block';
        }
    }

    // Function to update AI Analysis and potentially other text areas
    function updateAnalysis(data) {
        const aiOutput = data?.aiOutput || {};
        updateElementText('aiAnalysis', aiOutput.analysis);
        // Update modal content here too
        updateElementText('recommendationsContent', aiOutput.recommendations);
        updateElementText('progressContent', aiOutput.userProgress);
    }


    // Functions to handle modals
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "block";
    }

    function closeModal(modalId) {
       const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "none";
    }

    // Function to initialize modal content (called after data is loaded)
    function initModals(data) {
        const aiOutput = data?.aiOutput || {};
        updateElementText('recommendationsContent', aiOutput.recommendations);
        updateElementText('progressContent', aiOutput.userProgress);

      // Close modal if clicked outside the content area
      window.onclick = function(event) {
        const modals = document.getElementsByClassName('modal');
        for (let i = 0; i < modals.length; i++) {
             if (event.target == modals[i]) {
               modals[i].style.display = "none";
             }
        }
      }
    }

    // Function to initialize the Save JSON button
    function initSaveButton() {
      const saveButton = document.getElementById('saveButton');
      if (!saveButton) {
          console.error("Save button not found.");
          return;
      }
      saveButton.addEventListener('click', () => {
        if (!fetchedReportData || Object.keys(fetchedReportData).length === 0) {
             alert("No report data available to save.");
             return;
        }
        try {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fetchedReportData, null, 2));
            const a = document.createElement('a');
            a.href = dataStr;
            const filenameUser = getSafe(() => fetchedReportData.userInput.personalInfo.userName.replace(/[^a-z0-9]/gi, '_').toLowerCase(), 'user');
            a.download = `financial_report_${filenameUser}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (saveError) {
             console.error("Error creating save data:", saveError);
             alert(`Error saving file: ${saveError.message}`);
        }
      });
    }

    // Function to handle file upload
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) {
            return; // No file selected
        }

        // Show loading message, hide errors/initial message
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        initialMessage.style.display = 'none';
        mainContent.style.display = 'none'; // Hide content while loading new file

        const reader = new FileReader();

        reader.onload = function(e) {
            let uploadedData = null;
            try {
                uploadedData = JSON.parse(e.target.result);
                // Basic validation: Check if it looks like our structure (optional but good)
                if (!uploadedData.userInput || !uploadedData.aiOutput) {
                   throw new Error("File does not seem to be a valid PSR JSON report.");
                }

                fetchedReportData = uploadedData; // Update global data

                // Update dashboard with new data
                updateReport(fetchedReportData);
                renderCharts(fetchedReportData);
                updateAnalysis(fetchedReportData);
                initModals(fetchedReportData); // Re-init modals with new data

                // Show content, hide loading
                loadingMessage.style.display = 'none';
                mainContent.style.display = 'block';
                errorMessage.style.display = 'none'; // Ensure error is hidden on success

            } catch (error) {
                console.error("Error parsing uploaded JSON or invalid format:", error);
                errorMessage.textContent = `Error loading file: ${error.message}. Please ensure it's a valid PSR JSON file.`;
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                mainContent.style.display = 'none'; // Keep content hidden on error
                initialMessage.style.display = 'block'; // Show initial message again
                fetchedReportData = {}; // Clear data on error
            } finally {
                 // Reset the file input value to allow uploading the same file again if needed
                 event.target.value = null;
            }
        };

        reader.onerror = function(e) {
            console.error("FileReader error:", e);
            errorMessage.textContent = `Error reading file: ${e.target.error}`;
            errorMessage.style.display = 'block';
            loadingMessage.style.display = 'none';
            mainContent.style.display = 'none';
             initialMessage.style.display = 'block';
             fetchedReportData = {}; // Clear data on error
        };

        reader.readAsText(file); // Read the file as text
    }

     // Function to initialize the Upload button and file input
     function initUploadButton() {
         const uploadButton = document.getElementById('uploadButton');
         const fileInput = document.getElementById('fileInput');

         if (!uploadButton || !fileInput) {
             console.error("Upload button or file input not found.");
             return;
         }

         uploadButton.addEventListener('click', () => {
             fileInput.click(); // Trigger the hidden file input
         });

         fileInput.addEventListener('change', handleFileUpload);
     }


    // Main initialization function
    function init() {
      let data = null;
      const dataElement = document.getElementById('embeddedPsrData');

      // Clear previous error messages on init
      errorMessage.textContent = '';
      errorMessage.style.display = 'none';

      // Try to load embedded data first
      try {
        if (dataElement && dataElement.textContent.trim() && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
           data = JSON.parse(dataElement.textContent);
           fetchedReportData = data; // Store globally
        }
      } catch (error) {
         console.error("Error parsing embedded JSON on initial load:", error);
         errorMessage.textContent = `Failed to parse initially embedded report data: ${error.message}`;
         errorMessage.style.display = 'block';
         // Don't return, allow page structure and buttons to load
      }

      // Hide loading message initially
      loadingMessage.style.display = 'none';

      // Initialize buttons regardless of initial data
      initSaveButton();
      initUploadButton();
      initModals({}); // Init modals structure, content updated later if data loads

      // If data was loaded successfully from embedding, update the dashboard
      if (data) {
          mainContent.style.display = 'block'; // Show main content area
          initialMessage.style.display = 'none'; // Hide initial message
          updateReport(data);
          renderCharts(data);
          updateAnalysis(data);
          initModals(data); // Re-init modals with actual data
      } else {
           // No embedded data or error parsing it, show initial message
           mainContent.style.display = 'none'; // Keep content hidden
           initialMessage.style.display = 'block';
      }
    }

    // Run init when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

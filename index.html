<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <style>
        :root { /* ... CSS Variables ... */ }
        body { /* ... */ }
        .header-font { /* ... */ }
        .main-container { /* ... */ }
        .dashboard-card { /* ... */ }
        .stat-value { /* ... */ }
        .stat-label { /* ... */ }
        .card-header { /* ... */ }
        .breakdown-list div { /* ... */ }
        /* ... Other base styles ... */
        footer { /* ... */ }
        #debugInfo table { /* ... */ }
        /* --- Modern Chat Widget Styles --- */
        #chatInterfaceCard { /* ... */ }
        .chat-container { /* ... */ }
        /* ... other chat styles ... */
        .typing-indicator span { /* ... */ }
        @keyframes typing { /* ... */ }

        /* Ensure chart divs have minimum height */
        .chart-container-div {
            min-height: 380px; /* Adjust as needed */
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen">
    <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>

    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
        </div>

    <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-95 z-50 p-4">
        </div>

    <div id="mainContent" class="main-container hidden">
        <header class="mb-10 border-b border-gray-200 pb-6">
            </header>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Key Financial Metrics</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Monthly Net Cash Flow</h3><div class="text-center mt-2"><span id="netCashFlow" class="stat-value block mb-2">$0</span><div class="bg-gray-200 h-2.5 rounded-full mb-3"><div id="cashFlowProgress" class="h-2.5 rounded-full" style="width: 0%"></div></div><p id="cashFlowMessage" class="text-xs text-gray-500 h-8"></p></div></div>
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Savings Rate</h3><div class="text-center mt-2"><span id="savingsRate" class="stat-value block mb-2">0%</span><p class="text-xs text-gray-500 mt-3">(Net Cash Flow / Total Income)</p></div></div>
                  <div class="dashboard-card p-5"><h3 class="card-header text-base">Estimated Net Worth</h3><div class="text-center mt-2"><span id="netWorth" class="stat-value block mb-2">$0</span><p class="text-xs text-gray-500 mt-3">(Total Savings - Total Debt)</p></div></div>
                  <div class="dashboard-card p-5"><h3 class="card-header text-base">Emergency Fund</h3><div class="text-center mt-2"><span id="emergencyFundCoverage" class="stat-value block mb-2">0 months</span><p class="text-xs text-gray-500 mt-3">(Vs. Monthly Expenses)</p></div></div>
                  <div class="dashboard-card p-5"><h3 class="card-header text-base">Debt-to-Income (DTI)</h3><div class="text-center mt-2"><span id="dtiRatio" class="stat-value block mb-2">0%</span><p class="text-xs text-gray-500 mt-3">(Total Debt Payments / Gross Income)</p></div></div>
             </div>
        </section>

        <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Income & Expenses Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="dashboard-card"><h3 class="card-header">Monthly Income Breakdown</h3><div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200"><span class="stat-label font-semibold">Total Income</span><span id="totalIncome" class="stat-value text-green-600">$0</span></div><div id="incomeBreakdown" class="space-y-2 breakdown-list"><p class="text-gray-500 text-sm">Loading...</p></div></div>
                <div class="dashboard-card"><h3 class="card-header">Monthly Expenses Breakdown</h3><div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200"><span class="stat-label font-semibold">Total Expenses</span><span id="totalExpenses" class="stat-value text-red-600">$0</span></div><div id="expensesBreakdown" class="space-y-1 breakdown-list max-h-60 overflow-y-auto pr-2"><p class="text-gray-500 text-sm">Loading...</p></div></div>
            </div>
        </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Visualizations</h2>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="dashboard-card">
                    <h3 class="card-header">Expense Categories</h3>
                    <div id="expenseBreakdownChart" class="chart-container-div"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div>
                 </div>
                 <div class="dashboard-card">
                    <h3 class="card-header">Assets vs. Liabilities</h3>
                    <div id="savingsDebtChart" class="chart-container-div"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div>
                 </div>
                 </div>
         </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">AI Insights & Recommendations</h2>
              <div class="dashboard-card">
                 <div id="summaryContent" class="prose max-w-none prose-indigo"><p class="text-gray-500">Generating summary...</p></div>
                  <div id="aiAnalysisSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Analysis</h3><p id="aiAnalysisContent"></p></div>
                  <div id="aiRecommendationsSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Recommendations</h3><p id="aiRecommendationsContent"></p></div>
                  <div id="aiProgressSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">User Progress History</h3><p id="aiProgressContent"></p></div>
             </div>
        </section>

        <section id="chatInterfaceCard" class="dashboard-card">
            </section>

        <footer class="text-center text-gray-500 text-sm py-6">
             </footer>
    </div>

    <script>
        // --- Global Variables ---
        let dashboardData = null;
        let chatMessages = [];
        const CHAT_MODEL = 'gpt-4o-mini';

        // --- Supabase Client (CONFIGURE THESE) ---
        const SUPABASE_URL = 'https://tfnwwpksieluzvxqdiiq.supabase.co'; // <-- REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbnd3cGtzaWVsdXp2eHFkaWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1ODQ3MjgsImV4cCI6MjA2MDE2MDcyOH0.xbtjiQ65vCggjj35qtlCZ0S5mJa4muSZcHXhaU4qvrE'; // <-- REPLACE
        let supabase = null;

        // --- Utility Functions ---
        function formatCurrency(value) { /* ... unchanged ... */ }
        function formatPercentage(value) { /* ... unchanged ... */ }

        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded.");
            try {
                 // ** Initialize Supabase Client **
                 if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') { throw new Error("Supabase URL missing."); }
                 if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') { throw new Error("Supabase Anon Key missing."); }
                 if (typeof window.supabase === 'undefined' || !window.supabase || typeof window.supabase.createClient !== 'function') { throw new Error("Supabase library failed to load."); }
                 const { createClient } = window.supabase;
                 supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 console.log("Supabase client initialized successfully.");

                 // ** Setup Other Listeners and Initialize Dashboard **
                 const today = new Date(); /* ... set date ... */
                 document.getElementById('retryButton')?.addEventListener('click', /* ... */);
                 document.getElementById('manualEntryButton')?.addEventListener('click', useDemoData);
                 initializeDashboard(); // Start data loading

            } catch (error) {
                 console.error("Critical Error during initial setup:", error);
                 handleError("Failed during initial page setup", error);
                 document.getElementById('loadingSpinner')?.classList.add('hidden');
            }
        }); // End DOMContentLoaded Listener

        // --- Debugging & Error Handling ---
        function debugURLParameters() { /* ... unchanged ... */ }
        function handleError(message, error) { /* ... unchanged ... */ }

        // --- Demo Data ---
        function useDemoData() { /* ... unchanged ... calls renderDashboard ... */ }

        // --- Initialize Dashboard Data Logic ---
        function initializeDashboard() {
            console.log("--- initializeDashboard START (Data Processing Only) ---");
            // ... (Parameter parsing logic using getParam, parseNumeric - unchanged) ...
             const params = new URLSearchParams(window.location.search);
             const dataElement = document.getElementById('embeddedPsrData');
             let dataLoaded = false;
             let rawData = {};

             try {
                const getParam=(k)=>{/*...*/}; const parseNumeric=(k,v,d=0)=>{/*...*/};
                if (params.toString().length > 0) {
                    // Fetch ALL params into variables...
                    const fetchedUserName=getParam('userName')||getParam('username'); const fetchedAge=parseNumeric('age',getParam('age')); const fetchedMainJobIncome=parseNumeric('mainJobIncome',getParam('mainJobIncome')); const fetchedSecondJobIncome=parseNumeric('secondJobIncome',getParam('secondJobIncome')||getParam('secondJob')); const fetchedOtherIncome=parseNumeric('otherIncome',getParam('otherIncome')); const fetchedHousing=parseNumeric('housing',getParam('housing')); const fetchedTransportation=parseNumeric('transportation',getParam('transportation')); const fetchedUtilities=parseNumeric('utilities',getParam('utilities')); const fetchedGroceries=parseNumeric('groceries-essentials',getParam('groceries-essentials')||getParam('groceries')); const fetchedInsurance=parseNumeric('insurance',getParam('insurance')); const fetchedMedical=parseNumeric('medical',getParam('medical')); const fetchedCare=parseNumeric('care',getParam('care')); const fetchedSubscriptions=parseNumeric('subscriptions',getParam('subscriptions')); const fetchedTaxes=parseNumeric('taxes',getParam('taxes')); const fetchedEmergencySavings=parseNumeric('emergencySavings',getParam('emergencySavings')||getParam('emergency')); const fetchedCurrentSavings=parseNumeric('currentSavings',getParam('currentSavings')||getParam('savings')); const fetchedRetirementFund=parseNumeric('retirementFund',getParam('retirementFund')||getParam('retirement')); const fetchedCreditCardDebt=parseNumeric('creditCardDebt',getParam('creditCardDebt')||getParam('creditcard')); const fetchedBankLoans=parseNumeric('bankLoans',getParam('bankLoans')||getParam('loans'));
                    const decodeAIField=(f)=>{/*...*/}; const fetchedAnalysis=decodeAIField('aiAnalysis'); const fetchedRecommendations=decodeAIField('recommendations'); const fetchedProgress=decodeAIField('userProgressHistory')||decodeAIField('userProgress');

                    // ** Assume placeholder debt payments for DTI calculation **
                    // TODO: Get real min payments if available from form/URL
                    const ccMinPayment = fetchedCreditCardDebt * 0.03 > 50 ? fetchedCreditCardDebt * 0.03 : 50; // Example: 3% or $50
                    const loanMinPayment = fetchedBankLoans * 0.015 > 100 ? fetchedBankLoans * 0.015 : 100; // Example: 1.5% or $100

                    rawData = {
                         userInput: {
                             personalInfo: { userName: fetchedUserName||'User', age: fetchedAge||30 },
                             income: { mainJobIncome: fetchedMainJobIncome, secondJob: fetchedSecondJobIncome, otherIncome: fetchedOtherIncome },
                             expenses: { housing: fetchedHousing, transportation: fetchedTransportation, utilities: fetchedUtilities, groceriesEssentials: fetchedGroceries, insurance: fetchedInsurance, medical: fetchedMedical, care: fetchedCare, subscriptions: fetchedSubscriptions, taxes: fetchedTaxes },
                             savings: { emergency: fetchedEmergencySavings, savings: fetchedCurrentSavings, retirement: fetchedRetirementFund },
                             debts: [
                                 // Including estimated min payments
                                 { type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: 22.5, minPayment: ccMinPayment },
                                 { type: "Bank Loans", balance: fetchedBankLoans, interestRate: 6.5, minPayment: loanMinPayment }
                                 // TODO: Add other debt types if collected
                             ]
                         },
                         aiOutput: { analysis: fetchedAnalysis, recommendations: fetchedRecommendations, userProgress: fetchedProgress }
                    };

                     // --- Validation Check (with Logging) ---
                     console.log("--- Validating Parsed URL Data ---");
                     const hasIncome=Object.values(rawData.userInput.income).some(v=>v>0);
                     const hasExpenses=Object.values(rawData.userInput.expenses).some(v=>v>0);
                     const hasSavings=Object.values(rawData.userInput.savings).some(v=>v>0);
                     const hasDebt=rawData.userInput.debts.some(d=>d.balance>0);
                     const hasName=!!rawData.userInput.personalInfo.userName&&rawData.userInput.personalInfo.userName!=='User';
                     console.log("rawData object just before validation:", JSON.stringify(rawData, null, 2));
                     console.log(`Individual validation checks: hasIncome=${hasIncome}, hasExpenses=${hasExpenses}, hasSavings=${hasSavings}, hasDebt=${hasDebt}, hasName=${hasName}`);
                     if(hasIncome||hasExpenses||hasSavings||hasDebt||hasName){
                         dashboardData=rawData;
                         dataLoaded=true;
                         console.log(">>> Validation PASSED.");
                     } else { dataLoaded=false; console.warn("!!! Validation FAILED."); }

                 } else { /* ... no URL params ... */ }

                 // --- Load from Embedded JSON (Unchanged) ---
                 if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') { /* ... */ }

                 // --- Final Check (Unchanged) ---
                 if (dataLoaded && dashboardData) {
                     renderDashboard(dashboardData);
                 } else {
                     throw new Error("No valid financial data found...");
                 }
                 console.log("--- initializeDashboard END (Success) ---");

             } catch (err) {
                  console.error("--- initializeDashboard Data Processing ERROR ---", err);
                  handleError("Dashboard initialization failed", err);
             }
        } // End initializeDashboard


        // --- RENDER DASHBOARD ---
        function renderDashboard(data) {
             try {
                 console.log("--- renderDashboard START ---");
                 dashboardData = data; // Ensure global is set

                 // Extract data subsections for easier use
                 const userInput = data.userInput || {};
                 const personalInfo = userInput.personalInfo || {};
                 const income = userInput.income || {};
                 const expenses = userInput.expenses || {};
                 const savings = userInput.savings || {};
                 const debts = userInput.debts || [];
                 const aiOutput = data.aiOutput || {};

                 // --- Calculations ---
                 const userName = personalInfo.userName || 'User';
                 const totalIncome = (income.mainJobIncome || 0) + (income.secondJob || 0) + (income.otherIncome || 0);
                 // Exclude taxes from general expense total for some ratio calculations if needed, but include for cash flow
                 const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + (val || 0), 0);
                 const netCashFlow = totalIncome - totalExpenses;
                 const totalSavings = (savings.emergency || 0) + (savings.savings || 0) + (savings.retirement || 0);
                 const totalDebtBalance = debts.reduce((sum, debt) => sum + (debt.balance || 0), 0);
                 const totalMinDebtPayments = debts.reduce((sum, debt) => sum + (debt.minPayment || 0), 0); // Sum of MINIMUM payments
                 const netWorth = totalSavings - totalDebtBalance;
                 // Savings Rate (Net Cash Flow as % of Total Income)
                 const savingsRate = totalIncome > 0 ? (netCashFlow / totalIncome) * 100 : 0;
                 // Emergency Fund Coverage (Months)
                 const monthlyExpensesForCoverage = totalExpenses - (expenses.taxes || 0); // Often calculated against non-tax expenses
                 const emergencyFundCoverage = monthlyExpensesForCoverage > 0 ? (savings.emergency || 0) / monthlyExpensesForCoverage : 0;
                 // DTI Ratio (Approximate: Total Min Debt Payments / Total Gross Income)
                 // NOTE: Assumes totalIncome is Gross. May need adjustment if it's Net.
                 // NOTE: Uses estimated min payments calculated during data load.
                 const dtiRatio = totalIncome > 0 ? (totalMinDebtPayments / totalIncome) * 100 : 0;


                 // --- Populate DOM Elements ---
                 document.getElementById('userNameDisplay').textContent = userName;
                 document.getElementById('dashboard-subtitle').textContent = `Personalized Insights for ${userName}`;

                 // Key Metrics
                 const netCashFlowEl = document.getElementById('netCashFlow'); // ... populate with netCashFlow, add styling based on value ...
                 const savingsRateEl = document.getElementById('savingsRate'); // ... populate with savingsRate, add styling ...
                 const netWorthEl = document.getElementById('netWorth'); // ... populate with netWorth ...
                 const emergencyFundCoverageEl = document.getElementById('emergencyFundCoverage'); // ... populate with emergencyFundCoverage ...
                 const dtiRatioEl = document.getElementById('dtiRatio'); // ... populate with dtiRatio, add styling ...

                 // Detailed breakdown rendering (example for income)
                 document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
                 const incomeBreakdownEl = document.getElementById('incomeBreakdown'); incomeBreakdownEl.innerHTML = ''; let incomeItems=0;
                 if(income.mainJobIncome>0){incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Main Job</span><span class="breakdown-value">${formatCurrency(income.mainJobIncome)}</span></div>`;}
                 if(income.secondJob>0){incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Second Job</span><span class="breakdown-value">${formatCurrency(income.secondJob)}</span></div>`;}
                 if(income.otherIncome>0){incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Other Income</span><span class="breakdown-value">${formatCurrency(income.otherIncome)}</span></div>`;}
                 if(incomeItems === 0){incomeBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm italic">No income provided.</p>';}

                 document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
                 const expensesBreakdownEl = document.getElementById('expensesBreakdown'); expensesBreakdownEl.innerHTML = ''; let expenseItems=0; const expenseOrder = ['housing','groceriesEssentials','transportation','utilities','insurance','taxes','care','subscriptions','medical'];
                 expenseOrder.forEach(key => { if(expenses[key] && expenses[key] > 0){ expenseItems++; const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace('Essentials',' & Essentials'); expensesBreakdownEl.innerHTML += `<div><span class="breakdown-label">${label}</span><span class="breakdown-value">${formatCurrency(expenses[key])}</span></div>`; }});
                 Object.entries(expenses).forEach(([key, value]) => { if (value > 0 && !expenseOrder.includes(key)) { expenseItems++; const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); expensesBreakdownEl.innerHTML += `<div><span class="breakdown-label">${label}</span><span class="breakdown-value">${formatCurrency(value)}</span></div>`; }});
                 if(expenseItems === 0){expensesBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm italic">No expenses provided.</p>';}

                 // --- Call Helper Rendering Functions (Now More Detailed) ---
                 renderSummaryAndRecommendations(data, { totalIncome, totalExpenses, netCashFlow, totalSavings, totalDebtBalance, emergencyMonths: emergencyFundCoverage, dti: dtiRatio });
                 populateAISections(aiOutput); // Stays the same
                 renderExpenseBreakdownChart(expenses); // NEW specific chart function
                 renderAssetsVsLiabilitiesChart(savings, debts); // NEW specific chart function


                 // --- Final Display ---
                 document.getElementById('loadingSpinner')?.classList.add('hidden');
                 document.getElementById('errorMessage')?.classList.add('hidden');
                 document.getElementById('mainContent')?.classList.remove('hidden');
                 console.log("--- renderDashboard END ---");

            } catch (err) {
                 console.error("--- renderDashboard ERROR ---", err);
                 handleError("Error rendering dashboard content", err);
                 document.getElementById('loadingSpinner')?.classList.add('hidden');
            }
        }

        // --- ** RESTORED / DETAILED ** Helper Rendering Functions ---

        function renderSummaryAndRecommendations(data, metrics) {
             // Uses calculated metrics passed in
             const summaryContent = document.getElementById('summaryContent');
             if (!summaryContent || !data?.userInput || !metrics) { console.warn("Missing data for summary."); return; }

             const userName = data.userInput.personalInfo?.userName || 'User';
             const { totalIncome, totalExpenses, netCashFlow, totalSavings, totalDebtBalance, emergencyMonths, dti } = metrics;

             // Build detailed recommendations based on metrics
             let recsList = [];
             if (netCashFlow < 0) { recsList.push(`<li class="text-danger"><strong class="font-semibold">Address Cash Flow:</strong> Expenses (${formatCurrency(totalExpenses)}) exceed income (${formatCurrency(totalIncome)}). Review spending for cuts.</li>`); }
             else { const sr = totalIncome > 0 ? (netCashFlow/totalIncome)*100 : 0; if(sr < 15){recsList.push(`<li class="text-warning"><strong class="font-semibold">Boost Savings Rate:</strong> Aim for 15-20% of income (currently ${formatPercentage(sr)}).</li>`);} else {recsList.push(`<li class="text-success"><strong class="font-semibold">Good Savings Rate:</strong> Rate is ${formatPercentage(sr)}. Allocate effectively.</li>`);}}
             if (emergencyMonths < 3) { recsList.push(`<li class="text-danger"><strong class="font-semibold">Prioritize Emergency Fund:</strong> You have ~${emergencyMonths.toFixed(1)} months coverage. Aim for 3-6 months.</li>`);} else if (emergencyMonths < 6) {recsList.push(`<li class="text-warning"><strong class="font-semibold">Grow Emergency Fund:</strong> Coverage is ${emergencyMonths.toFixed(1)} months. Continue building to 6 months.</li>`);} else {recsList.push(`<li class="text-success"><strong class="font-semibold">Solid Emergency Fund:</strong> Coverage at ${emergencyMonths.toFixed(1)} months.</li>`);}
             const highInterestDebt = (data.userInput.debts || []).find(d => d.balance > 0 && d.interestRate > 10);
             if (highInterestDebt) { recsList.push(`<li class="text-danger"><strong class="font-semibold">Tackle High-Interest Debt:</strong> Focus on debt >10% interest (like ${highInterestDebt.type} at ${highInterestDebt.interestRate?.toFixed(1)}%).</li>`);} else if (totalDebtBalance > 0) {recsList.push(`<li><strong class="font-semibold">Manage Debt:</strong> Continue payments, consider extra on highest interest loan.</li>`);} else {recsList.push(`<li class="text-success"><strong class="font-semibold">Debt-Free:</strong> Excellent! Focus on saving/investing.</li>`);}
             if (dti > 40) {recsList.push(`<li class="text-danger"><strong class="font-semibold">High DTI Ratio:</strong> Your Debt-to-Income ratio is high (${formatPercentage(dti)}). Focus on reducing debt or increasing income.</li>`);} else if (dti > 30) {recsList.push(`<li class="text-warning"><strong class="font-semibold">Moderate DTI Ratio:</strong> DTI is ${formatPercentage(dti)}. Monitor debt levels.</li>`);}

             summaryContent.innerHTML = `
                 <h3 class="text-lg font-semibold mb-3">Financial Snapshot for ${userName}</h3>
                 <div class="space-y-4">
                     <p>Overview based on provided data:</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                          <div><h4 class="font-semibold mb-2 text-indigo-700">Monthly Flow</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Income: <span class="font-medium">${formatCurrency(totalIncome)}</span></li><li>Expenses: <span class="font-medium">${formatCurrency(totalExpenses)}</span></li><li>Net Flow: <span class="font-medium ${netCashFlow >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netCashFlow)}</span></li></ul></div>
                          <div><h4 class="font-semibold mb-2 text-indigo-700">Assets & Liabilities</h4><ul class="list-disc pl-5 space-y-1 text-sm"><li>Total Savings: <span class="font-medium">${formatCurrency(totalSavings)}</span></li><li>Total Debt: <span class="font-medium">${formatCurrency(totalDebtBalance)}</span></li><li>Net Worth: <span class="font-medium">${formatCurrency(totalSavings - totalDebtBalance)}</span></li></ul></div>
                     </div>
                     <div class="mt-6 pt-4 border-t"><h4 class="font-semibold mb-2 text-indigo-700">Key Recommendations</h4><ul class="list-disc pl-5 space-y-2 text-sm">${recsList.join('')}</ul></div>
                 </div>`;
        }

        function populateAISections(aiOutput) { /* ... same as before ... */ }

        // ** RESTORED ** More Detailed Chart Functions
        function renderExpenseBreakdownChart(expenses) {
            const chartDiv = document.getElementById('expenseBreakdownChart');
            if (!chartDiv || typeof Plotly === 'undefined' || !expenses) return;

            try {
                const labels = [];
                const values = [];
                // Sort expenses descending for better pie chart visibility
                const sortedExpenses = Object.entries(expenses)
                    .filter(([key, value]) => value > 0)
                    .sort(([, a], [, b]) => b - a);

                sortedExpenses.forEach(([key, value]) => {
                     // Prettier labels
                    labels.push(key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace('Essentials',' & Essentials'));
                    values.push(value);
                });

                if (values.length === 0) {
                    chartDiv.innerHTML = `<p class="text-center text-gray-500 pt-10">No expense data for chart.</p>`; return;
                }

                const plotData = [{
                    values: values,
                    labels: labels,
                    type: 'pie',
                    hole: 0.4, // Doughnut chart
                    textinfo: 'percent',
                    textposition: 'inside',
                    // automargin: true,
                    marker: {
                        // Consider defining a color palette
                        line: { color: '#ffffff', width: 1 }
                    },
                    hoverinfo: 'label+percent+value',
                    insidetextorientation: 'radial'
                }];

                const layout = {
                     margin: { t: 20, b: 20, l: 20, r: 20 },
                     showlegend: true,
                     legend: { orientation: 'h', y: -0.1 },
                     height: 380,
                     paper_bgcolor: 'rgba(0,0,0,0)',
                     plot_bgcolor: 'rgba(0,0,0,0)',
                     font: { family: 'Inter, sans-serif', size: 12 }
                };

                Plotly.newPlot(chartDiv, plotData, layout, {responsive: true, displaylogo: false});
            } catch (e) {
                console.error("Error rendering expense breakdown chart:", e);
                chartDiv.innerHTML = `<p class="text-center text-red-500">Error rendering expense chart</p>`;
            }
        }

        function renderAssetsVsLiabilitiesChart(savings, debts) {
            const chartDiv = document.getElementById('savingsDebtChart');
            if (!chartDiv || typeof Plotly === 'undefined' || !savings || !debts) return;

             try {
                const assetsLabels = [];
                const assetsValues = [];
                Object.entries(savings).forEach(([key, value]) => {
                    if (value > 0) {
                         assetsLabels.push(key.charAt(0).toUpperCase() + key.slice(1)); // Capitalize
                         assetsValues.push(value);
                    }
                });

                const liabLabels = [];
                const liabValues = [];
                 (debts || []).forEach(debt => {
                     if (debt.balance > 0) {
                         liabLabels.push(debt.type || 'Other Debt');
                         liabValues.push(debt.balance);
                     }
                 });

                const totalAssets = assetsValues.reduce((s, v) => s + v, 0);
                const totalLiabilities = liabValues.reduce((s, v) => s + v, 0);

                if (totalAssets === 0 && totalLiabilities === 0) {
                    chartDiv.innerHTML = `<p class="text-center text-gray-500 pt-10">No asset/liability data for chart.</p>`; return;
                }

                 // Use grouped bar chart
                 const traceAssets = {
                     x: assetsLabels,
                     y: assetsValues,
                     name: 'Assets',
                     type: 'bar',
                     marker: { color: 'rgba(16, 185, 129, 0.8)' } // Green
                 };
                 const traceLiabilities = {
                     x: liabLabels,
                     y: liabValues,
                     name: 'Liabilities',
                     type: 'bar',
                     marker: { color: 'rgba(239, 68, 68, 0.8)' } // Red
                 };

                const layout = {
                     barmode: 'group',
                     margin: { t: 20, b: 40, l: 50, r: 10 },
                     yaxis: { title: 'Amount ($)', automargin: true },
                     xaxis: { automargin: true },
                     showlegend: true,
                     legend: { orientation: 'h', y: -0.2 },
                     height: 380,
                     paper_bgcolor: 'rgba(0,0,0,0)',
                     plot_bgcolor: 'rgba(0,0,0,0)',
                     font: { family: 'Inter, sans-serif', size: 12 }
                 };

                Plotly.newPlot(chartDiv, [traceAssets, traceLiabilities], layout, {responsive: true, displaylogo: false});

            } catch (e) {
                console.error("Error rendering assets vs liabilities chart:", e);
                chartDiv.innerHTML = `<p class="text-center text-red-500">Error rendering A/L chart</p>`;
            }
        }


        // --- Chat Functionality (Using Backend - Unchanged) ---
        function initializeChat() { /* ... unchanged ... */ }
        function enableChatInput(enabled) { /* ... unchanged ... */ }
        function handleChatSubmit() { /* ... unchanged ... */ }
        function addMessageToChat(sender, message, isError = false) { /* ... unchanged ... */ }
        function setChatStatus(message, isLoading = false) { /* ... unchanged ... */ }
        async function sendToBackendChatFunction() { /* ... unchanged, uses correct backendEndpoint ... */ }

    </script>
</body>
</html>

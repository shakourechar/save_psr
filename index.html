<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <style>
        :root { /* ... CSS Variables ... */ }
        body { /* ... */ }
        .header-font { /* ... */ }
        .main-container { /* ... */ }
        .dashboard-card { /* ... */ }
        .stat-value { /* ... */ }
        .stat-label { /* ... */ }
        .card-header { /* ... */ }
        .breakdown-list div { /* ... */ }
        .breakdown-label { /* ... */ }
        .breakdown-value { /* ... */ }
        .action-button { /* ... */ }
        .secondary-button { /* ... */ }
        .prose { /* ... */ }
        .text-success { /* ... */ } .text-warning { /* ... */ } .text-danger { /* ... */ }
        footer { /* ... */ }
        #debugInfo table { /* ... */ }
        /* --- Modern Chat Widget Styles --- */
        #chatInterfaceCard { /* ... */ }
        .chat-container { /* ... */ }
        .chat-history { /* ... */ }
        /* ... other chat styles ... */
        .chat-input-area textarea { /* ... */ }
        .chat-input-area button { /* ... */ }
        .typing-indicator span { /* ... */ }
        @keyframes typing { /* ... */ }
    </style>
</head>
<body class="min-h-screen">
    <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>

    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
        <div class="text-center">
             <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p class="text-gray-700 text-lg">Loading your financial dashboard...</p>
         </div>
    </div>

    <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-95 z-50 p-4">
        <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-5 rounded-lg max-w-lg shadow-md">
             <h3 class="font-bold text-xl mb-3 header-font">Error Loading Dashboard</h3>
             <p id="errorText" class="mb-4">Unable to load financial data. Please check the URL or try again later.</p>
             <div id="debugInfo" class="mb-4 max-h-60 overflow-auto bg-gray-100 p-3 rounded text-xs border border-gray-300">Initializing debug info...</div>
             <div class="flex justify-center space-x-3 mt-4">
                 <button id="retryButton" class="action-button">Retry Loading</button>
                 <button id="manualEntryButton" class="secondary-button">Use Demo Data</button>
             </div>
         </div>
    </div>

    <div id="mainContent" class="main-container hidden">
        <header class="mb-10 border-b border-gray-200 pb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                 <div><h1 id="dashboard-title" class="header-font text-4xl md:text-5xl font-bold text-gray-800 mb-1">SmartWealth Navigator</h1><p id="dashboard-subtitle" class="text-gray-600 text-lg">Your Personalized Financial Insights</p></div>
                 <div class="mt-4 md:mt-0 text-sm text-gray-500">Data for: <span id="userNameDisplay" class="font-semibold text-gray-700">User</span> | Last Updated: <span id="updateDate">Today</span></div>
             </div>
        </header>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Key Financial Metrics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Monthly Net Cash Flow</h3><div class="text-center mt-2"><span id="netCashFlow" class="stat-value block mb-2">$0</span><div class="bg-gray-200 h-2.5 rounded-full mb-3"><div id="cashFlowProgress" class="h-2.5 rounded-full" style="width: 0%"></div></div><p id="cashFlowMessage" class="text-xs text-gray-500 h-8"></p></div></div>
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Savings Rate</h3><div class="text-center mt-2"><span id="savingsRate" class="stat-value block mb-2">0%</span><p class="text-xs text-gray-500 mt-3">(Net Cash Flow / Total Income)</p></div></div>
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Estimated Net Worth</h3><div class="text-center mt-2"><span id="netWorth" class="stat-value block mb-2">$0</span><p class="text-xs text-gray-500 mt-3">(Total Savings - Total Debt)</p></div></div>
                 <div class="dashboard-card p-5"><h3 class="card-header text-base">Emergency Fund</h3><div class="text-center mt-2"><span id="emergencyFundCoverage" class="stat-value block mb-2">0 months</span><p class="text-xs text-gray-500 mt-3">(Emergency Savings / Monthly Expenses)</p></div></div>
             </div>
        </section>

        <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Income & Expenses Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="dashboard-card"><h3 class="card-header">Monthly Income Breakdown</h3><div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200"><span class="stat-label font-semibold">Total Income</span><span id="totalIncome" class="stat-value text-green-600">$0</span></div><div id="incomeBreakdown" class="space-y-2 breakdown-list"><p class="text-gray-500 text-sm">Loading...</p></div></div>
                 <div class="dashboard-card"><h3 class="card-header">Monthly Expenses Breakdown</h3><div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200"><span class="stat-label font-semibold">Total Expenses</span><span id="totalExpenses" class="stat-value text-red-600">$0</span></div><div id="expensesBreakdown" class="space-y-1 breakdown-list max-h-60 overflow-y-auto pr-2"><p class="text-gray-500 text-sm">Loading...</p></div></div>
             </div>
        </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Visualizations</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="dashboard-card"><h3 class="card-header">Income vs. Expenses</h3><div id="incomeExpenseChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div></div>
                 <div class="dashboard-card"><h3 class="card-header">Savings & Debt Overview</h3><div id="savingsDebtChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div></div>
             </div>
         </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">AI Insights & Recommendations</h2>
             <div class="dashboard-card">
                 <div id="summaryContent" class="prose max-w-none prose-indigo"><p class="text-gray-500">Generating summary...</p></div>
                  <div id="aiAnalysisSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Analysis</h3><p id="aiAnalysisContent"></p></div>
                  <div id="aiRecommendationsSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Recommendations</h3><p id="aiRecommendationsContent"></p></div>
                  <div id="aiProgressSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">User Progress History</h3><p id="aiProgressContent"></p></div>
             </div>
        </section>

        <section id="chatInterfaceCard" class="dashboard-card"> <h2 class="card-header header-font text-xl font-bold mb-5">Chat with SmartWealth AI</h2>
             <div class="chat-container">
                <div class="chat-history" id="chatHistory"></div>
                <div class="chat-status" id="chatStatus"></div>
                <div class="chat-input-area">
                    <textarea id="chatInput" placeholder="Ask about your finances..." rows="1" disabled></textarea>
                    <button id="chatSendButton" class="action-button" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"> <path d="M3.105 3.105a1.5 1.5 0 011.995-.04l8 4a1.5 1.5 0 010 2.87l-8 4a1.5 1.5 0 01-1.995-.04L1.6 13.89a1.5 1.5 0 01-.04-1.995l3-4a1.5 1.5 0 010-1.79l-3-4a1.5 1.5 0 01.04-1.995l1.5-1.5z" /> </svg>
                         <span class="sr-only">Send</span>
                    </button>
                </div>
             </div>
        </section>

        <footer class="text-center text-gray-500 text-sm py-6">
             <p>SmartWealth Navigator &copy; 2025 | Built by Socialeap™️</p>
              <p>Consult with a qualified financial advisor for personalized advice.</p>
        </footer>
    </div>

    <script>
        // --- Global Variables ---
        let dashboardData = null;
        let chatMessages = [];
        const CHAT_MODEL = 'gpt-4o-mini';

        // --- Supabase Client (CONFIGURE THESE) ---
        const SUPABASE_URL = 'https://tfnwwpksieluzvxqdiiq.supabase.co'; // <-- REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbnd3cGtzaWVsdXp2eHFkaWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1ODQ3MjgsImV4cCI6MjA2MDE2MDcyOH0.xbtjiQ65vCggjj35qtlCZ0S5mJa4muSZcHXhaU4qvrE'; // <-- REPLACE
        let supabase = null; // Will be initialized in DOMContentLoaded

        // --- Utility Functions ---
        function formatCurrency(value) {
             if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }
        function formatPercentage(value) {
            if (isNaN(value) || !isFinite(value)) return '0%';
             return `${value.toFixed(1)}%`;
        }

        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded.");

            // ** Initialize Supabase Client HERE **
            try {
                 if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') { throw new Error("Supabase URL missing."); }
                 if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') { throw new Error("Supabase Anon Key missing."); }
                 if (typeof window.supabase === 'undefined' || !window.supabase || typeof window.supabase.createClient !== 'function') { throw new Error("Supabase library failed to load."); }

                 const { createClient } = window.supabase;
                 supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                 console.log("Supabase client initialized successfully WITHIN DOMContentLoaded.");

                 // ** Setup Other Listeners and Initialize Dashboard AFTER Supabase Init **
                 const today = new Date();
                 const updateDateEl = document.getElementById('updateDate');
                 if (updateDateEl) {
                     updateDateEl.textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                 } else {
                     console.warn("Update date element not found.");
                 }

                 document.getElementById('retryButton')?.addEventListener('click', function() {
                      document.getElementById('errorMessage')?.classList.add('hidden');
                      document.getElementById('loadingSpinner')?.classList.remove('hidden');
                      setTimeout(initializeDashboard, 100); // Shorter timeout
                 });
                 document.getElementById('manualEntryButton')?.addEventListener('click', function() {
                      document.getElementById('errorMessage')?.classList.add('hidden');
                      document.getElementById('loadingSpinner')?.classList.remove('hidden');
                      useDemoData();
                 });

                 // Now call the main dashboard initializer
                 initializeDashboard();

            } catch (error) {
                 console.error("Critical Error during initial setup (Supabase or DOM):", error);
                 // Use handleError to display the critical failure
                 handleError("Failed during initial page setup", error);
                 // Hide spinner, show error block (handleError does this)
                 document.getElementById('loadingSpinner')?.classList.add('hidden');
            }
        }); // End DOMContentLoaded Listener

        // --- Debugging & Error Handling ---
        function debugURLParameters() { /* ... unchanged ... */ }
        function handleError(message, error) { /* ... unchanged, ensures spinner hidden, error shown ... */ }

        // --- Demo Data ---
        // Using Claude's slightly adjusted demo data structure for robustness
        function useDemoData() {
             console.log("Using Demo Data");
             const demoData = {
                 userInput: {
                     personalInfo: { userName: "Demo User", age: 35 },
                     income: { mainJobIncome: 5000, secondJob: 1000, otherIncome: 200 },
                     expenses: { housing: 1500, transportation: 400, utilities: 300, groceriesEssentials: 800, insurance: 200, medical: 150, care: 100, subscriptions: 50, taxes: 1200 },
                     savings: { emergency: 10000, savings: 15000, retirement: 50000 },
                     debts: [ { type: "Credit Card", balance: 3000, interestRate: 22.5, minPayment: 50 }, { type: "Bank Loans", balance: 15000, interestRate: 6.5, minPayment: 100 } ]
                 },
                 aiOutput: { analysis: "Demo: Positive cash flow, but emergency fund could be higher. Credit card debt is manageable.", recommendations: "Demo: Prioritize emergency fund to 6 months. Consider extra payments on credit card.", userProgress: "Demo: Initial report." }
             };
             // IMPORTANT: Directly call renderDashboard, assume init is done/failed gracefully
             renderDashboard(demoData);
        }

        // --- Initialize Dashboard Data Logic ---
        function initializeDashboard() {
            // Moved Supabase init to DOMContentLoaded
            console.log("--- initializeDashboard START (Data Processing Only) ---");
            const params = new URLSearchParams(window.location.search);
            const dataElement = document.getElementById('embeddedPsrData');
            let dataLoaded = false;
            let rawData = {};

            try {
                 // --- Parameter Getter & Parser (Unchanged) ---
                 const getParam = (keyBase) => { /* ... */ };
                 const parseNumeric = (keyName, value, defaultValue = 0) => { /* ... */ };

                 // --- Load from URL (Unchanged) ---
                 console.log("--- Parsing URL Parameters ---");
                 if (params.toString().length > 0) {
                    // ... Fetching all parameters ...
                    const fetchedUserName=getParam('userName')||getParam('username'); const fetchedAge=parseNumeric('age',getParam('age')); const fetchedMainJobIncome=parseNumeric('mainJobIncome',getParam('mainJobIncome')); const fetchedSecondJobIncome=parseNumeric('secondJobIncome',getParam('secondJobIncome')||getParam('secondJob')); const fetchedOtherIncome=parseNumeric('otherIncome',getParam('otherIncome')); const fetchedHousing=parseNumeric('housing',getParam('housing')); const fetchedTransportation=parseNumeric('transportation',getParam('transportation')); const fetchedUtilities=parseNumeric('utilities',getParam('utilities')); const fetchedGroceries=parseNumeric('groceries-essentials',getParam('groceries-essentials')||getParam('groceries')); const fetchedInsurance=parseNumeric('insurance',getParam('insurance')); const fetchedMedical=parseNumeric('medical',getParam('medical')); const fetchedCare=parseNumeric('care',getParam('care')); const fetchedSubscriptions=parseNumeric('subscriptions',getParam('subscriptions')); const fetchedTaxes=parseNumeric('taxes',getParam('taxes')); const fetchedEmergencySavings=parseNumeric('emergencySavings',getParam('emergencySavings')||getParam('emergency')); const fetchedCurrentSavings=parseNumeric('currentSavings',getParam('currentSavings')||getParam('savings')); const fetchedRetirementFund=parseNumeric('retirementFund',getParam('retirementFund')||getParam('retirement')); const fetchedCreditCardDebt=parseNumeric('creditCardDebt',getParam('creditCardDebt')||getParam('creditcard')); const fetchedBankLoans=parseNumeric('bankLoans',getParam('bankLoans')||getParam('loans'));
                    const decodeAIField=(fieldName)=>{ const val=getParam(fieldName); if(!val)return''; try{ const decoded=decodeURIComponent(val); return decoded; }catch(e){ console.warn(`Decode URI fail for ${fieldName}`,e); return val; } }; const fetchedAnalysis=decodeAIField('aiAnalysis'); const fetchedRecommendations=decodeAIField('recommendations'); const fetchedProgress=decodeAIField('userProgressHistory')||decodeAIField('userProgress');
                    rawData = { userInput: { personalInfo: { userName: fetchedUserName||'User', age: fetchedAge||30 }, income: { mainJobIncome: fetchedMainJobIncome, secondJob: fetchedSecondJobIncome, otherIncome: fetchedOtherIncome }, expenses: { housing: fetchedHousing, transportation: fetchedTransportation, utilities: fetchedUtilities, groceriesEssentials: fetchedGroceries, insurance: fetchedInsurance, medical: fetchedMedical, care: fetchedCare, subscriptions: fetchedSubscriptions, taxes: fetchedTaxes }, savings: { emergency: fetchedEmergencySavings, savings: fetchedCurrentSavings, retirement: fetchedRetirementFund }, debts: [ { type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: 22.5, minPayment: 50 }, { type: "Bank Loans", balance: fetchedBankLoans, interestRate: 6.5, minPayment: 100 } ] }, aiOutput: { analysis: fetchedAnalysis, recommendations: fetchedRecommendations, userProgress: fetchedProgress } };


                     // --- Validation Check (with Logging - Unchanged) ---
                     console.log("--- Validating Parsed URL Data ---");
                     const hasIncome=Object.values(rawData.userInput.income).some(v=>v>0); const hasExpenses=Object.values(rawData.userInput.expenses).some(v=>v>0); const hasSavings=Object.values(rawData.userInput.savings).some(v=>v>0); const hasDebt=rawData.userInput.debts.some(d=>d.balance>0); const hasName=!!rawData.userInput.personalInfo.userName&&rawData.userInput.personalInfo.userName!=='User';
                     console.log("rawData object just before validation:", JSON.stringify(rawData, null, 2));
                     console.log(`Individual validation checks: hasIncome=${hasIncome}, hasExpenses=${hasExpenses}, hasSavings=${hasSavings}, hasDebt=${hasDebt}, hasName=${hasName}`);
                     if(hasIncome||hasExpenses||hasSavings||hasDebt||hasName){dashboardData=rawData; dataLoaded=true; console.log(">>> Validation PASSED. Data loaded from URL.");}else{dataLoaded=false; console.warn("!!! Validation FAILED.");}

                 } else { console.log("--- No URL parameters detected ---"); }

                 // --- Load from Embedded JSON (Unchanged) ---
                 if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') { /* ... */ }

                 // --- Final Check (Unchanged) ---
                 if (dataLoaded && dashboardData) {
                     console.log(">>> Proceeding to render dashboard.");
                     renderDashboard(dashboardData); // Success case
                 } else {
                     throw new Error("No valid financial data found..."); // Triggers Demo/Retry
                 }
                 console.log("--- initializeDashboard END (Success) ---");

            } catch (err) {
                 // Handle errors specifically from data loading/parsing/validation
                 console.error("--- initializeDashboard Data Processing ERROR ---", err);
                 handleError("Dashboard initialization failed", err); // Shows error screen
            }
        } // End initializeDashboard

        // --- RENDER DASHBOARD ---
        function renderDashboard(data) {
             try {
                 console.log("--- renderDashboard START ---");
                 dashboardData = data; // Ensure global variable is updated

                 // ... (Code to calculate metrics remains the same) ...
                 const userInput = data.userInput || {}; const personalInfo = userInput.personalInfo || {}; const income = userInput.income || {}; const expenses = userInput.expenses || {}; const savings = userInput.savings || {}; const debts = userInput.debts || []; const aiOutput = data.aiOutput || {};
                 const userName=personalInfo.userName||'User'; const totalIncome=(income.mainJobIncome||0)+(income.secondJob||0)+(income.otherIncome||0); const totalExpenses=Object.values(expenses).reduce((s,v)=>s+(v||0),0); const netCashFlow=totalIncome-totalExpenses; const totalSavings=(savings.emergency||0)+(savings.savings||0)+(savings.retirement||0); const totalDebt=debts.reduce((s,d)=>s+(d.balance||0),0); const netWorth=totalSavings-totalDebt; const savingsRate=totalIncome>0?(netCashFlow/totalIncome)*100:0; const emergencyFundCoverage=totalExpenses>0?(savings.emergency||0)/totalExpenses:0;

                 // --- Populate DOM Elements ---
                 document.getElementById('userNameDisplay').textContent = userName;
                 document.getElementById('dashboard-subtitle').textContent=`Personalized Insights for ${userName}`;
                 // ... (Populate Key Metrics: netCashFlow, savingsRate, etc. - unchanged) ...
                 document.getElementById('totalIncome').textContent=formatCurrency(totalIncome); const incomeBreakdownEl=document.getElementById('incomeBreakdown'); incomeBreakdownEl.innerHTML=''; let incomeItems=0; if(income.mainJobIncome>0){/*...*/} if(income.secondJob>0){/*...*/} if(income.otherIncome>0){/*...*/} if(incomeItems===0){/*...*/}
                 document.getElementById('totalExpenses').textContent=formatCurrency(totalExpenses); const expensesBreakdownEl=document.getElementById('expensesBreakdown'); expensesBreakdownEl.innerHTML=''; let expenseItems=0; const expenseOrder=['housing','taxes',/*...*/]; /*...populate expenses...*/ if(expenseItems===0){/*...*/}

                 // --- Call Helper Rendering Functions ---
                 // Using simpler versions provided by Claude for robustness
                 renderSummaryAndRecommendations(data);
                 populateAISections(aiOutput);
                 renderIncomeExpenseChart(income, expenses);
                 renderSavingsDebtChart(savings, debts, totalSavings, totalDebt);

                 // --- Initialize Chat ---
                 initializeChat();

                 // --- Final Display ---
                 document.getElementById('loadingSpinner')?.classList.add('hidden');
                 document.getElementById('errorMessage')?.classList.add('hidden');
                 document.getElementById('mainContent')?.classList.remove('hidden');
                 console.log("--- renderDashboard END ---");

            } catch (err) {
                 console.error("--- renderDashboard ERROR ---", err);
                 handleError("Error rendering dashboard content", err); // Show error message
                 document.getElementById('loadingSpinner')?.classList.add('hidden'); // Ensure spinner is hidden on render error
            }
        }

        // --- ** NEW / VERIFIED ** Helper Rendering Functions ---
        // Basic implementations inspired by Claude's suggestions
        function renderSummaryAndRecommendations(data) {
            const summaryContent = document.getElementById('summaryContent');
            if (!summaryContent || !data?.userInput?.income || !data?.userInput?.expenses) {
                console.warn("Missing data or element for summary.");
                if(summaryContent) summaryContent.innerHTML = "<p>Could not generate summary.</p>";
                return;
            }
            try {
                 const income = data.userInput.income;
                 const expenses = data.userInput.expenses;
                 const totalIncome = (income.mainJobIncome || 0) + (income.secondJob || 0) + (income.otherIncome || 0);
                 const totalExpenses = Object.values(expenses).reduce((s, v) => s + (v || 0), 0);
                 const netFlow = totalIncome - totalExpenses;
                 summaryContent.innerHTML = `<h3>Financial Summary</h3><p>Based on your data, your estimated monthly cash flow is <strong>${formatCurrency(netFlow)}</strong>.</p><p><i>More detailed recommendations coming soon.</i></p>`;
             } catch (e) {
                  console.error("Error in renderSummaryAndRecommendations:", e);
                  if (summaryContent) summaryContent.innerHTML = "<p>Error generating summary.</p>";
             }
        }
        function populateAISections(aiOutput) {
             try {
                 if (aiOutput?.analysis) {
                     document.getElementById('aiAnalysisSection')?.classList.remove('hidden');
                     document.getElementById('aiAnalysisContent').textContent = aiOutput.analysis;
                 }
                 if (aiOutput?.recommendations) {
                     document.getElementById('aiRecommendationsSection')?.classList.remove('hidden');
                     document.getElementById('aiRecommendationsContent').innerHTML = aiOutput.recommendations.replace(/\n/g, '<br>'); // Handle newlines
                 }
                 if (aiOutput?.userProgress) {
                     document.getElementById('aiProgressSection')?.classList.remove('hidden');
                     document.getElementById('aiProgressContent').textContent = aiOutput.userProgress;
                 }
             } catch (e) {
                 console.error("Error populating AI sections:", e);
             }
        }
        function renderIncomeExpenseChart(incomeData, expenseData) {
             const chartDiv = document.getElementById('incomeExpenseChart');
             if (!chartDiv || typeof Plotly === 'undefined') return;
             try {
                 const incomeSum = Object.values(incomeData || {}).reduce((s,v)=>s+(v||0),0);
                 const expenseSum = Object.values(expenseData || {}).reduce((s,v)=>s+(v||0),0);
                 if (incomeSum === 0 && expenseSum === 0) {
                     chartDiv.innerHTML = `<p class="text-center text-gray-500 pt-10">No Income/Expense data for chart.</p>`; return;
                 }
                 Plotly.newPlot(chartDiv, [{ x: ['Income', 'Expenses'], y: [incomeSum, expenseSum], type: 'bar', marker: { color: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'] } }], { margin: { t: 20, b: 30, l: 50, r: 10 }, yaxis: { title: 'Amount ($)', automargin: true }, height: 350 }, {responsive: true, displaylogo: false});
             } catch (e) { console.error("Error rendering income/expense chart:", e); chartDiv.innerHTML = `<p class="text-center text-red-500">Error rendering chart</p>`; }
        }
        function renderSavingsDebtChart(savingsData, debtData, totalSavings, totalDebt) {
             const chartDiv = document.getElementById('savingsDebtChart');
             if (!chartDiv || typeof Plotly === 'undefined') return;
             try {
                 if (totalSavings === 0 && totalDebt === 0) {
                     chartDiv.innerHTML = `<p class="text-center text-gray-500 pt-10">No Savings/Debt data for chart.</p>`; return;
                 }
                 Plotly.newPlot(chartDiv, [{ values: [totalSavings, totalDebt], labels: ['Total Savings', 'Total Debt'], type: 'pie', hole: 0.4, marker: { colors: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'] }, textinfo: 'percent', textposition: 'inside' }], { margin: { t: 20, b: 20, l: 20, r: 20 }, showlegend: true, legend: {x:0.1, y:-0.1}, height: 350 }, {responsive: true, displaylogo: false});
             } catch (e) { console.error("Error rendering savings/debt chart:", e); chartDiv.innerHTML = `<p class="text-center text-red-500">Error rendering chart</p>`; }
        }


        // --- ** CHAT FUNCTIONALITY (Using Backend) ** ---
        // initializeChat, enableChatInput, handleChatSubmit, addMessageToChat, setChatStatus
        // These remain the same as the previous version (which removed API key handling)

        function initializeChat() {
            console.log("--- initializeChat START ---");
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatHistory = document.getElementById('chatHistory');
            const chatInterfaceCard = document.getElementById('chatInterfaceCard');

            if (!chatInput || !chatSendButton || !chatHistory || !chatInterfaceCard) { console.error("Chat UI elements not found!"); return; }

            chatInterfaceCard.classList.remove('hidden'); // Ensure chat card is visible

            if (!supabase) { addMessageToChat("System", "Chat service connection failed.", true); enableChatInput(false); return; }

            enableChatInput(true);
            chatHistory.innerHTML = '';
            addMessageToChat("System", "Ask a question about your financial data.", false);

            chatSendButton.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleChatSubmit(); } });
            console.log("--- initializeChat END ---");
        }

        function enableChatInput(enabled) { /* ... unchanged ... */ }
        function handleChatSubmit() { /* ... unchanged ... calls sendToBackendChatFunction */ }
        function addMessageToChat(sender, message, isError = false) { /* ... unchanged ... */ }
        function setChatStatus(message, isLoading = false) { /* ... unchanged ... */ }


        // Sends messages to YOUR Supabase Edge Function
        async function sendToBackendChatFunction() {
            if (!dashboardData) { addMessageToChat("System", "Error: Financial data not loaded.", true); return; }
            if (!supabase) { addMessageToChat("System", "Error: Chat service not connected.", true); return; }

             setChatStatus("Thinking...", true);
             enableChatInput(false);

            // --- Construct Context and System Message ---
            let financialContext = `Username: ${dashboardData.userInput?.personalInfo?.userName || 'N/A'}\n`;
            // ... (build financialContext string - unchanged) ...
            const totalIncome = Object.values(dashboardData.userInput?.income || {}).reduce((s,v)=>s+v,0); const totalExpenses = Object.values(dashboardData.userInput?.expenses || {}).reduce((s,v)=>s+v,0); financialContext += `Totals: Income(${formatCurrency(totalIncome)}), Expenses(${formatCurrency(totalExpenses)}), Net(${formatCurrency(totalIncome-totalExpenses)})\n`; financialContext += `Savings: Emergency(${formatCurrency(dashboardData.userInput?.savings?.emergency||0)}), General(${formatCurrency(dashboardData.userInput?.savings?.savings||0)}), Retirement(${formatCurrency(dashboardData.userInput?.savings?.retirement||0)})\n`; const totalDebt = (dashboardData.userInput?.debts || []).reduce((s,d)=>s+(d.balance || 0),0); financialContext += `Total Debt: ${formatCurrency(totalDebt)}\n`; if (dashboardData.aiOutput?.analysis) financialContext += `Prior Analysis: ${dashboardData.aiOutput.analysis}\n`; if (dashboardData.aiOutput?.recommendations) financialContext += `Prior Recs: ${dashboardData.aiOutput.recommendations}\n`;

             const systemMessage = { role: "system", content: `You are SmartWealth AI. Use the financial context below to answer concisely. Context:\n${financialContext}` };
             const messagesForBackend = [systemMessage, ...chatMessages];

            // --- Use the Correct Supabase Function URL ---
            const backendEndpoint = 'https://tfnwwpksieluzvxqdiiq.supabase.co/functions/v1/smooth-function'; // Your URL

            console.log(`Sending ${messagesForBackend.length} messages to backend: ${backendEndpoint}`);

            try {
                // Using fetch (ensure your function allows CORS and handles anon key if needed)
                const response = await fetch(backendEndpoint, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' /* Add 'apikey': SUPABASE_ANON_KEY if function requires it */ },
                     body: JSON.stringify({ messages: messagesForBackend })
                });

                setChatStatus("", false);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("Backend Function Error Response:", errorData);
                    const errorMsg = `Error calling chat backend (${response.status}): ${errorData?.error || response.statusText || 'Unknown error'}`;
                    addMessageToChat("System", errorMsg, true);
                    setChatStatus(`Error: ${response.status}`, false);
                    return; // Stop on error
                }

                const data = await response.json();

                // Process successful response
                if (data.assistantResponse && data.assistantResponse.content) {
                    const assistantMessage = data.assistantResponse;
                    addMessageToChat("Assistant", assistantMessage.content);
                    chatMessages.push(assistantMessage);
                } else {
                    addMessageToChat("System", "Received unexpected/empty response from backend.", true);
                    console.warn("Unexpected backend response:", data);
                }

            } catch (error) {
                 console.error("Error calling backend chat function:", error);
                 addMessageToChat("System", `Network error: ${error.message}`, true);
                 setChatStatus("Error", false);
            } finally {
                 enableChatInput(true); // Re-enable input
            }
        } // End sendToBackendChatFunction

    </script>
</body>
</html>

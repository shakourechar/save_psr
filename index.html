<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    .header-font {
      font-family: 'EB Garamond', serif;
    }
    .dashboard-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }
    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background-color: #e5e7eb;
    }
    .progress-value {
      height: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body class="min-h-screen">
  <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>
  
  <!-- Loading spinner -->
  <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
    <div class="text-center">
      <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-700">Loading your financial dashboard...</p>
    </div>
  </div>
  
  <!-- Error Message -->
  <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white z-50">
    <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg max-w-md">
      <h3 class="font-bold text-lg mb-2">Error Loading Dashboard</h3>
      <p id="errorText" class="mb-4">Unable to load financial data. Please try again later.</p>
      <div class="flex justify-center">
        <button id="retryButton" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded mr-2">
          Retry
        </button>
        <button id="manualEntryButton" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded">
          Use Demo Data
        </button>
      </div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="mainContent" class="container mx-auto px-4 py-8 max-w-7xl hidden">
    <!-- Dashboard Header -->
    <header class="mb-8">
      <h1 id="dashboard-title" class="header-font text-3xl md:text-4xl font-bold text-gray-800 mb-2">SmartWealth Navigator</h1>
      <p id="dashboard-subtitle" class="text-gray-600">Financial insights for <span id="userName">you</span></p>
    </header>

    <!-- Financial Overview -->
    <section class="mb-10">
      <h2 class="header-font text-2xl font-bold text-gray-800 mb-4">Financial Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Income Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Income</h3>
          <div class="flex justify-between items-center mb-4">
            <span class="stat-label">Total Income</span>
            <span id="totalIncome" class="stat-value text-green-600">$0</span>
          </div>
          <div id="incomeBreakdown" class="space-y-2">
            <!-- Income breakdown will be inserted here -->
          </div>
        </div>
        
        <!-- Expenses Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Expenses</h3>
          <div class="flex justify-between items-center mb-4">
            <span class="stat-label">Total Expenses</span>
            <span id="totalExpenses" class="stat-value text-red-600">$0</span>
          </div>
          <div class="mb-2">
            <div id="expensesChart" class="h-40"></div>
          </div>
        </div>
        
        <!-- Cash Flow Card -->
        <div class="dashboard-card p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Monthly Cash Flow</h3>
          <div class="flex justify-between items-center mb-2">
            <span class="stat-label">Net Cash Flow</span>
            <span id="netCashFlow" class="stat-value">$0</span>
          </div>
          <div class="progress-bar mb-6">
            <div id="cashFlowProgress" class="progress-value" style="width: 0%"></div>
          </div>
          <div class="text-sm text-gray-600">
            <div id="cashFlowMessage"></div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Additional dashboard sections omitted for brevity but would be included in the full code -->
    
    <footer class="text-center text-gray-500 text-sm py-4">
      <p>SmartWealth Navigator Â© 2025 | Data updated: <span id="updateDate">Today</span></p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set current date
      const today = new Date();
      document.getElementById('updateDate').textContent = today.toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
      
      // Add event listeners for buttons
      document.getElementById('retryButton').addEventListener('click', function() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('loadingSpinner').classList.remove('hidden');
        setTimeout(initializeDashboard, 500); // Small timeout to show loading spinner
      });
      
      document.getElementById('manualEntryButton').addEventListener('click', function() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('loadingSpinner').classList.remove('hidden');
        useDemoData();
      });
      
      // Initialize dashboard with data
      initializeDashboard();
    });

    // Format currency values
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }
    
    // Format percentage values
    function formatPercentage(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'percent',
        minimumFractionDigits: 1,
        maximumFractionDigits: 1
      }).format(value / 100);
    }
    
    // Function to use demo data if actual data loading fails
    function useDemoData() {
      const demoData = {
        userInput: {
          personalInfo: {
            userName: "Demo User",
            age: 35
          },
          income: {
            mainJobIncome: 5000,
            secondJob: 1200,
            otherIncome: 300
          },
          savings: {
            emergency: 15000,
            savings: 25000,
            retirement: 120000
          },
          expenses: {
            housing: 1800,
            transportation: 500,
            utilities: 300,
            groceriesEssentials: 600,
            insurance: 400,
            medical: 200,
            care: 100,
            subscriptions: 150,
            taxes: 1200
          },
          debts: [
            {
              type: "Credit Card",
              balance: 4500,
              interestRate: 22.5,
              minPayment: 150
            },
            {
              type: "Bank Loans",
              balance: 15000,
              interestRate: 6.5,
              minPayment: 300
            }
          ],
          financials: {
            financialTools: "Budgeting app, investment account",
            challenges: "Saving for home down payment",
            upcomingPurchase: "New car in 6 months"
          }
        },
        aiOutput: {
          analysis: "Based on your financial data, you have a positive cash flow which is great. Your emergency fund is adequate, covering about 3 months of expenses. Your debt-to-income ratio is within manageable range, but there's room for improvement with your credit card debt which has high interest.",
          recommendations: "Consider accelerating payments on your credit card debt to reduce high-interest costs. Increase retirement contributions to at least 15% of your income. Build your emergency fund to cover 6 months of expenses for better financial security.",
          userProgress: "This is your financial baseline. Continue tracking your progress monthly to see improvements in debt reduction and savings growth."
        }
      };
      
      renderDashboard(demoData);
      console.log("Demo data loaded successfully");
    }
    
    // Function to log and handle errors
    function handleError(message, error) {
      console.error(message, error);
      document.getElementById("errorText").innerText = `${message}: ${error.message || 'Unknown error'}`;
      document.getElementById("errorMessage").classList.remove("hidden");
      document.getElementById("loadingSpinner").classList.add("hidden");
      document.getElementById("mainContent").classList.add("hidden");
    }
    
    // Debug function to check URL parameters
    function debugURLParameters() {
      const params = new URLSearchParams(window.location.search);
      let paramsText = 'URL Parameters:\n';
      for (const [key, value] of params.entries()) {
        paramsText += `${key}: ${value}\n`;
      }
      console.log(paramsText);
    }
    
    // Initialize dashboard data
    function initializeDashboard() {
      const params = new URLSearchParams(window.location.search);
      const dataElement = document.getElementById('embeddedPsrData');
      let dataLoaded = false;
      let dashboardData = {};

      try {
        // Debug URL parameters
        debugURLParameters();
        
        // Try loading from URL parameters first
        if (params.has('userName') || params.has('mainJobIncome')) {
          dashboardData = {
            userInput: {
              personalInfo: {
                userName: params.get('userName') || 'User',
                age: Number(params.get('age') || 30)
              },
              income: {
                mainJobIncome: Number(params.get('mainJobIncome') || 0),
                secondJob: Number(params.get('secondJobIncome') || 0),
                otherIncome: Number(params.get('otherIncome') || 0)
              },
              savings: {
                emergency: Number(params.get('emergencySavings') || 0),
                savings: Number(params.get('currentSavings') || 0),
                retirement: Number(params.get('retirementFund') || 0)
              },
              expenses: {
                housing: Number(params.get('housing') || 0),
                transportation: Number(params.get('transportation') || 0),
                utilities: Number(params.get('utilities') || 0),
                groceriesEssentials: Number(params.get('groceries-essentials') || 0),
                insurance: Number(params.get('insurance') || 0),
                medical: Number(params.get('medical') || 0),
                care: Number(params.get('care') || 0),
                subscriptions: Number(params.get('subscriptions') || 0),
                taxes: Number(params.get('taxes') || 0)
              },
              debts: [
                {
                  type: "Credit Card",
                  balance: Number(params.get('creditCardDebt') || 0),
                  interestRate: 22.5,
                  minPayment: 50
                },
                {
                  type: "Bank Loans",
                  balance: Number(params.get('bankLoans') || 0),
                  interestRate: 6.5,
                  minPayment: 100
                }
              ],
              financials: {
                financialTools: params.get('financialTools') || '',
                challenges: params.get('challenges') || '',
                upcomingPurchase: params.get('upcomingPurchases') || ''
              }
            },
            aiOutput: {
              analysis: params.get('aiAnalysis') || '',
              recommendations: params.get('recommendations') || '',
              userProgress: params.get('userProgressHistory') || ''
            }
          };
          
          // Validate that essential data is present
          if (dashboardData.userInput.income.mainJobIncome > 0 || 
              dashboardData.userInput.income.secondJob > 0 || 
              dashboardData.userInput.income.otherIncome > 0) {
            dataLoaded = true;
            console.log("URL parameters loaded successfully");
          } else {
            console.warn("URL parameters found but income data is missing or invalid");
          }
        }
        
        // Try loading from embedded JSON if URL parameters aren't available or invalid
        if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
          try {
            const embeddedData = JSON.parse(dataElement.textContent);
            dashboardData = embeddedData;
            dataLoaded = true;
            console.log("Embedded data loaded successfully");
          } catch (jsonErr) {
            console.error("Error parsing embedded JSON:", jsonErr);
            throw new Error("Unable to parse embedded data");
          }
        }

        if (dataLoaded) {
          renderDashboard(dashboardData);
        } else {
          throw new Error("No valid financial data available for the dashboard");
        }
      } catch (err) {
        handleError("Dashboard initialization error", err);
      }
    }
    
    // Render the dashboard with the loaded data
    function renderDashboard(data) {
      try {
        // Set user name
        const userName = data.userInput.personalInfo.userName || 'User';
        document.getElementById('userName').textContent = userName;
        document.getElementById('dashboard-title').textContent = `SmartWealth Navigator`;
        
        // Calculate total income
        const income = data.userInput.income;
        const totalIncome = (income.mainJobIncome || 0) + (income.secondJob || 0) + (income.otherIncome || 0);
        document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
        
        // Render income breakdown
        const incomeBreakdownElement = document.getElementById('incomeBreakdown');
        incomeBreakdownElement.innerHTML = '';
        
        if (income.mainJobIncome > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Main Job</span>
              <span class="font-medium">${formatCurrency(income.mainJobIncome)}</span>
            </div>
          `;
        }
        
        if (income.secondJob > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Second Job</span>
              <span class="font-medium">${formatCurrency(income.secondJob)}</span>
            </div>
          `;
        }
        
        if (income.otherIncome > 0) {
          incomeBreakdownElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Other Income</span>
              <span class="font-medium">${formatCurrency(income.otherIncome)}</span>
            </div>
          `;
        }
        
        // Calculate total expenses
        const expenses = data.userInput.expenses;
        const totalExpenses = (expenses.housing || 0) + (expenses.transportation || 0) + 
                              (expenses.utilities || 0) + (expenses.groceriesEssentials || 0) + 
                              (expenses.insurance || 0) + (expenses.medical || 0) + 
                              (expenses.care || 0) + (expenses.subscriptions || 0) + 
                              (expenses.taxes || 0);
        document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        
        // Calculate and display net cash flow
        const netCashFlow = totalIncome - totalExpenses;
        const netCashFlowElement = document.getElementById('netCashFlow');
        const cashFlowProgressElement = document.getElementById('cashFlowProgress');
        const cashFlowMessageElement = document.getElementById('cashFlowMessage');
        
        netCashFlowElement.textContent = formatCurrency(netCashFlow);
        
        if (netCashFlow >= 0) {
          netCashFlowElement.classList.add('text-green-600');
          cashFlowProgressElement.classList.add('bg-green-500');
          const savingsRate = Math.min((netCashFlow / totalIncome) * 100, 100);
          cashFlowProgressElement.style.width = `${savingsRate}%`;
          
          if (savingsRate > 20) {
            cashFlowMessageElement.textContent = `Great job! You're saving ${Math.round(savingsRate)}% of your income.`;
            cashFlowMessageElement.classList.add('text-green-600');
          } else if (savingsRate > 10) {
            cashFlowMessageElement.textContent = `You're saving ${Math.round(savingsRate)}% of your income, which is good.`;
            cashFlowMessageElement.classList.add('text-green-600');
          } else {
            cashFlowMessageElement.textContent = `You're saving ${Math.round(savingsRate)}% of your income. Consider increasing this if possible.`;
            cashFlowMessageElement.classList.add('text-yellow-600');
          }
        } else {
          netCashFlowElement.classList.add('text-red-600');
          cashFlowProgressElement.classList.add('bg-red-500');
          const deficitRate = Math.min((Math.abs(netCashFlow) / totalIncome) * 100, 100);
          cashFlowProgressElement.style.width = `${deficitRate}%`;
          
          cashFlowMessageElement.textContent = `You're spending more than you earn. Consider reducing expenses or finding additional income sources.`;
          cashFlowMessageElement.classList.add('text-red-600');
        }
        
        // Render expenses chart - in a real implementation, this would be filled out
        // renderExpensesChart(expenses);
        document.getElementById('expensesChart').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Expenses breakdown chart</div>';
        
        // Hide loading spinner and show content
        document.getElementById('loadingSpinner').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        console.log("Dashboard rendered successfully");
        
      } catch (err) {
        handleError("Error rendering dashboard", err);
      }
    }
    
    // Function to render expenses chart
    function renderExpensesChart(expenses) {
      // This would be implemented with Chart.js or Plotly
      // For brevity, we're showing a placeholder
    }
    
    // Function to generate default recommendations
    function generateDefaultRecommendations(income, expenses, cashFlow, savings, debt, debtRatio, age) {
      // This would generate personalized recommendations based on financial data
      // For brevity, we're not implementing this
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
            color: #374151;
            margin: 0; padding: 0; line-height: 1.6;
        }
        /* Garamond for Headers */
        h1, h2, h3, h4, .header-font {
            font-family: 'EB Garamond', serif;
            color: #111827;
            font-weight: bold;
        }
        h1 { font-size: 1.8em; } h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; color: #333; } h4 { font-size: 1.1em; }

        /* Main Container */
        .main-container {
            max-width: 1400px; margin: 2rem auto; padding: 1.5rem 2rem;
            background: #ffffff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.07);
        }
        /* Header */
        header {
            display: flex; align-items: center; margin-bottom: 2rem;
            padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap;
        }
        header img { height: 72px; margin-right: 15px; border-radius: 8px; object-fit: contain; }
        header h1 { color: #4f46e5; margin: 0; flex-grow: 1; font-size: 2.2em; line-height: 1.2; }
        /* Header Buttons */
        header button {
            margin-left: 10px; padding: 0.6rem 1.2rem; background-color: #4f46e5;
            color: white; border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; transition: background-color 0.3s ease;
            font-family: 'Inter', sans-serif; font-weight: 500;
        }
        header button#uploadButton { background-color: #059669; }
        header button:hover { background-color: #4338ca; }
        header button#uploadButton:hover { background-color: #047857; }
        #fileInput { display: none; }

        /* Grid Layout */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 25px; }
        /* Dashboard Cards */
        .dashboard-card {
            background: #fff; padding: 1.5rem; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
            display: flex; flex-direction: column; min-height: 160px;
        }
        /* Card Headers */
        .card-header {
            font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 600; color: #374151;
            margin: -1.5rem -1.5rem 1.25rem -1.5rem; padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 10px 10px 0 0;
        }
        /* H3 inside card - Keep minimal if using .card-header */
        .dashboard-card h3 { margin: 0 0 1rem 0; padding: 0; border: none; background: none; }
        .card-content { flex-grow: 1; font-size: 0.95em; }
        .card-content p { margin-bottom: 0.6rem; }
        .card-content p strong { font-weight: 500; color: #1f2937; margin-right: 5px; }
        /* Chart Card Specifics */
        .chart-card { min-height: 400px; overflow: hidden; }
        .chart-container-div { min-height: 350px; width: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; }

        /* Ratio Bar Styles */
        .ratio-item { margin-bottom: 12px; }
        .ratio-label { display: block; font-weight: 500; margin-bottom: 3px; font-size: 0.9em; color: #4b5563; }
        .ratio-value { display: inline-block; margin-bottom: 5px; font-size: 1.1em; font-weight: 600; color: #1f2937; }
        .ratio-bar-container { background-color: #e5e7eb; border-radius: 4px; overflow: hidden; height: 8px; width: 100%; }
        .ratio-bar { height: 100%; width: 0%; transition: width 0.5s ease-in-out; border-radius: 4px; }
        .ratio-bar.savings-rate.poor { background-color: #ef4444; }
        .ratio-bar.savings-rate.ok { background-color: #f59e0b; }
        .ratio-bar.savings-rate.good { background-color: #10b981; }
        .ratio-bar.emergency-coverage.poor { background-color: #ef4444; }
        .ratio-bar.emergency-coverage.ok { background-color: #f59e0b; }
        .ratio-bar.emergency-coverage.good { background-color: #10b981; }
        .ratio-bar.dti-ratio.good { background-color: #10b981; }
        .ratio-bar.dti-ratio.warning { background-color: #f59e0b; }
        .ratio-bar.dti-ratio.high { background-color: #ef4444; }

        /* Debt Table Styles */
        #debtsTable { width: 100%; margin-top: 10px; border-collapse: collapse; }
        #debtsTable th, #debtsTable td { text-align: left; padding: 8px 5px; border-bottom: 1px solid #f3f4f6; font-size: 0.9em; }
        #debtsTable th { font-weight: 500; color: #6b7280; background-color: #f9fafb; }
        #debtsTable tr:last-child td { border-bottom: none; }
        #debtsTable .balance-col { text-align: right; font-weight: 500; }

        /* Progress Bar Styles */
        .progress-bar-container { background-color: #e5e7eb; border-radius: 6px; overflow: hidden; height: 20px; margin-top: 5px; margin-bottom: 10px; }
        .progress-bar { background-color: #4f46e5; height: 100%; width: 0%; transition: width 0.5s ease-in-out; text-align: center; color: white; font-size: 0.8em; line-height: 20px; font-weight: 500; }
        .goal-status { font-weight: 500; color: #1f2937; }

        /* Recommendations List Styles */
        #recommendationsList { list-style: none; padding-left: 0; margin-top: 10px; }
        #recommendationsList li { margin-bottom: 10px; line-height: 1.6; font-family: 'Inter', sans-serif; font-size: 0.95em; padding-left: 1.5em; position: relative; }
        #recommendationsList li::before { content: '✓'; color: #10b981; position: absolute; left: 0; font-weight: bold; }
        #recommendationsList li.warning::before { content: '!'; color: #f59e0b; }
        #recommendationsList li.critical::before { content: '!!'; color: #ef4444; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .close-button { color: #aaa; float: right; font-size: 32px; line-height: 1; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }

        /* Loading / Error / Initial States */
        #loadingSpinner, #errorMessage, #initialUploadPrompt {
             display: none; /* Hide all overlays by default */
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             z-index: 1050; background-color: rgba(255, 255, 255, 0.95);
             align-items: center; justify-content: center; padding: 1rem;
         }
         #errorMessage > div { /* Error box styling */
             background-color: #fee2e2; border: 1px solid #f87171; color: #b91c1c;
             padding: 1.5rem; border-radius: 0.5rem; max-width: 600px;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;
         }
         #errorMessage h3 { color: #991b1b; }
         #debugInfo {
             margin-top: 1rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;
             text-align: left; background-color: #f3f4f6; padding: 0.75rem;
             border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.75rem;
             line-height: 1.2; color: #4b5563; white-space: pre-wrap; word-break: break-all;
         }
         #debugInfo strong { color: #1f2937; }
         #errorMessage button {
             background-color: #dc2626; color: white; padding: 0.5rem 1rem; border: none;
             border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; margin: 0 0.5rem;
             transition: background-color 0.2s;
         }
          #errorMessage button:hover { background-color: #b91c1c; }
          #errorMessage button.secondary-button { background-color: #d1d5db; color: #374151; }
          #errorMessage button.secondary-button:hover { background-color: #9ca3af; }

         #initialUploadPrompt { /* Already hidden by default above */ }
         #initialUploadPrompt > .main-container { padding: 2rem; } /* Style inner container */
         #initialUploadButton { /* Style defined inline - could move here */ }

         #initialMessage { display: none; text-align: center; padding: 40px; font-size: 1.2em; color: #555; }
         #mainContent { display: none; } /* Start hidden */

        /* Chat Interface Card */
        #chatInterfaceCard { display: none; grid-column: 1 / -1; } /* Hide by default, span full width */
        /* Chat Styles */
        .chat-container { display: flex; flex-direction: column; height: 550px; border: 1px solid #d1d5db; border-radius: 10px; overflow: hidden; background-color: #ffffff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); }
        .chat-history { flex-grow: 1; padding: 1.5rem; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #d1d5db transparent; }
        .chat-history::-webkit-scrollbar { width: 8px; }
        .chat-history::-webkit-scrollbar-track { background: transparent; }
        .chat-history::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .chat-history::-webkit-scrollbar-thumb:hover { background-color: #9ca3af; }
        .chat-message { margin-bottom: 1.25rem; line-height: 1.6; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.assistant { justify-content: flex-start; }
        .chat-message.system { justify-content: center; margin: 0.5rem 0; }
        .message-bubble { border-radius: 18px; padding: 0.8rem 1.1rem; max-width: 75%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); word-wrap: break-word; }
        .chat-message.user .message-bubble { background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; border-radius: 18px 18px 4px 18px; }
        .chat-message.assistant .message-bubble { background-color: #eef2ff; color: #374151; border: 1px solid #e0e7ff; border-radius: 18px 18px 18px 4px; }
        .chat-message.system .message-bubble { background-color: #f3f4f6; color: #6b7280; font-size: 0.85em; text-align: center; max-width: 100%; border-radius: 8px; padding: 0.5rem 1rem; border: 1px solid #e5e7eb; box-shadow: none; }
        .message-sender { display: none; }

        /* Chat Status & Input */
        .chat-status { font-size: 0.8rem; color: #6b7280; padding: 0.5rem 1rem; text-align: center; height: 25px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .typing-indicator { display: inline-block; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .chat-input-area { border-top: 1px solid #e5e7eb; padding: 0.75rem 1rem; background-color: #f9fafb; display: flex; align-items: center; gap: 0.75rem; }
        .chat-input-area textarea { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid #d1d5db; border-radius: 20px; resize: none; font-size: 0.95rem; line-height: 1.4; height: 44px; background-color: white; transition: border-color 0.2s ease, box-shadow 0.2s ease; outline: none; }
        .chat-input-area textarea:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .chat-input-area button { padding: 0.6rem 1rem; white-space: nowrap; flex-shrink: 0; border-radius: 20px; background-color: #4f46e5; color: white; border: none; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .chat-input-area button:hover { background-color: #4338ca; }
        .chat-input-area button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .chat-input-area button svg { width: 1.25rem; height: 1.25rem; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; }
            header h1 { margin-top: 10px; font-size: 1.8em; }
            header button { margin-left: 0; margin-top: 10px; }
            .grid-container { grid-template-columns: 1fr; }
            .main-container { margin: 1rem; padding: 1rem; }
        }
    </style>
</head>

<body>
    <pre id="embeddedPsrData" style="display: none;">/* EMBEDDED_JSON_DATA_HERE */</pre>

    <div id="loadingSpinner">
        <div class="text-center">
             <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p class="text-gray-700 text-lg">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="errorMessage">
        <div>
            <h3 class="font-bold text-xl mb-3 header-font">Error Loading Dashboard</h3>
            <p id="errorText" class="mb-4">An error occurred.</p>
            <div id="debugInfo" class="mb-4 text-xs">Debug info will appear here...</div>
            <div class="flex justify-center space-x-3 mt-4">
                <button id="retryButton" class="action-button">Retry Loading</button>
                <button id="manualEntryButton" class="secondary-button">Use Demo Data</button>
            </div>
        </div>
    </div>

    <div id="initialUploadPrompt" style="display: none; text-align: center; padding: 60px 20px;">
        <div class="main-container" style="max-width: 600px; margin: auto;">
            <h2 class="header-font text-2xl mb-4 text-gray-700">Welcome to SmartWealth Navigator</h2>
            <p class="text-gray-600 mb-6">No financial data was detected. Please upload your saved Financial Report (PSR JSON) file to view your dashboard.</p>
            <button id="initialUploadButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 ease-in-out">Upload Report File (.json)</button>
            <p class="text-sm text-gray-500 mt-4">(If you haven't generated a report yet, please complete the initial form first.)</p>
        </div>
    </div>

    <div id="initialMessage" style="display: none;">
         Upload a PSR JSON file or provide data via URL parameter to view your dashboard.
    </div>

    <div id="mainContent" class="main-container">
        <header>
            <img src="https://static.wixstatic.com/media/c3283f_a9271d9818ba414994d98950da749489~mv2.jpg" alt="SmartWealth Navigator Logo">
            <h1>SmartWealth Navigator</h1>
            <input type="file" id="fileInput" accept=".json">
            <button id="uploadButton">Upload PSR</button> <button id="saveButton">Download PSR</button>
        </header>

        <div class="grid-container"> <div class="dashboard-card">
                <h3 class="card-header">Quick Summary</h3>
                <div class="card-content">
                    <p><strong>User:</strong> <span id="userName">N/A</span></p>
                    <p><strong>Age:</strong> <span id="age">N/A</span></p>
                    <p><strong>Total Monthly Income:</strong> <span id="totalIncome">N/A</span></p>
                    <p><strong>Total Monthly Expenses:</strong> <span id="totalExpenses">N/A</span></p>
                    <p><strong>Monthly Net Flow:</strong> <span id="netFlow">N/A</span></p>
                </div>
            </div>
            <div class="dashboard-card" id="ratiosCard">
                <h3 class="card-header">Key Financial Ratios</h3>
                <div class="card-content">
                    <div class="ratio-item"><span class="ratio-label">Savings Rate</span><span class="ratio-value" id="savingsRateValue">N/A</span><div class="ratio-bar-container"><div class="ratio-bar savings-rate poor" id="savingsRateBar"></div></div></div>
                    <div class="ratio-item"><span class="ratio-label">Emergency Fund Coverage</span><span class="ratio-value" id="emergencyCoverageValue">N/A</span><div class="ratio-bar-container"><div class="ratio-bar emergency-coverage poor" id="emergencyCoverageBar"></div></div></div>
                    <div class="ratio-item"><span class="ratio-label">Debt-to-Income (DTI)</span><span class="ratio-value" id="dtiRatioValue">N/A</span><div class="ratio-bar-container"><div class="ratio-bar dti-ratio good" id="dtiRatioBar"></div></div><p style="font-size: 0.8em; color: #666;">(Using min. payments)</p></div>
                </div>
            </div>
        </div>

        <div class="grid-container"> <div class="dashboard-card">
                 <h3 class="card-header">Savings Overview</h3>
                 <div class="card-content">
                    <p><strong>Emergency Savings:</strong> <span id="emergencySavings">N/A</span></p>
                    <p><strong>General Savings:</strong> <span id="currentSavings">N/A</span></p>
                    <p><strong>Retirement Fund:</strong> <span id="retirementFund">N/A</span></p>
                 </div>
            </div>
            <div class="dashboard-card" id="goalsCard">
                 <h3 class="card-header">Savings Goals Progress</h3>
                 <div class="card-content">
                    <div id="emergencyGoalDisplay" style="display: none;"><p><strong>Emergency Fund Goal:</strong> <span class="goal-status">N/A</span></p><div class="progress-bar-container"><div class="progress-bar" id="emergencyProgressBar"></div></div></div>
                    <div id="purchaseGoalDisplay" style="margin-top: 15px; display: none;"><p><strong>Purchase Goal (<span id="purchaseGoalName">N/A</span>):</strong> <span class="goal-status">N/A</span></p><div class="progress-bar-container"><div class="progress-bar" id="purchaseProgressBar"></div></div></div>
                    <p id="noGoalsMessage" style="display: none;" class="text-gray-500 italic">No specific savings goals identified.</p>
                 </div>
            </div>
        </div>

        <div class="grid-container"> <div class="dashboard-card chart-card">
                 <h3 class="card-header">Income Breakdown</h3>
                 <div id="incomeChart" class="chart-container-div"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div>
            </div>
            <div class="dashboard-card chart-card">
                 <h3 class="card-header">Expense Breakdown</h3>
                 <div id="expenseChart" class="chart-container-div"><p class="text-center text-gray-500 pt-10">Chart loading...</p></div>
            </div>
        </div>

        <div class="grid-container"> <div class="dashboard-card">
                <h3 class="card-header">Recommendations</h3>
                <div class="card-content"><ul id="recommendationsList"><li>Loading recommendations...</li></ul></div>
            </div>
            <div class="dashboard-card">
                <h3 class="card-header">AI Analysis Summary</h3>
                <div class="card-content">
                    <div id="aiAnalysis" class="prose prose-sm max-w-none mb-4" style="white-space: pre-wrap;">Loading analysis...</div>
                    <button onclick="openModal('progressModal')" class="text-indigo-600 hover:underline text-sm font-medium">View Full Progress History</button>
                </div>
            </div>
        </div>

        <div class="grid-container"> <div class="dashboard-card" id="debtsCard">
                 <h3 class="card-header">Debt Overview</h3>
                 <div class="card-content overflow-x-auto">
                    <table id="debtsTable">
                        <thead><tr><th>Type</th><th>Balance</th><th>Rate (%)</th><th>Min. Pmt</th></tr></thead>
                        <tbody><tr><td colspan="4" class="text-center p-4 text-gray-500">Loading debt data...</td></tr></tbody>
                    </table>
                    <p style="margin-top: 10px;"><strong>Total Debt Balance:</strong> <span id="totalDebtBalance" class="font-semibold">N/A</span></p>
                    <p><strong>Total Min. Payments:</strong> <span id="totalMinPayments" class="font-semibold">N/A</span></p>
                 </div>
            </div>
            <div class="dashboard-card">
                <h3 class="card-header">Financial Tools & Goals</h3>
                 <div class="card-content">
                    <p><strong>Financial Tools:</strong> <span id="financialTools">N/A</span></p>
                    <p><strong>Challenges:</strong> <span id="challenges">N/A</span></p>
                    <p><strong>Upcoming Purchase Goal Detail:</strong> <span id="purchaseGoals">N/A</span></p>
                 </div>
           </div>
        </div>

        <section id="chatInterfaceCard" class="dashboard-card">
            <h3 class="card-header">Ask SmartWealth AI</h3>
            <div class="chat-container">
                <div class="chat-history" id="chatHistory"></div>
                <div class="chat-status" id="chatStatus"></div>
                <div class="chat-input-area">
                    <textarea id="chatInput" placeholder="Ask about your finances..." rows="1" disabled></textarea>
                    <button id="chatSendButton" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M3.105 3.105a1.5 1.5 0 011.995-.04l8 4a1.5 1.5 0 010 2.87l-8 4a1.5 1.5 0 01-1.995-.04L1.6 13.89a1.5 1.5 0 01-.04-1.995l3-4a1.5 1.5 0 010-1.79l-3-4a1.5 1.5 0 01.04-1.995l1.5-1.5z" /></svg>
                        <span class="sr-only">Send</span>
                    </button>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm py-6 mt-4 border-t border-gray-200">
            <p>SmartWealth Navigator &copy; 2025 | Built by Socialeap™️</p>
            <p>Consult with a qualified financial advisor for personalized advice.</p>
        </footer>
    </div> <div id="progressModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('progressModal')">&times;</span>
            <h2>User Progress History</h2>
            <div id="progressContent" style="white-space: pre-wrap;">Loading history...</div>
        </div>
    </div>

<script>
    // --- Globals ---
    let dashboardData = {}; // Holds the main data object
    let chatMessages = []; // Holds chat history for API calls
    const CHAT_MODEL = 'gpt-4o-mini'; // Or your preferred model
    const plotlyConfig = { displaylogo: false, responsive: true, modeBarButtonsToRemove: ['sendDataToCloud', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d', 'hoverClosestPie', 'toggleSpikelines', 'hoverCompareCartesian'] };

    // --- Supabase Client (CONFIGURE THESE) ---
    // *** IMPORTANT: Replace placeholders with your actual Supabase credentials ***
    const SUPABASE_URL = 'https://tfnwwpksieluzvxqdiiq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbnd3cGtzaWVsdXp2eHFkaWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1ODQ3MjgsImV4cCI6MjA2MDE2MDcyOH0.xbtjiQ65vCggjj35qtlCZ0S5mJa4muSZcHXhaU4qvrE';
    let supabase = null;

    // --- Cached DOM Elements (populated by DOMContentLoaded) ---
    let loadingSpinner, errorMessageElement, mainContentElement, initialMessageElement, errorTextElement, debugInfoElement, initialUploadPrompt, fileInput;

    // --- Utility Functions ---
    function getSafe(fn, defaultVal = 'N/A') {
        try {
            const value = fn();
            return (value === null || value === undefined || String(value).trim() === '') ? defaultVal : value;
        } catch (e) { return defaultVal; }
    }
    function formatCurrency(value, hideNA = false) {
        const number = Number(value);
        if (isNaN(number)) return hideNA ? '' : 'N/A';
        return number.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function formatPercentage(value, decimals = 1) {
        const number = Number(value);
        if (isNaN(number) || !isFinite(number)) return 'N/A';
        // Multiply by 100 before formatting if the input is a decimal rate (e.g., 0.15 for 15%)
        // The calculateRatios function returns decimals, so no need to multiply here.
        return number.toLocaleString(undefined, { style: 'percent', minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    function updateElementText(id, value, formatter) {
        const element = document.getElementById(id);
        if (element) {
            const formattedValue = formatter ? formatter(value) : (value !== null && value !== undefined ? String(value) : 'N/A');
            element.textContent = formattedValue;
        } else { console.warn(`Element with ID ${id} not found for text update.`); }
    }
    function updateElementHTML(id, value) {
        const element = document.getElementById(id);
        if (element) { element.innerHTML = value; }
        else { console.warn(`Element with ID ${id} not found for HTML update.`); }
    }

    // --- Initialization (Single Entry Point) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded. Initializing...");

        // Cache key DOM elements
        loadingSpinner = document.getElementById('loadingSpinner');
        errorMessageElement = document.getElementById('errorMessage');
        mainContentElement = document.getElementById('mainContent');
        initialMessageElement = document.getElementById('initialMessage'); // Fallback message
        initialUploadPrompt = document.getElementById('initialUploadPrompt'); // New prompt section
        errorTextElement = document.getElementById('errorText');
        debugInfoElement = document.getElementById('debugInfo');
        fileInput = document.getElementById('fileInput'); // Hidden file input

        // Set initial UI state: Show spinner, hide others
        if (loadingSpinner) loadingSpinner.style.display = 'flex'; else console.error("Loading spinner not found!");
        if (errorMessageElement) errorMessageElement.style.display = 'none';
        if (mainContentElement) mainContentElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';
        if (initialUploadPrompt) initialUploadPrompt.style.display = 'none';

        try {
            // Initialize Supabase Client
            if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_URL.length < 10) {
                throw new Error("Supabase URL is not configured or is invalid in the script.");
            }
            if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY' || SUPABASE_ANON_KEY.length < 50) {
                throw new Error("Supabase Anon Key is not configured or is invalid in the script.");
            }
            if (typeof window.supabase === 'undefined' || !window.supabase?.createClient) {
                throw new Error("Supabase library (supabase-js v2) failed to load or is not available.");
            }
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized.");
            if (typeof supabase.from !== 'function' || typeof supabase.functions !== 'object') {
                 throw new Error("Supabase client object seems invalid.");
            }
            console.log("Supabase client seems functional.");

            // Setup Core Button Listeners
            document.getElementById('retryButton')?.addEventListener('click', () => location.reload());
            document.getElementById('manualEntryButton')?.addEventListener('click', useDemoData);
            initSaveButton(); // Save button in header
            initUploadButton(); // Upload button in header (and its file input listener)
            initModals(); // Modal close behavior

            // Setup listener for the button within the initial upload prompt
            const initialUploadButton = document.getElementById('initialUploadButton');
            if (initialUploadButton && fileInput) {
                initialUploadButton.addEventListener('click', () => {
                    console.log("Initial Upload Button clicked, triggering file input.");
                    fileInput.click(); // Trigger the *same* hidden file input
                });
            } else if (!initialUploadButton) {
                 console.error("Initial Upload Button (id='initialUploadButton') element not found.");
            } else if (!fileInput) {
                 console.error("File input (id='fileInput') element not found.");
            }

            // Attempt to load initial data (handles URL params, embedded data, and data=null case)
            console.log("Attempting to load initial data...");
            loadInitialData();
            console.log("Initial data load function finished.");

        } catch (error) {
            console.error("CRITICAL Error during initial setup:", error);
            handleError("Failed during initial page setup", error); // Display error using handler
        }
    });

     // --- Error Handling ---
    function handleError(message, error) {
        console.error("HANDLE ERROR TRIGGERED:", message, error);
        // Ensure elements are available (might be called before caching)
        errorTextElement = errorTextElement || document.getElementById('errorText');
        debugInfoElement = debugInfoElement || document.getElementById('debugInfo');
        loadingSpinner = loadingSpinner || document.getElementById('loadingSpinner');
        mainContentElement = mainContentElement || document.getElementById('mainContent');
        initialMessageElement = initialMessageElement || document.getElementById('initialMessage');
        initialUploadPrompt = initialUploadPrompt || document.getElementById('initialUploadPrompt');
        errorMessageElement = errorMessageElement || document.getElementById('errorMessage');

        if (errorTextElement) errorTextElement.textContent = `${message}. See details below.`;
        if (debugInfoElement) {
            debugInfoElement.innerHTML = ''; // Clear first
            debugURLParameters();
            debugInfoElement.innerHTML += `<br><strong>Error Type:</strong> ${error?.name || 'N/A'}`;
            debugInfoElement.innerHTML += `<br><strong>Error Message:</strong><br><span style="color:red;">${error?.message || 'Unknown error'}</span>`;
            if (error?.stack) debugInfoElement.innerHTML += `<br><strong>Stack Trace:</strong><br><code style="font-size:10px; white-space: pre-wrap; display: block;">${error.stack}</code>`;
        }
        // Hide everything except the error message
        if (loadingSpinner) loadingSpinner.style.display = 'none';
        if (mainContentElement) mainContentElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';
        if (initialUploadPrompt) initialUploadPrompt.style.display = 'none';
        if (errorMessageElement) errorMessageElement.style.display = 'flex'; else alert(`Critical Error: ${message}\n${error?.message}`);
        // Disable chat
        enableChatInput(false); setChatStatus("Error occurred", false);
    }

    function debugURLParameters() { /* ... (keep implementation from previous response) ... */ }
    function useDemoData() { /* ... (keep implementation from previous response) ... */ }

    // --- Data Loading (Single Definition) ---
    function loadInitialData() {
        const params = new URLSearchParams(window.location.search);
        const dataElement = document.getElementById('embeddedPsrData');
        let dataFound = false;

        // --- Check for ?data=null first ---
        if (params.has('data') && params.get('data') === 'null') {
            console.warn("URL parameter 'data=null' detected. Showing initial upload prompt.");
            // Hide spinner and other sections
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (mainContentElement) mainContentElement.style.display = 'none';
            if (errorMessageElement) errorMessageElement.style.display = 'none';
            if (initialMessageElement) initialMessageElement.style.display = 'none';
            const chatCard = document.getElementById('chatInterfaceCard');
            if (chatCard) chatCard.style.display = 'none';
            // Show the initial upload prompt
            if (initialUploadPrompt) initialUploadPrompt.style.display = 'block';
            else console.error("Initial Upload Prompt element not found!");
            return; // Stop further data loading attempts
        }

        // --- If not data=null, try other methods ---
        try {
            // Priority 1: Check for Base64 'data' parameter
            const encodedData = params.get('data');
            if (encodedData) {
                console.log("Attempting to load data from 'data' URL parameter (Base64)...");
                const jsonString = atob(decodeURIComponent(encodedData));
                const urlData = JSON.parse(jsonString);
                if (urlData?.userInput?.personalInfo) {
                    dashboardData = urlData; dataFound = true; console.log("'data' parameter decoded.");
                } else { console.warn("Decoded 'data' parameter lacks expected structure."); }
            }
            // Priority 2: Check for individual URL parameters (if no base64 data found)
            else if (!dataFound && params.toString().length > 0 && (params.has('userName') || params.has('username'))) {
                console.log("Attempting to load data from individual URL parameters...");
                const urlData = parseDataFromUrlParams(params);
                if (urlData?.userInput?.personalInfo) {
                     const hasRealData = Object.values(urlData.userInput.income || {}).some(v=>v>0) ||
                                         Object.values(urlData.userInput.expenses || {}).some(v=>v>0) ||
                                         Object.values(urlData.userInput.savings || {}).some(v=>v>0) ||
                                         (urlData.userInput.debts || []).length > 0;
                    if (hasRealData || urlData.userInput.personalInfo.userName !== 'User') {
                         dashboardData = urlData; dataFound = true; console.log("Individual parameters parsed.");
                    } else { console.warn("Parsed individual parameters resulted in only default/empty data."); }
                } else { console.warn("Parsed individual parameters lack expected structure."); }
            }

            // Priority 3: Check for embedded JSON (if still no data)
            if (!dataFound && dataElement && dataElement.textContent.trim() && dataElement.textContent.trim() !== '/* EMBEDDED_JSON_DATA_HERE */') { // Check against actual placeholder
                console.log("Attempting to load data from embedded JSON...");
                const embeddedJson = JSON.parse(dataElement.textContent);
                if (embeddedJson?.userInput?.personalInfo) {
                    dashboardData = embeddedJson; dataFound = true; console.log("Data loaded from embedded JSON.");
                } else { console.warn("Embedded content lacks expected structure."); }
            }

        } catch (error) {
             console.error("Error during data loading attempts:", error);
             handleError("Failed to load or parse data", error);
             return; // Stop processing if errors occur
        }

        // --- Final Step: Display data or fallback prompt ---
        if (dataFound && dashboardData) {
            console.log("Data found, proceeding to display.");
            if(initialUploadPrompt) initialUploadPrompt.style.display = 'none'; // Hide prompt if data loaded
            processAndDisplayData(dashboardData);
        } else {
            console.warn("No valid data loaded from any source. Displaying initial upload prompt (fallback).");
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (mainContentElement) mainContentElement.style.display = 'none';
            const isErrorVisible = errorMessageElement && getComputedStyle(errorMessageElement).display !== 'none';
            if (!isErrorVisible) { // Only show prompt if no error already visible
                if (initialUploadPrompt) initialUploadPrompt.style.display = 'block';
                else if (initialMessageElement) initialMessageElement.style.display = 'block'; // Fallback
                else console.error("Neither initial prompt nor initial message element found!");
                if (initialMessageElement) initialMessageElement.style.display = 'none'; // Hide fallback if prompt shown
            }
            const chatCard = document.getElementById('chatInterfaceCard');
            if (chatCard) chatCard.style.display = 'none';
        }
    }

    // --- Helper: Parse individual URL parameters ---
    function parseDataFromUrlParams(params) {
         const getParam = (keyBase) => { /* ... (keep implementation) ... */ };
         const parseNumeric = (value, defaultValue = 0) => { /* ... (keep implementation) ... */ };
         const decodeField = (value) => { /* ... (keep implementation) ... */ };
         // ... (Build the parsedData object as in previous examples) ...
         const fetchedUserName = decodeField(getParam('userName') || getParam('username'));
         // ... parse all other fields using getParam, parseNumeric, decodeField ...
          const fetchedCreditCardDebt = parseNumeric(getParam('creditCardDebt') || getParam('creditcard'));
          const fetchedBankLoans = parseNumeric(getParam('bankLoans') || getParam('loans'));
          const ccMinPayment = Math.max(fetchedCreditCardDebt * 0.03, 25);
          const loanMinPayment = Math.max(fetchedBankLoans * 0.015, 50);

         const parsedData = {
             userInput: {
                 personalInfo: { userName: fetchedUserName || 'User', age: parseNumeric(getParam('age'), 30) },
                 income: { mainJobIncome: parseNumeric(getParam('mainJobIncome')), secondJob: parseNumeric(getParam('secondJobIncome') || getParam('secondJob')), otherIncome: parseNumeric(getParam('otherIncome')) },
                 expenses: { housing: parseNumeric(getParam('housing')), transportation: parseNumeric(getParam('transportation')), utilities: parseNumeric(getParam('utilities')), groceriesEssentials: parseNumeric(getParam('groceries-essentials') || getParam('groceries')), insurance: parseNumeric(getParam('insurance')), medical: parseNumeric(getParam('medical')), care: parseNumeric(getParam('care')), subscriptions: parseNumeric(getParam('subscriptions')), taxes: parseNumeric(getParam('taxes')) },
                 savings: { emergency: parseNumeric(getParam('emergencySavings') || getParam('emergency')), savings: parseNumeric(getParam('currentSavings') || getParam('savings')), retirement: parseNumeric(getParam('retirementFund') || getParam('retirement')), emergencyFundTarget: parseNumeric(getParam('emergencyFundTarget')), monthlySavingsGoal: parseNumeric(getParam('monthlySavingsGoal')) },
                 debts: [ ...(fetchedCreditCardDebt > 0 ? [{ type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: parseNumeric(getParam('ccRate'), 22.5), minPayment: ccMinPayment }] : []), ...(fetchedBankLoans > 0 ? [{ type: "Bank Loans", balance: fetchedBankLoans, interestRate: parseNumeric(getParam('loanRate'), 6.5), minPayment: loanMinPayment }] : []) ],
                 financials: { financialTools: decodeField(getParam('financialTools')), challenges: decodeField(getParam('challenges')), upcomingPurchase: decodeField(getParam('upcomingPurchases')) }
             },
             aiOutput: { analysis: decodeField(getParam('aiAnalysis')) || 'Analysis not provided.', recommendations: decodeField(getParam('recommendations')) || 'Recommendations not provided.', userProgress: decodeField(getParam('userProgressHistory') || getParam('userProgress')) || 'Progress history not available.' }
         };
         return parsedData;
    }

    // --- Main Data Processing & Display (Single Definition) ---
    function processAndDisplayData(data) {
        if (!data?.userInput) { handleError("Invalid data format for processing", new Error("Data structure missing userInput.")); return; }
        console.log("--- processAndDisplayData START ---");
        dashboardData = data;
        try {
            console.log("1. Calculating totals..."); const totals = calculateTotals(data); console.log("Totals calculated:", totals);
            console.log("2. Calculating ratios..."); const ratios = calculateRatios(data, totals); console.log("Ratios calculated:", ratios);
            console.log("3. Updating basic info UI..."); updateReportBasics(data, totals); console.log("Basic info UI updated.");
            console.log("4. Updating ratios UI..."); updateRatiosDisplay(ratios); console.log("Ratios UI updated.");
            console.log("5. Updating goals UI..."); updateGoalsDisplay(data, totals); console.log("Goals UI updated.");
            console.log("6. Updating debts UI..."); updateDebtsDisplay(data, totals); console.log("Debts UI updated.");
            console.log("7. Scheduling chart rendering...");
            requestAnimationFrame(() => {
                 console.log("7a. Executing chart rendering...");
                 try { renderCharts(data); console.log("Charts rendered."); }
                 catch (chartError) { console.error("--- Error renderCharts ---", chartError); handleError("Failed to render charts", chartError); }
            });
            console.log("8. Updating AI display UI..."); updateUIDisplayFromAI(data); console.log("AI display UI updated.");
            console.log("9. Initializing chat..."); initializeChat(); console.log("Chat initialized.");
            console.log("10. Making main content visible...");
            if (errorMessageElement) errorMessageElement.style.display = 'none';
            if (initialMessageElement) initialMessageElement.style.display = 'none';
            if (initialUploadPrompt) initialUploadPrompt.style.display = 'none';
            if (mainContentElement) mainContentElement.style.display = 'block';
            console.log("Main content should now be visible.");
        } catch (processingError) {
            console.error("--- processAndDisplayData ERROR ---", processingError);
            handleError("Error processing or displaying data", processingError);
        } finally {
             console.log("Executing finally block in processAndDisplayData.");
             if (loadingSpinner) loadingSpinner.style.display = 'none'; else console.warn("Spinner element not found in finally block.");
             console.log("--- processAndDisplayData END ---");
        }
    }

    // --- Calculation Functions (Single Definitions) ---
    function calculateTotals(data) { /* ... (Keep implementation from previous response) ... */ }
    function calculateRatios(data, totals) { /* ... (Keep implementation from previous response) ... */ }

    // --- UI Update Functions (Single Definitions) ---
    function updateReportBasics(data, totals) { /* ... (Keep implementation from previous response) ... */ }
    function updateRatiosDisplay(ratios) { /* ... (Keep implementation from previous response) ... */ }
    function updateGoalsDisplay(data, totals) { /* ... (Keep implementation from previous response) ... */ }
    function updateDebtsDisplay(data, totals) { /* ... (Keep implementation from previous response) ... */ }
    function renderCharts(data) { /* ... (Keep implementation from previous response, e.g., Pie Charts) ... */ }
    function updateUIDisplayFromAI(data) { /* ... (Keep implementation from previous response) ... */ }

    // --- Chat Functionality (Single Definitions) ---
    function initializeChat() { /* ... (Keep implementation from previous response) ... */ }
    function handleChatEnterKey(event) { /* ... (Keep implementation from previous response) ... */ }
    function enableChatInput(enabled) { /* ... (Keep implementation from previous response) ... */ }
    function addMessageToChat(sender, message, isError = false) { /* ... (Keep implementation from previous response) ... */ }
    function setChatStatus(message, isLoading = false) { /* ... (Keep implementation from previous response) ... */ }
    async function sendToBackendChatFunction() { /* ... (Keep implementation from previous response) ... */ }
    function handleChatSubmit() { /* ... (Keep implementation from previous response) ... */ }

    // --- Event Handlers & Button Initializers (Single Definitions) ---
    function initSaveButton() { /* ... (Keep implementation from previous response) ... */ }
    function initUploadButton() { /* ... (Keep implementation from previous response) ... */ }
    function handleFileUpload(event) { /* ... (Keep implementation from previous response, ensure initialUploadPrompt is hidden) ... */ }

    // --- Modals (Single Definitions) ---
    function initModals() { /* ... (Keep implementation from previous response) ... */ }
    function openModal(modalId) { /* ... (Keep implementation from previous response) ... */ }
    function closeModal(modalId) { /* ... (Keep implementation from previous response) ... */ }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa; /* Slightly softer background */
            color: #374151; /* Tailwind gray-700 */
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        /* Garamond for Headers */
        h1, h2, h3, h4, .header-font {
            font-family: 'EB Garamond', serif;
            color: #111827; /* Tailwind gray-900 */
            font-weight: bold;
        }
        h1 { font-size: 1.8em; } /* Adjusted sizes */
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; color: #333; } /* Original h3 color */
        h4 { font-size: 1.1em; }

        /* Main Container */
        .main-container { /* Renamed from .container for clarity */
            max-width: 1400px; /* Wider container */
            margin: 2rem auto; /* More vertical space */
            padding: 1.5rem 2rem; /* More padding */
            background: #ffffff;
            border-radius: 12px; /* Softer corners */
            box-shadow: 0 5px 15px rgba(0,0,0,0.07); /* Subtle shadow */
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem; /* More space below header */
            padding-bottom: 1rem; /* Padding for border */
            border-bottom: 1px solid #e5e7eb; /* Tailwind gray-200 */
            flex-wrap: wrap;
        }
        header img {
            height: 72px; /* Slightly smaller logo */
            margin-right: 15px;
            border-radius: 8px;
            object-fit: contain;
        }
        header h1 {
            color: #4f46e5; /* Tailwind indigo-600 */
            margin: 0;
            flex-grow: 1;
            font-size: 2.2em; /* Larger title */
            line-height: 1.2;
        }

        /* Header Buttons */
        header button {
            margin-left: 10px;
            padding: 0.6rem 1.2rem; /* Adjusted padding */
            background-color: #4f46e5; /* Tailwind indigo-600 */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            font-family: 'Inter', sans-serif; /* Ensure consistent font */
            font-weight: 500; /* Medium weight */
        }
        header button#uploadButton { background-color: #059669; } /* Tailwind green-600 */
        header button:hover { background-color: #4338ca; } /* Darker indigo */
        header button#uploadButton:hover { background-color: #047857; } /* Darker green */
        #fileInput { display: none; }

        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px; /* Increased gap */
            margin-bottom: 25px; /* Increased gap */
        }

        /* Dashboard Cards */
        .dashboard-card { /* Renamed from .card */
            background: #fff;
            padding: 1.5rem; /* More padding */
            border-radius: 10px; /* Softer corners */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); /* Consistent subtle shadow */
            border: 1px solid #e5e7eb; /* Tailwind gray-200 border */
            display: flex;
            flex-direction: column;
            min-height: 160px; /* Min height for consistency */
        }

        /* Card Headers */
        .card-header { /* New class for consistent card headers */
            font-family: 'Inter', sans-serif; /* Match body font */
            font-size: 1.1rem;
            font-weight: 600; /* Semi-bold */
            color: #374151; /* Tailwind gray-700 */
            margin: -1.5rem -1.5rem 1.25rem -1.5rem; /* Pull header to edges */
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb; /* Separator */
            background-color: #f9fafb; /* Tailwind gray-50 */
            border-radius: 10px 10px 0 0; /* Match card radius */
        }
        /* Override default h3 within card if needed, prefer .card-header */
        .dashboard-card h3 {
             /* Inherit from .card-header or set specific styles */
             /* Example: Keeping original style if preferred over new header */
             /* color: #4CAF50; */
             /* border-bottom: 1px solid #eee; */
             /* padding-bottom: 5px; */
             /* margin-bottom: 10px; */
             /* Remove if using .card-header consistently */
             margin: 0 0 1rem 0; /* Reset margin if h3 used instead of header */
             padding: 0; border: none; background: none;
        }

        .card-content { flex-grow: 1; font-size: 0.95em; }
        .card-content p { margin-bottom: 0.6rem; }
        .card-content p strong { font-weight: 500; color: #1f2937; margin-right: 5px; } /* Tailwind gray-800 */

        /* Chart Card Specifics */
        .chart-card {
            min-height: 400px;
            overflow: hidden;
        }
        /* Wrapper div for chart itself to center placeholder text */
        .chart-container-div {
            min-height: 350px; /* Allow space for header */
            width: 100%;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Ratio Bar Styles */
        .ratio-item { margin-bottom: 12px; }
        .ratio-label { display: block; font-weight: 500; margin-bottom: 3px; font-size: 0.9em; color: #4b5563; } /* Tailwind gray-600 */
        .ratio-value { display: inline-block; margin-bottom: 5px; font-size: 1.1em; font-weight: 600; color: #1f2937; } /* Tailwind gray-800 */
        .ratio-bar-container { background-color: #e5e7eb; border-radius: 4px; overflow: hidden; height: 8px; width: 100%; }
        .ratio-bar { height: 100%; width: 0%; transition: width 0.5s ease-in-out; border-radius: 4px; }
        /* Define colors based on status (good, ok, poor/warning/high) */
        .ratio-bar.savings-rate { background-color: #ef4444; } /* Red-500 (poor) */
        .ratio-bar.savings-rate.ok { background-color: #f59e0b; } /* Amber-500 (ok) */
        .ratio-bar.savings-rate.good { background-color: #10b981; } /* Emerald-500 (good) */
        .ratio-bar.emergency-coverage { background-color: #ef4444; } /* Red-500 (poor) */
        .ratio-bar.emergency-coverage.ok { background-color: #f59e0b; } /* Amber-500 (ok) */
        .ratio-bar.emergency-coverage.good { background-color: #10b981; } /* Emerald-500 (good) */
        .ratio-bar.dti-ratio { background-color: #10b981; } /* Emerald-500 (good) */
        .ratio-bar.dti-ratio.warning { background-color: #f59e0b; } /* Amber-500 (warning) */
        .ratio-bar.dti-ratio.high { background-color: #ef4444; } /* Red-500 (high) */

        /* Debt Table Styles */
        #debtsTable { width: 100%; margin-top: 10px; border-collapse: collapse; }
        #debtsTable th, #debtsTable td { text-align: left; padding: 8px 5px; border-bottom: 1px solid #f3f4f6; /* Tailwind gray-100 */ font-size: 0.9em; }
        #debtsTable th { font-weight: 500; color: #6b7280; background-color: #f9fafb; } /* Tailwind gray-500 text, gray-50 bg */
        #debtsTable tr:last-child td { border-bottom: none; }
        #debtsTable .balance-col { text-align: right; font-weight: 500; } /* Make balance bold */

        /* Progress Bar Styles */
        .progress-bar-container { background-color: #e5e7eb; border-radius: 6px; overflow: hidden; height: 20px; margin-top: 5px; margin-bottom: 10px; }
        .progress-bar { background-color: #4f46e5; height: 100%; width: 0%; transition: width 0.5s ease-in-out; text-align: center; color: white; font-size: 0.8em; line-height: 20px; font-weight: 500; }
        .goal-status { font-weight: 500; color: #1f2937; } /* Tailwind gray-800 */

        /* Recommendations List Styles */
        #recommendationsList { list-style: none; padding-left: 0; margin-top: 10px; }
        #recommendationsList li { margin-bottom: 10px; line-height: 1.6; font-family: 'Inter', sans-serif; font-size: 0.95em; padding-left: 1.5em; position: relative; }
        #recommendationsList li::before { content: '‚úì'; color: #10b981; position: absolute; left: 0; font-weight: bold; }
        #recommendationsList li.warning::before { content: '!'; color: #f59e0b; }
        #recommendationsList li.critical::before { content: '!!'; color: #ef4444; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .close-button { color: #aaa; float: right; font-size: 32px; line-height: 1; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }

        /* Loading / Error / Initial Messages */
        /* Use Tailwind fixed positioning and flex centering for overlays */
        #loadingSpinner, #errorMessage {
             display: none; /* Hide by default */
             position: fixed;
             top: 0; left: 0;
             width: 100%; height: 100%;
             z-index: 1050; /* Ensure on top */
             background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white */
             align-items: center;
             justify-content: center;
             padding: 1rem;
         }
         /* Style for the error message box itself */
         #errorMessage > div {
             background-color: #fee2e2; /* Red-100 */
             border: 1px solid #f87171; /* Red-400 */
             color: #b91c1c; /* Red-700 */
             padding: 1.5rem;
             border-radius: 0.5rem; /* 8px */
             max-width: 600px;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             text-align: center;
         }
         #errorMessage h3 { color: #991b1b; } /* Red-800 */
         #debugInfo {
             margin-top: 1rem; margin-bottom: 1rem;
             max-height: 200px; overflow-y: auto;
             text-align: left; background-color: #f3f4f6; /* Gray-100 */
             padding: 0.75rem; border-radius: 0.375rem; /* 6px */
             border: 1px solid #d1d5db; /* Gray-300 */
             font-size: 0.75rem; /* text-xs */
             line-height: 1.2;
             color: #4b5563; /* Gray-600 */
             white-space: pre-wrap; /* Allow wrapping */
             word-break: break-all; /* Break long lines */
         }
         #debugInfo strong { color: #1f2937; } /* Gray-800 */
         #errorMessage button { /* Style retry/demo buttons */
             background-color: #dc2626; /* Red-600 */
             color: white; padding: 0.5rem 1rem;
             border: none; border-radius: 0.375rem; cursor: pointer;
             font-size: 0.875rem; margin: 0 0.5rem;
             transition: background-color 0.2s;
         }
          #errorMessage button:hover { background-color: #b91c1c; } /* Red-700 */
          #errorMessage button.secondary-button { background-color: #d1d5db; color: #374151; }
          #errorMessage button.secondary-button:hover { background-color: #9ca3af; }

        <div id="initialUploadPrompt" style="display: none; text-align: center; padding: 60px 20px;">
        <div class="main-container" style="max-width: 600px; margin: auto;"> <h2 class="header-font text-2xl mb-4 text-gray-700">Welcome to SmartWealth Navigator</h2>
             <p class="text-gray-600 mb-6">
                 üìÇ Please upload your saved PSR file to view your dashboard.
             </p>
             <button id="initialUploadButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 ease-in-out">
                 Upload PSR
             </button>
             <p class="text-sm text-gray-500 mt-4">
                 (If you haven't generated a report yet, please complete the initial form first.)
             </p>
        </div>
    </div>

    <div id="initialMessage" style="display: none;">
         Upload a PSR JSON file or  parameter to view your dashboard.
    </div>


<script>
   </div> <div id="progressModal" class="modal">
        </div>

  

         #initialMessage {
             display: none; /* Hide by default */
             text-align: center; padding: 40px;
             font-size: 1.2em; color: #555;
         }

         #mainContent.hidden { display: none; }
         #mainContent { display: none; } /* Start hidden, JS will show */

        /* Chat Interface Card */
        #chatInterfaceCard { display: none; } /* Hide by default */

        /* Chat Styles */
        #chatInterfaceCard {
            /* background: linear-gradient(135deg, #f9fafb 0%, #eef2ff 100%); */ /* Example gradient */
            /* border: 1px solid #e0e7ff; */
            grid-column: 1 / -1; /* Make chat span full width if needed */
        }
        .chat-container {
            display: flex; flex-direction: column; height: 550px; /* Fixed height */
            border: 1px solid #d1d5db; border-radius: 10px; overflow: hidden;
            background-color: #ffffff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }
        .chat-history {
            flex-grow: 1; padding: 1.5rem; overflow-y: auto;
            scrollbar-width: thin; scrollbar-color: #d1d5db transparent; /* Firefox */
        }
        /* Webkit Scrollbar Styles */
        .chat-history::-webkit-scrollbar { width: 8px; }
        .chat-history::-webkit-scrollbar-track { background: transparent; }
        .chat-history::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        .chat-history::-webkit-scrollbar-thumb:hover { background-color: #9ca3af; }

        .chat-message { margin-bottom: 1.25rem; line-height: 1.6; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.assistant { justify-content: flex-start; }
        .message-bubble {
             border-radius: 18px; padding: 0.8rem 1.1rem; max-width: 75%;
             box-shadow: 0 2px 4px rgba(0,0,0,0.05); word-wrap: break-word;
        }
        .chat-message.user .message-bubble {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white;
            border-radius: 18px 18px 4px 18px; /* User bubble shape */
        }
        .chat-message.assistant .message-bubble {
            background-color: #eef2ff; /* Light indigo */ color: #374151;
            border: 1px solid #e0e7ff; border-radius: 18px 18px 18px 4px; /* Assistant bubble shape */
        }
        .chat-message.system .message-bubble { /* System message style */
            background-color: #f3f4f6; color: #6b7280; font-size: 0.85em;
            text-align: center; max-width: 100%; border-radius: 8px;
            padding: 0.5rem 1rem; border: 1px solid #e5e7eb;
            box-shadow: none;
        }
        .chat-message.system { justify-content: center; margin: 0.5rem 0; }


        .message-sender { display: none; } /* Simplify - bubbles indicate sender */

        /* Chat Status & Input */
        .chat-status {
            font-size: 0.8rem; color: #6b7280; padding: 0.5rem 1rem;
            text-align: center; height: 25px; /* Fixed height */
            background-color: #f9fafb; border-top: 1px solid #e5e7eb;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .typing-indicator { display: inline-block; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: #9ca3af; border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); }
        }

        .chat-input-area {
            border-top: 1px solid #e5e7eb; padding: 0.75rem 1rem;
            background-color: #f9fafb; display: flex; align-items: center; gap: 0.75rem;
        }
        .chat-input-area textarea {
            flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid #d1d5db;
            border-radius: 20px; resize: none; font-size: 0.95rem; line-height: 1.4;
            height: 44px; background-color: white;
            transition: border-color 0.2s ease, box-shadow 0.2s ease; outline: none;
        }
        .chat-input-area textarea:focus {
            border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .chat-input-area button {
            padding: 0.6rem 1rem; white-space: nowrap; flex-shrink: 0;
            border-radius: 20px; /* Match textarea */
            background-color: #4f46e5; color: white; border: none; cursor: pointer;
            transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .chat-input-area button:hover { background-color: #4338ca; }
        .chat-input-area button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .chat-input-area button svg { width: 1.25rem; height: 1.25rem; } /* Adjust icon size */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        /* Responsive */
        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; }
            header h1 { margin-top: 10px; font-size: 1.8em; }
            header button { margin-left: 0; margin-top: 10px; }
            .grid-container { grid-template-columns: 1fr; }
            .main-container { margin: 1rem; padding: 1rem; }
        }
    </style>
</head>
    
<body>
    <pre id="embeddedPsrData" style="display: none;">/* EMBEDDED_JSON_DATA_HERE */</pre>

    <div id="loadingSpinner"> <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-700 text-lg">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="errorMessage"> <div> <h3 class="font-bold text-xl mb-3 header-font">Error Loading Dashboard</h3>
            <p id="errorText" class="mb-4">An error occurred.</p>
            <div id="debugInfo" class="mb-4 text-xs">Debug info will appear here...</div>
            <div class="flex justify-center space-x-3 mt-4">
                <button id="retryButton" class="action-button">Retry Loading</button>
                <button id="manualEntryButton" class="secondary-button">Use Demo Data</button>
            </div>
        </div>
    </div>

    
<div id="initialUploadPrompt" style="display: none; text-align: center; padding: 60px 20px;">
        <div class="main-container" style="max-width: 600px; margin: auto;"> <h2 class="header-font text-2xl mb-4 text-gray-700">Welcome to SmartWealth Navigator</h2>
             <p class="text-gray-600 mb-6">
                 No financial data was detected. Please upload your saved Financial Report (PSR JSON) file to view your dashboard.
             </p>
             <button id="initialUploadButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 ease-in-out">
                 Upload Report File (.json)
             </button>
             <p class="text-sm text-gray-500 mt-4">
                 (If you haven't generated a report yet, please complete the initial form first.)
             </p>
        </div>
    </div>

    <div id="mainContent" class="main-container"> <header>
             <img src="https://static.wixstatic.com/media/c3283f_a9271d9818ba414994d98950da749489~mv2.jpg" alt="SmartWealth Navigator Logo">
            <h1>SmartWealth Navigator</h1> <input type="file" id="fileInput" accept=".json"> <button id="uploadButton">Upload PSR</button>
            <button id="saveButton">Download PSR</button>
        </header>

        <div class="grid-container">
            <div class="dashboard-card">
                <h3 class="card-header">Quick Summary</h3>
                <div class="card-content">
                    <p><strong>User:</strong> <span id="userName">N/A</span></p>
                    <p><strong>Age:</strong> <span id="age">N/A</span></p>
                    <p><strong>Total Monthly Income:</strong> <span id="totalIncome">N/A</span></p>
                    <p><strong>Total Monthly Expenses:</strong> <span id="totalExpenses">N/A</span></p>
                    <p><strong>Monthly Net Flow:</strong> <span id="netFlow">N/A</span></p>
                </div>
            </div>
            <div class="dashboard-card" id="ratiosCard">
                <h3 class="card-header">Key Financial Ratios</h3>
                <div class="card-content">
                    <div class="ratio-item">
                        <span class="ratio-label">Savings Rate</span>
                        <span class="ratio-value" id="savingsRateValue">N/A</span>
                        <div class="ratio-bar-container"><div class="ratio-bar savings-rate" id="savingsRateBar"></div></div>
                    </div>
                    <div class="ratio-item">
                        <span class="ratio-label">Emergency Fund Coverage</span>
                        <span class="ratio-value" id="emergencyCoverageValue">N/A</span>
                        <div class="ratio-bar-container"><div class="ratio-bar emergency-coverage" id="emergencyCoverageBar"></div></div>
                    </div>
                    <div class="ratio-item">
                        <span class="ratio-label">Debt-to-Income (DTI)</span>
                        <span class="ratio-value" id="dtiRatioValue">N/A</span>
                        <div class="ratio-bar-container"><div class="ratio-bar dti-ratio" id="dtiRatioBar"></div></div>
                        <p style="font-size: 0.8em; color: #666;">(Using min. payments)</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <div class="dashboard-card">
                 <h3 class="card-header">Savings Overview</h3>
                 <div class="card-content">
                    <p><strong>Emergency Savings:</strong> <span id="emergencySavings">N/A</span></p>
                    <p><strong>General Savings:</strong> <span id="currentSavings">N/A</span></p>
                    <p><strong>Retirement Fund:</strong> <span id="retirementFund">N/A</span></p>
                 </div>
            </div>
            <div class="dashboard-card" id="goalsCard">
                 <h3 class="card-header">Savings Goals Progress</h3>
                 <div class="card-content">
                    <div id="emergencyGoalDisplay" style="display: none;"> <p><strong>Emergency Fund Goal:</strong> <span class="goal-status">N/A</span></p>
                        <div class="progress-bar-container"><div class="progress-bar" id="emergencyProgressBar"></div></div>
                    </div>
                    <div id="purchaseGoalDisplay" style="margin-top: 15px; display: none;"> <p><strong>Purchase Goal (<span id="purchaseGoalName">N/A</span>):</strong> <span class="goal-status">N/A</span></p>
                        <div class="progress-bar-container"><div class="progress-bar" id="purchaseProgressBar"></div></div>
                    </div>
                    <p id="noGoalsMessage" style="display: none;" class="text-gray-500 italic">
                        No specific savings goals identified.
                    </p>
                 </div>
            </div>
        </div>

        <div class="grid-container">
            <div class="dashboard-card chart-card">
                 <h3 class="card-header">Income Breakdown</h3>
                 <div id="incomeChart" class="chart-container-div">
                    <p class="text-center text-gray-500 pt-10">Chart loading...</p>
                 </div>
            </div>
            <div class="dashboard-card chart-card">
                 <h3 class="card-header">Expense Breakdown</h3>
                 <div id="expenseChart" class="chart-container-div">
                     <p class="text-center text-gray-500 pt-10">Chart loading...</p>
                 </div>
            </div>
        </div>

        <div class="grid-container">
            <div class="dashboard-card">
                <h3 class="card-header">Recommendations</h3>
                <div class="card-content">
                    <ul id="recommendationsList">
                        <li>Loading recommendations...</li>
                    </ul>
                </div>
            </div>
            <div class="dashboard-card">
                <h3 class="card-header">AI Analysis Summary</h3>
                <div class="card-content">
                    <div id="aiAnalysis" class="prose prose-sm max-w-none mb-4" style="white-space: pre-wrap;">
                        Loading analysis...
                    </div>
                    <button onclick="openModal('progressModal')" class="text-indigo-600 hover:underline text-sm font-medium">
                         View Full Progress History
                     </button>
                </div>
            </div>
        </div>

        <div class="grid-container">
            <div class="dashboard-card" id="debtsCard">
                 <h3 class="card-header">Debt Overview</h3>
                 <div class="card-content overflow-x-auto"> <table id="debtsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Balance</th>
                                <th>Rate (%)</th>
                                <th>Min. Pmt</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr><td colspan="4" class="text-center p-4 text-gray-500">Loading debt data...</td></tr>
                        </tbody>
                    </table>
                    <p style="margin-top: 10px;"><strong>Total Debt Balance:</strong> <span id="totalDebtBalance" class="font-semibold">N/A</span></p>
                    <p><strong>Total Min. Payments:</strong> <span id="totalMinPayments" class="font-semibold">N/A</span></p>
                 </div>
            </div>
            <div class="dashboard-card">
                <h3 class="card-header">Financial Tools & Goals</h3>
                 <div class="card-content">
                    <p><strong>Financial Tools:</strong> <span id="financialTools">N/A</span></p>
                    <p><strong>Challenges:</strong> <span id="challenges">N/A</span></p>
                    <p><strong>Upcoming Purchase Goal Detail:</strong> <span id="purchaseGoals">N/A</span></p>
                 </div>
           </div>
        </div>

        <section id="chatInterfaceCard" class="dashboard-card"> <h3 class="card-header">Ask SmartWealth AI</h3>
            <div class="chat-container">
                <div class="chat-history" id="chatHistory">
                    </div>
                <div class="chat-status" id="chatStatus"></div>
                <div class="chat-input-area">
                    <textarea id="chatInput" placeholder="Ask about your finances..." rows="1" disabled></textarea>
                    <button id="chatSendButton" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path d="M3.105 3.105a1.5 1.5 0 011.995-.04l8 4a1.5 1.5 0 010 2.87l-8 4a1.5 1.5 0 01-1.995-.04L1.6 13.89a1.5 1.5 0 01-.04-1.995l3-4a1.5 1.5 0 010-1.79l-3-4a1.5 1.5 0 01.04-1.995l1.5-1.5z" />
                        </svg>
                        <span class="sr-only">Send</span>
                    </button>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm py-6 mt-4 border-t border-gray-200">
            <p>SmartWealth Navigator &copy; 2025 | Built by Socialeap‚Ñ¢Ô∏è</p>
            <p>Consult with a qualified financial advisor for personalized advice.</p>
        </footer>
    </div> <div id="progressModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('progressModal')">&times;</span>
            <h2>User Progress History</h2>
            <div id="progressContent" style="white-space: pre-wrap;">Loading history...</div>
        </div>
    </div>

<script>
    // --- Globals ---
    let dashboardData = {}; // Holds the main data object
    let chatMessages = []; // Holds chat history for API calls
    const CHAT_MODEL = 'gpt-4o-mini'; // Or your preferred model
    const plotlyConfig = { displaylogo: false, modeBarButtonsToRemove: ['sendDataToCloud', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d', 'hoverClosestPie', 'toggleSpikelines', 'hoverCompareCartesian'] };

    // --- Supabase Client (CONFIGURE THESE) ---
    const SUPABASE_URL = 'https://tfnwwpksieluzvxqdiiq.supabase.co'; // *** REPLACE WITH YOUR ACTUAL SUPABASE URL ***
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbnd3cGtzaWVsdXp2eHFkaWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1ODQ3MjgsImV4cCI6MjA2MDE2MDcyOH0.xbtjiQ65vCggjj35qtlCZ0S5mJa4muSZcHXhaU4qvrE'; // *** REPLACE WITH YOUR ACTUAL SUPABASE ANON KEY ***
    let supabase = null;

    // --- Cached DOM Elements ---
    // Cached in DOMContentLoaded for efficiency
    let loadingSpinner, errorMessageElement, mainContentElement, initialMessageElement, errorTextElement, debugInfoElement;

    // --- Utility Functions ---
    function getSafe(fn, defaultVal = 'N/A') {
        try {
            const value = fn();
            // More robust check for empty/null/undefined
            return (value === null || value === undefined || String(value).trim() === '') ? defaultVal : value;
        } catch (e) {
            // console.warn("getSafe caught error:", e); // Optional: log errors in getSafe
            return defaultVal;
        }
    }
    function formatCurrency(value, hideNA = false) {
        const number = Number(value);
        if (isNaN(number)) return hideNA ? '' : 'N/A';
        return number.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function formatPercentage(value, decimals = 1) {
        const number = Number(value);
        if (isNaN(number) || !isFinite(number)) return 'N/A';
        return number.toLocaleString(undefined, { style: 'percent', minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    function updateElementText(id, value, formatter) {
        const element = document.getElementById(id);
        if (element) {
            const formattedValue = formatter ? formatter(value) : (value !== null && value !== undefined ? String(value) : 'N/A');
            element.textContent = formattedValue;
        } else {
            console.warn(`Element with ID ${id} not found for text update.`);
        }
    }
    function updateElementHTML(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = value; // Use innerHTML carefully - ensure value is trusted or sanitized
        } else {
            console.warn(`Element with ID ${id} not found for HTML update.`);
        }
    }

  // --- CORRECT Initialization (Ensure this is the ONLY DOMContentLoaded listener) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded. Initializing...");

        // --- 1. Cache Elements ---
        loadingSpinner = document.getElementById('loadingSpinner');
        errorMessageElement = document.getElementById('errorMessage');
        mainContentElement = document.getElementById('mainContent');
        initialMessageElement = document.getElementById('initialMessage');
        initialUploadPrompt = document.getElementById('initialUploadPrompt');
        errorTextElement = document.getElementById('errorText');
        debugInfoElement = document.getElementById('debugInfo');
        fileInput = document.getElementById('fileInput');

        // --- 2. Set Initial UI State ---
        if (loadingSpinner) loadingSpinner.style.display = 'flex'; else console.error("Loading spinner not found!");
        if (errorMessageElement) errorMessageElement.style.display = 'none';
        if (mainContentElement) mainContentElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';
        if (initialUploadPrompt) initialUploadPrompt.style.display = 'none';

        // --- 3. Check for data=null URL parameter ---
        const params = new URLSearchParams(window.location.search);
        if (params.has('data') && params.get('data') === 'null') {
            console.warn("URL parameter 'data=null' detected. Showing initial upload prompt and skipping normal init.");
            // Hide spinner and other sections
            if(loadingSpinner) loadingSpinner.style.display = 'none';
            if(mainContentElement) mainContentElement.style.display = 'none';
            if(errorMessageElement) errorMessageElement.style.display = 'none';
            if(initialMessageElement) initialMessageElement.style.display = 'none';
            const chatCard = document.getElementById('chatInterfaceCard');
            if (chatCard) chatCard.style.display = 'none';

            // Show the initial upload prompt
            if (initialUploadPrompt) {
                initialUploadPrompt.style.display = 'block';
                // Add the button listener here
                const initialUploadButton = document.getElementById('initialUploadButton');
                if (initialUploadButton && fileInput) {
                     initialUploadButton.addEventListener('click', () => { fileInput.click(); });
                     console.log("Listener added to initial upload button (data=null case).");
                 } else { console.error("Initial upload button or fileInput element not found for data=null case."); }
            } else { console.error("Initial Upload Prompt element (#initialUploadPrompt) not found in HTML!"); }
            // *** IMPORTANT: Stop further initialization ***
            return;
        }
        // --- End check for data=null ---

        // --- 4. If data=null was NOT found, proceed with normal setup ---
        console.log("Proceeding with normal initialization...");
        try {
            // Initialize Supabase (Make sure URL/Key are set above)
            if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_URL.length < 10) { throw new Error("Supabase URL is not configured or is invalid."); }
            if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY' || SUPABASE_ANON_KEY.length < 50) { throw new Error("Supabase Anon Key is not configured or is invalid."); }
            if (typeof window.supabase === 'undefined' || !window.supabase?.createClient) { throw new Error("Supabase library failed to load."); }
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized.");
            if (typeof supabase.from !== 'function' || typeof supabase.functions !== 'object') { throw new Error("Supabase client seems invalid."); }
            console.log("Supabase client seems functional.");

            // Setup Core Button Listeners
            document.getElementById('retryButton')?.addEventListener('click', () => location.reload());
            document.getElementById('manualEntryButton')?.addEventListener('click', useDemoData);
            initSaveButton();
            initUploadButton(); // Sets up header upload button AND fileInput listener
            initModals();

            // Setup listener for the initial upload button (needed for normal flow too)
             const initialUploadButton = document.getElementById('initialUploadButton');
             if (initialUploadButton && fileInput) {
                 initialUploadButton.addEventListener('click', () => { fileInput.click(); });
             }

            console.log("Buttons and modals initialized.");

            // --- Call your main initialization/data loading function ---
            // Check your code: Is the function called 'init' or 'loadInitialData'?
            // Replace 'init' below if your function has a different name.
            if (typeof init === 'function') {
                 console.log("Calling init() function...");
                 init(); // <<< CALL YOUR MAIN FUNCTION HERE
            } else {
                 console.error("Function 'init' not found! Check your function definitions.");
                 throw new Error("Required function 'init' is not defined.");
            }
            console.log("Main init function called.");

        } catch (error) {
            console.error("CRITICAL Error during initial setup:", error);
            handleError("Failed during initial page setup", error);
        }
    }); // --- End of the SINGLE DOMContentLoaded listener ---
     
    // --- Debugging & Error Handling ---
    function debugURLParameters() {
        if (!debugInfoElement) return; // Check if element exists
        const params = new URLSearchParams(window.location.search);
        let paramsText = '<strong>URL Params:</strong><br>';
        if (params.toString() === '') {
            paramsText += '<span style="color:gray;">None</span><br>';
        } else {
            paramsText += '<table style="width:100%; font-size:10px; border-collapse: collapse;"><thead><tr style="background:#eee;"><th style="border:1px solid #ccc; padding: 2px;">Param</th><th style="border:1px solid #ccc; padding: 2px;">Value</th></tr></thead><tbody>';
            for (const [key, value] of params.entries()) {
                paramsText += `<tr><td style="border:1px solid #ccc; padding: 2px; word-break:break-all;">${key}</td><td style="border:1px solid #ccc; padding: 2px; word-break:break-all;">${value || '<i style="color:gray;">(empty)</i>'}</td></tr>`;
            }
            paramsText += '</tbody></table>';
        }
        // Append to existing debug info safely
         const currentDebugHTML = debugInfoElement.innerHTML;
         debugInfoElement.innerHTML = paramsText + '<hr style="margin: 5px 0;">' + currentDebugHTML.replace(/^<strong>URL Params:.*?<hr style="margin: 5px 0;">/s, ''); // Replace previous params if any
    }

    function handleError(message, error) {
        console.error("HANDLE ERROR TRIGGERED:", message, error);

        // Ensure elements exist before manipulating
        errorTextElement = errorTextElement || document.getElementById('errorText');
        debugInfoElement = debugInfoElement || document.getElementById('debugInfo');
        loadingSpinner = loadingSpinner || document.getElementById('loadingSpinner');
        mainContentElement = mainContentElement || document.getElementById('mainContent');
        initialMessageElement = initialMessageElement || document.getElementById('initialMessage');
        errorMessageElement = errorMessageElement || document.getElementById('errorMessage');

        // Populate error details
        if (errorTextElement) {
            errorTextElement.textContent = `${message}. See details below.`;
        } else {
            console.error("Error text element not found!");
        }
        if (debugInfoElement) {
            debugInfoElement.innerHTML = ''; // Clear previous debug info first
            debugURLParameters(); // Add URL parameters
            debugInfoElement.innerHTML += `<br><strong>Error Type:</strong> ${error?.name || 'N/A'}`;
            debugInfoElement.innerHTML += `<br><strong>Error Message:</strong><br><span style="color:red;">${error?.message || 'Unknown error'}</span>`;
            if (error?.stack) {
                debugInfoElement.innerHTML += `<br><strong>Stack Trace:</strong><br><code style="font-size:10px; white-space: pre-wrap; display: block;">${error.stack}</code>`;
            }
        } else {
            console.error("Debug info element not found!");
        }

        // Manage UI visibility
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
            console.log("Spinner hidden by handleError.");
        } else {
            console.error("Loading spinner not found in handleError!");
        }
        if (mainContentElement) mainContentElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';

        if (errorMessageElement) {
            errorMessageElement.style.display = 'flex'; // Use flex for centering
            console.log("Error message shown by handleError.");
        } else {
            console.error("Error message element not found!");
            alert(`Critical Error: ${message}\n${error?.message}`); // Fallback alert
        }
        // Disable chat on error
        enableChatInput(false);
        setChatStatus("Error occurred", false);
    }

    // --- Demo Data ---
    function useDemoData() {
        console.log("Using Demo Data");
        // A more complete demo data structure matching potential real data
        const demoData = {
            userInput: {
                personalInfo: { userName: "Demo User", age: 35 },
                income: { mainJobIncome: 5500, secondJob: 1200, otherIncome: 300 },
                expenses: { housing: 1800, utilities: 250, transportation: 450, groceriesEssentials: 600, insurance: 350, medical: 150, care: 100, subscriptions: 80, taxes: 1100 },
                savings: { emergency: 8000, savings: 15000, retirement: 75000, emergencyFundTarget: 15000, monthlySavingsGoal: 500 }, // Added monthly goal
                debts: [
                    { type: "Credit Card", balance: 4500, interestRate: 22.5, minPayment: 150 },
                    { type: "Student Loan", balance: 25000, interestRate: 5.5, minPayment: 280 },
                    { type: "Car Loan", balance: 12000, interestRate: 6.5, minPayment: 300 }
                ],
                financials: {
                    financialTools: "Budgeting App (YNAB), Credit Monitor (Credit Karma)",
                    challenges: "Saving consistently for down payment, Reducing high-interest CC debt",
                    upcomingPurchase: "#1) House Down Payment, $25000, 24 months"
                    // Example structure if goals were more detailed:
                    // purchaseGoalTarget: 25000,
                    // purchaseGoalSaved: 15000,
                }
            },
            aiOutput: {
                analysis: "Cash flow is positive ($1120/month). Emergency fund covers ~2 months of core expenses (target is 3-6). High DTI ratio (31%) primarily due to student/car loans, but CC debt is high interest. Good retirement savings.",
                recommendations: "- Prioritize paying off the 22.5% interest credit card.\n- Aim to increase emergency fund to $10,000 (3 months expenses).\n- Continue consistent retirement contributions.\n- Review subscription expenses for potential savings.",
                userProgress: "2024-12-01: Initial report generated.\n2025-03-15: Credit card balance reduced by $500. Emergency fund increased by $1000."
            }
        };
        dashboardData = demoData; // Set global data
        console.log("Rendering demo data...");
        // Ensure error message is hidden before processing
        if (errorMessageElement) errorMessageElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';
        processAndDisplayData(dashboardData); // Process the demo data
    }

    // --- Data Loading Logic ---
    function loadInitialData() {
        const params = new URLSearchParams(window.location.search);
        const dataElement = document.getElementById('embeddedPsrData');
        let dataFound = false;

        // Priority 1: Check for data in URL parameters (e.g., from Jotform redirect)
        if (params.toString().length > 0 && (params.has('userName') || params.has('username') || params.has('data'))) { // Added 'data' param check
            console.log("Attempting to load data from URL parameters...");
            try {
                 let urlData;
                 // Check for base64 encoded 'data' parameter first
                 const encodedData = params.get('data');
                 if (encodedData) {
                     console.log("Decoding 'data' parameter from URL...");
                     const jsonString = atob(decodeURIComponent(encodedData)); // Decode base64
                     urlData = JSON.parse(jsonString);
                     console.log("'data' parameter decoded and parsed successfully.");
                 } else {
                     // Fallback to parsing individual parameters if 'data' not present
                     console.log("Parsing individual parameters from URL...");
                     urlData = parseDataFromUrlParams(params); // Use helper function
                     console.log("Individual parameters parsed successfully.");
                 }

                // Validate parsed data structure (basic check)
                if (urlData && urlData.userInput && urlData.userInput.personalInfo) {
                    dashboardData = urlData;
                    dataFound = true;
                    console.log("Data loaded successfully from URL.");
                } else {
                     console.warn("Data parsed from URL lacks expected structure (userInput/personalInfo).");
                }
            } catch (err) {
                console.error("Error processing data from URL:", err);
                handleError("Failed to load data from URL", err);
                return; // Stop further processing if URL data fails
            }
        }

        // Priority 2: Check for embedded JSON (if not loaded from URL)
        if (!dataFound && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
            console.log("Attempting to load data from embedded JSON...");
            try {
                const embeddedJson = JSON.parse(dataElement.textContent);
                // Validate structure
                if (typeof embeddedJson === 'object' && embeddedJson !== null && embeddedJson.userInput && embeddedJson.userInput.personalInfo) {
                    dashboardData = embeddedJson;
                    dataFound = true;
                    console.log("Data loaded successfully from embedded JSON.");
                } else {
                    console.warn("Embedded content is not valid JSON or lacks expected structure.");
                }
            } catch (jsonErr) {
                console.error("Error parsing embedded JSON:", jsonErr);
                // Don't necessarily stop everything, but log it. Maybe show initial message later.
                 if (debugInfoElement) {
                     debugInfoElement.innerHTML += `<br><strong>Embedded JSON Parse Error:</strong> ${jsonErr.message}`;
                 }
            }
        }

        // Process data if found, otherwise show initial message
        if (dataFound && dashboardData) {
            console.log("Data found, proceeding to display.");
            processAndDisplayData(dashboardData);
        } else {
            console.warn("No valid data loaded from URL or embedded JSON. Displaying initial message.");
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (mainContentElement) mainContentElement.style.display = 'none';
            if (errorMessageElement && errorMessageElement.style.display !== 'flex') { // Don't overwrite existing error
                 if (initialMessageElement) initialMessageElement.style.display = 'block';
            }
            if (document.getElementById('chatInterfaceCard')) {
                 document.getElementById('chatInterfaceCard').style.display = 'none'; // Hide chat if no data
            }
        }
    }

    // Helper to parse data from individual URL parameters
    function parseDataFromUrlParams(params) {
         // Using getSafe to handle potentially missing parameters gracefully
         const getParam = (keyBase) => {
             const keyBaseLower = keyBase.toLowerCase();
             for (const currentKey of params.keys()) {
                 const currentKeyLower = currentKey.toLowerCase();
                 if (currentKeyLower === keyBaseLower || currentKeyLower.endsWith(keyBaseLower)) { // Simple check
                     return params.get(currentKey);
                 }
             }
             return null; // Return null if not found
         };
        const parseNumeric = (value, defaultValue = 0) => {
             if (value === null || typeof value === 'undefined' || String(value).trim() === '') { return defaultValue; }
             if (typeof value === 'number') { return isNaN(value) ? defaultValue : value; }
             const cleaned = String(value).trim().replace(/[^0-9.-]+/g, '');
             if (cleaned === '' || cleaned === '-' || cleaned === '.') { return defaultValue; }
             const number = parseFloat(cleaned);
             return isNaN(number) ? defaultValue : number;
         };
         const decodeField = (value) => {
            if (!value) return '';
            try { return decodeURIComponent(value.replace(/\+/g, ' ')); } // Also handle '+' encoding
            catch (e) { console.warn(`Decode URI fail`, e); return value; }
        };

         // --- Build the data structure ---
        const fetchedUserName = decodeField(getParam('userName') || getParam('username'));
        const fetchedAge = parseNumeric(getParam('age'));
        const fetchedCreditCardDebt = parseNumeric(getParam('creditCardDebt') || getParam('creditcard'));
        const fetchedBankLoans = parseNumeric(getParam('bankLoans') || getParam('loans'));
        // Estimate min payments (can be refined)
        const ccMinPayment = Math.max(fetchedCreditCardDebt * 0.03, 25);
        const loanMinPayment = Math.max(fetchedBankLoans * 0.015, 50); // Example

         const parsedData = {
             userInput: {
                 personalInfo: {
                     userName: fetchedUserName || 'User', // Default
                     age: fetchedAge || 30 // Default
                 },
                 income: {
                     mainJobIncome: parseNumeric(getParam('mainJobIncome')),
                     secondJob: parseNumeric(getParam('secondJobIncome') || getParam('secondJob')),
                     otherIncome: parseNumeric(getParam('otherIncome'))
                 },
                 expenses: {
                    housing: parseNumeric(getParam('housing')),
                    transportation: parseNumeric(getParam('transportation')),
                    utilities: parseNumeric(getParam('utilities')),
                    groceriesEssentials: parseNumeric(getParam('groceries-essentials') || getParam('groceries')),
                    insurance: parseNumeric(getParam('insurance')),
                    medical: parseNumeric(getParam('medical')),
                    care: parseNumeric(getParam('care')),
                    subscriptions: parseNumeric(getParam('subscriptions')),
                    taxes: parseNumeric(getParam('taxes'))
                 },
                 savings: {
                     emergency: parseNumeric(getParam('emergencySavings') || getParam('emergency')),
                     savings: parseNumeric(getParam('currentSavings') || getParam('savings')),
                     retirement: parseNumeric(getParam('retirementFund') || getParam('retirement')),
                     emergencyFundTarget: parseNumeric(getParam('emergencyFundTarget')), // Allow specifying target
                     monthlySavingsGoal: parseNumeric(getParam('monthlySavingsGoal')) // Allow specifying goal
                 },
                 debts: [
                     ...(fetchedCreditCardDebt > 0 ? [{ type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: parseNumeric(getParam('ccRate'), 22.5), minPayment: ccMinPayment }] : []),
                     ...(fetchedBankLoans > 0 ? [{ type: "Bank Loans", balance: fetchedBankLoans, interestRate: parseNumeric(getParam('loanRate'), 6.5), minPayment: loanMinPayment }] : [])
                      // Add more debt types if needed, parsing their params
                 ],
                 financials: {
                    financialTools: decodeField(getParam('financialTools')),
                    challenges: decodeField(getParam('challenges')),
                    upcomingPurchase: decodeField(getParam('upcomingPurchases'))
                    // Add purchase goal details if separate params exist:
                    // purchaseGoalTarget: parseNumeric(getParam('purchaseGoalTarget')),
                    // purchaseGoalSaved: parseNumeric(getParam('purchaseGoalSaved')),
                 }
             },
             // Attempt to parse AI output from params too, if provided separately
              aiOutput: {
                  analysis: decodeField(getParam('aiAnalysis')),
                  recommendations: decodeField(getParam('recommendations')),
                  userProgress: decodeField(getParam('userProgressHistory') || getParam('userProgress'))
              }
         };
        // Clean up empty strings in aiOutput
        if (!parsedData.aiOutput.analysis) parsedData.aiOutput.analysis = 'Analysis not provided.';
        if (!parsedData.aiOutput.recommendations) parsedData.aiOutput.recommendations = 'Recommendations not provided.';
        if (!parsedData.aiOutput.userProgress) parsedData.aiOutput.userProgress = 'Progress history not available.';

        return parsedData;
    }


    // --- Main Data Processing & Display Function ---
    function processAndDisplayData(data) {
        if (!data || typeof data !== 'object' || !data.userInput) {
            console.error("Invalid data received by processAndDisplayData", data);
            handleError("Invalid data format for processing", new Error("Data structure is missing userInput."));
            return;
        }
        console.log("--- processAndDisplayData START ---");
        dashboardData = data; // Update global reference

        try {
            console.log("1. Calculating totals...");
            const totals = calculateTotals(data);
            console.log("Totals calculated:", totals);

            console.log("2. Calculating ratios...");
            const ratios = calculateRatios(data, totals);
            console.log("Ratios calculated:", ratios);

            console.log("3. Updating basic info UI...");
            updateReportBasics(data, totals);
            console.log("Basic info UI updated.");

            console.log("4. Updating ratios UI...");
            updateRatiosDisplay(ratios);
            console.log("Ratios UI updated.");

            console.log("5. Updating goals UI...");
            updateGoalsDisplay(data, totals);
            console.log("Goals UI updated.");

            console.log("6. Updating debts UI...");
            updateDebtsDisplay(data, totals);
            console.log("Debts UI updated.");

            console.log("7. Scheduling chart rendering...");
            requestAnimationFrame(() => {
                 console.log("7a. Executing chart rendering (inside requestAnimationFrame)...");
                 try {
                    renderCharts(data);
                    console.log("Charts rendered successfully.");
                 } catch (chartError) {
                     console.error("--- Error during renderCharts ---", chartError);
                     handleError("Failed to render charts", chartError);
                     // Show specific error messages in chart divs
                      if(document.getElementById('incomeChart')) document.getElementById('incomeChart').innerHTML = '<p class="text-red-600 text-center p-4">Error loading income chart.</p>';
                      if(document.getElementById('expenseChart')) document.getElementById('expenseChart').innerHTML = '<p class="text-red-600 text-center p-4">Error loading expense chart.</p>';
                 }
            });

            console.log("8. Updating AI display UI...");
            updateUIDisplayFromAI(data);
            console.log("AI display UI updated.");

            console.log("9. Initializing chat...");
            initializeChat();
            console.log("Chat initialized.");

            console.log("10. Making main content visible...");
            if (errorMessageElement) errorMessageElement.style.display = 'none';
            if (initialMessageElement) initialMessageElement.style.display = 'none';
            if (mainContentElement) {
                mainContentElement.style.display = 'block'; // Use block display
                mainContentElement.classList.remove('hidden'); // Ensure class is removed if used
            }
            console.log("Main content should now be visible.");

        } catch (processingError) {
            console.error("--- processAndDisplayData ERROR ---", processingError);
            handleError("Error processing or displaying data", processingError);
        } finally {
            // Ensure spinner is hidden regardless of success/failure within the try block
             console.log("Executing finally block in processAndDisplayData.");
             if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
                 console.log("Spinner hidden by processAndDisplayData finally block.");
            } else {
                console.warn("Spinner element not found in finally block.");
            }
            console.log("--- processAndDisplayData END ---");
        }
    }

    // --- Calculation Functions ---
    function calculateTotals(data) {
        const totals = {
            totalIncome: 0, totalExpenses: 0, netFlow: 0,
            totalDebt: 0, totalSavings: 0, totalMinPayments: 0,
            monthlyCoreExpenses: 0 // Added for emergency fund calc
        };
        const income = data?.userInput?.income || {};
        const expenses = data?.userInput?.expenses || {};
        const savings = data?.userInput?.savings || {};
        const debts = data?.userInput?.debts || [];

        // Income: Sum known income types
        totals.totalIncome = (Number(income.mainJobIncome) || 0) + (Number(income.secondJob) || 0) + (Number(income.otherIncome) || 0);

        // Expenses & Core Expenses: Iterate through expenses object
        const coreExpenseKeys = ['housing', 'utilities', 'transportation', 'groceriesEssentials', 'insurance', 'medical', 'care', 'taxes']; // Define core expenses
        for (const key in expenses) {
            const value = Number(expenses[key]) || 0;
            totals.totalExpenses += value;
            if (coreExpenseKeys.includes(key)) {
                totals.monthlyCoreExpenses += value;
            }
        }

        totals.netFlow = totals.totalIncome - totals.totalExpenses;

        // Debts: Sum balance and minimum payments from the debts array
        if (Array.isArray(debts)) {
             debts.forEach(debt => {
                 totals.totalDebt += Number(debt.balance) || 0;
                 totals.totalMinPayments += Number(debt.minPayment) || 0;
             });
        }

        // Savings: Sum known savings types
        totals.totalSavings = (Number(savings.emergency) || 0) + (Number(savings.savings) || 0) + (Number(savings.retirement) || 0);

        return totals;
    }

    function calculateRatios(data, totals) {
        const ratios = { savingsRate: 0, emergencyCoverage: 0, dtiRatio: 0 };
        const savingsInput = data?.userInput?.savings || {};
        const debts = data?.userInput?.debts || []; // Needed if totalMinPayments not in totals

        // Savings Rate: Use explicit monthly goal if available, else use positive net flow proxy
        const monthlySavingsGoal = Number(savingsInput.monthlySavingsGoal);
        const contribution = !isNaN(monthlySavingsGoal) && monthlySavingsGoal > 0 ? monthlySavingsGoal : Math.max(0, totals.netFlow);
        if (totals.totalIncome > 0) {
            ratios.savingsRate = (contribution / totals.totalIncome); // Rate as decimal
        }

        // Emergency Fund Coverage (Months based on CORE expenses)
        const currentEmergencyFund = Number(savingsInput.emergency) || 0;
        if (totals.monthlyCoreExpenses > 0) {
            ratios.emergencyCoverage = currentEmergencyFund / totals.monthlyCoreExpenses; // Result in months
        } else if (totals.totalExpenses > 0) {
             ratios.emergencyCoverage = currentEmergencyFund / totals.totalExpenses; // Fallback to total expenses
             console.warn("Using total expenses for emergency coverage calculation as core expenses were zero.")
        }


        // Debt-to-Income (DTI) Ratio (using minimum payments from totals)
        if (totals.totalIncome > 0) {
            ratios.dtiRatio = (totals.totalMinPayments / totals.totalIncome); // Rate as decimal
        }

        return ratios;
    }

    // --- UI Update Functions ---
    function updateReportBasics(data, totals) {
        const personalInfo = data?.userInput?.personalInfo || {};
        const savings = data?.userInput?.savings || {};
        const financials = data?.userInput?.financials || {};

        updateElementText('userName', personalInfo.userName);
        updateElementText('age', personalInfo.age);
        updateElementText('totalIncome', totals.totalIncome, formatCurrency);
        updateElementText('totalExpenses', totals.totalExpenses, formatCurrency);
        updateElementText('netFlow', totals.netFlow, formatCurrency);

        // Update Savings Overview Card
        updateElementText('emergencySavings', savings.emergency, formatCurrency);
        updateElementText('currentSavings', savings.savings, formatCurrency);
        updateElementText('retirementFund', savings.retirement, formatCurrency);

        // Update Financial Tools & Goals Card (specific fields)
        updateElementText('financialTools', financials.financialTools);
        updateElementText('challenges', financials.challenges);
        updateElementText('purchaseGoals', financials.upcomingPurchase); // Raw detail string here
    }

    function updateRatiosDisplay(ratios) {
        // Savings Rate
        const savingsRateValue = ratios.savingsRate || 0;
        updateElementText('savingsRateValue', savingsRateValue, val => formatPercentage(val, 1));
        const savingsRatePercent = Math.min(100, Math.max(0, savingsRateValue * 100));
        const savingsBar = document.getElementById('savingsRateBar');
        if (savingsBar) {
            savingsBar.style.width = `${savingsRatePercent}%`;
            // Recommendation: Poor < 5%, Fair 5-10%, Good 10-15%, Excellent > 15%
            savingsBar.className = `ratio-bar savings-rate ${savingsRateValue >= 0.15 ? 'good' : savingsRateValue >= 0.05 ? 'ok' : 'poor'}`;
        }

        // Emergency Fund Coverage (Display in Months)
        const emergencyCoverageMonths = ratios.emergencyCoverage || 0;
        updateElementText('emergencyCoverageValue', `${emergencyCoverageMonths.toFixed(1)} months`);
        const emergencyBar = document.getElementById('emergencyCoverageBar');
        if (emergencyBar) {
            const emergencyProgressPercent = Math.min(100, Math.max(0, (emergencyCoverageMonths / 6) * 100)); // Progress towards 6 months
            emergencyBar.style.width = `${emergencyProgressPercent}%`;
            // Recommendation: Poor < 1 month, Fair 1-3 months, Good 3-6 months, Excellent > 6 months
            emergencyBar.className = `ratio-bar emergency-coverage ${emergencyCoverageMonths >= 3 ? 'good' : emergencyCoverageMonths >= 1 ? 'ok' : 'poor'}`;
        }

        // DTI Ratio
        const dtiRatioValue = ratios.dtiRatio || 0;
        updateElementText('dtiRatioValue', dtiRatioValue, val => formatPercentage(val, 1));
        const dtiPercent = Math.min(100, Math.max(0, dtiRatioValue * 100));
        const dtiBar = document.getElementById('dtiRatioBar');
        if (dtiBar) {
            dtiBar.style.width = `${dtiPercent}%`;
            // General guideline: Excellent < 15%, Good 15-36%, Fair 37-43%, Poor > 43%
             dtiBar.className = `ratio-bar dti-ratio ${dtiRatioValue > 0.43 ? 'high' : dtiRatioValue >= 0.36 ? 'warning' : 'good'}`;
        }
    }

    function updateGoalsDisplay(data, totals) {
        const savingsInput = data?.userInput?.savings || {};
        const financialsInput = data?.userInput?.financials || {};
        const upcomingPurchaseString = financialsInput.upcomingPurchase || '';

        const emergencyGoalDisplay = document.getElementById('emergencyGoalDisplay');
        const purchaseGoalDisplay = document.getElementById('purchaseGoalDisplay');
        const noGoalsMessage = document.getElementById('noGoalsMessage');
        let hasVisibleGoal = false;

        // --- Emergency Fund Goal ---
        const emergencyCurrent = Number(savingsInput.emergency) || 0;
        // Use target from URL/JSON if available, otherwise default to 3 months CORE expenses
        const emergencyGoalTarget = Number(savingsInput.emergencyFundTarget) || (totals.monthlyCoreExpenses * 3);
        const emergencyProgressBar = document.getElementById('emergencyProgressBar');

        if (emergencyGoalTarget > 0 && emergencyGoalDisplay && emergencyProgressBar) {
            hasVisibleGoal = true;
            emergencyGoalDisplay.style.display = 'block';
            const progress = Math.min(100, Math.max(0, (emergencyCurrent / emergencyGoalTarget) * 100));
            emergencyProgressBar.style.width = `${progress}%`;
            emergencyProgressBar.textContent = `${progress.toFixed(0)}%`;
            const statusEl = emergencyGoalDisplay.querySelector('.goal-status');
            if (statusEl) statusEl.textContent = `Target: ${formatCurrency(emergencyGoalTarget)} (${formatPercentage(emergencyCurrent / emergencyGoalTarget, 0)} funded)`;
        } else if (emergencyGoalDisplay) {
            emergencyGoalDisplay.style.display = 'none';
        }

        // --- Upcoming Purchase Goal (Attempt to parse first one) ---
        const purchaseProgressBar = document.getElementById('purchaseProgressBar');
        const purchaseGoalNameEl = document.getElementById('purchaseGoalName');

        if (upcomingPurchaseString && purchaseGoalDisplay && purchaseProgressBar && purchaseGoalNameEl) {
            const match = upcomingPurchaseString.match(/#\d+\)\s*(.*?),\s*\$?([\d,.]+)/);
            if (match && match[1] && match[2]) {
                const goalName = match[1].trim();
                const goalAmountStr = match[2].replace(/,/g, '');
                const goalAmount = parseFloat(goalAmountStr);
                 // Use general savings for progress unless specific goal savings provided
                const generalSavings = Number(savingsInput.savings) || 0;
                 // const goalSavings = Number(financialsInput.purchaseGoalSaved) || generalSavings; // Use specific if available

                if (goalName && !isNaN(goalAmount) && goalAmount > 0) {
                    hasVisibleGoal = true;
                    purchaseGoalDisplay.style.display = 'block';
                    purchaseGoalNameEl.textContent = goalName;
                     const progress = Math.min(100, Math.max(0, (generalSavings / goalAmount) * 100)); // Using general savings
                    purchaseProgressBar.style.width = `${progress}%`;
                    purchaseProgressBar.textContent = `${progress.toFixed(0)}%`;
                     const statusEl = purchaseGoalDisplay.querySelector('.goal-status');
                     if (statusEl) statusEl.textContent = `Target: ${formatCurrency(goalAmount)} (${formatCurrency(generalSavings)} saved)`;
                }
            } else if (purchaseGoalDisplay) {
                  purchaseGoalDisplay.style.display = 'none'; // Hide if parsing fails
            }
        } else if (purchaseGoalDisplay) {
             purchaseGoalDisplay.style.display = 'none'; // Hide if no string or elements
        }

        // Show 'No goals' message only if neither goal section is visible
        if (noGoalsMessage) {
            noGoalsMessage.style.display = hasVisibleGoal ? 'none' : 'block';
        }
    }

    function updateDebtsDisplay(data, totals) {
        const debts = data?.userInput?.debts || [];
        const debtsTableBody = document.getElementById('debtsTable')?.getElementsByTagName('tbody')[0];
        if (!debtsTableBody) {
            console.error("Debt table body not found!");
            return;
        }
        debtsTableBody.innerHTML = ''; // Clear existing rows

        if (debts.length === 0) {
            debtsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No debt information provided.</td></tr>';
        } else {
            debts.forEach(debt => {
                const row = debtsTableBody.insertRow();
                // Use getSafe for potentially missing debt properties
                row.innerHTML = `
                    <td>${getSafe(() => debt.type, 'N/A')}</td>
                    <td class="balance-col">${formatCurrency(getSafe(() => debt.balance))}</td>
                    <td>${(Number(getSafe(() => debt.interestRate, 0))).toFixed(1)}%</td>
                    <td class="balance-col">${formatCurrency(getSafe(() => debt.minPayment))}</td>
                `;
            });
        }
        // Update totals using the calculated totals object
        updateElementText('totalDebtBalance', totals.totalDebt, formatCurrency);
        updateElementText('totalMinPayments', totals.totalMinPayments, formatCurrency);
    }

    function renderCharts(data) {
        // Use try...catch within the function called by requestAnimationFrame
        try {
            const incomeData = data?.userInput?.income || {};
            const expenseData = data?.userInput?.expenses || {};

            // Filter out zero values and prepare data for Plotly
            const incomeLabels = Object.keys(incomeData).filter(k => Number(incomeData[k]) > 0)
                                     .map(label => label.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase())); // Format labels
            const incomeValues = Object.keys(incomeData).map(k => Number(incomeData[k])).filter(v => v > 0);

            const expenseLabels = Object.keys(expenseData).filter(k => Number(expenseData[k]) > 0)
                                     .map(label => label.replace(/([A-Z])/g, ' $1').replace(/^./, c => c.toUpperCase())); // Format labels
            const expenseValues = Object.keys(expenseData).map(k => Number(expenseData[k])).filter(v => v > 0);

            const incomeChartDiv = document.getElementById('incomeChart');
            const expenseChartDiv = document.getElementById('expenseChart');

             // Common layout adjustments for Pie charts
            const commonPieLayout = {
                 height: 350,
                 margin: { t: 50, b: 80, l: 20, r: 20 }, // Adjust margins
                 showlegend: true,
                 legend: { orientation: "h", yanchor: "bottom", y: -0.2, xanchor: 'center', x: 0.5 }, // Horizontal legend below
                 paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                 font: { family: 'Inter, sans-serif', size: 11, color: '#374151' }
             };

            // Income Chart (Pie)
             if (incomeChartDiv) {
                if (incomeValues.length > 0) {
                    const incomeTrace = {
                        values: incomeValues, labels: incomeLabels, type: 'pie', hole: .4,
                        hoverinfo: 'label+percent', textinfo: 'value', textfont_size: 11,
                        marker: { colors: ['#10b981', '#34d399', '#6ee7b7'] } // Example green shades
                    };
                    Plotly.newPlot(incomeChartDiv, [incomeTrace], { ...commonPieLayout, title: 'Income Sources' }, plotlyConfig);
                } else {
                    incomeChartDiv.innerHTML = '<p class="text-center text-gray-500 pt-10">No income data to display.</p>';
                }
             } else { console.error("Income chart div not found"); }

            // Expense Chart (Pie)
            if (expenseChartDiv) {
                if (expenseValues.length > 0) {
                    const expenseTrace = {
                        values: expenseValues, labels: expenseLabels, type: 'pie', hole: .4,
                        hoverinfo: 'label+percent', textinfo: 'value', textfont_size: 11,
                        marker: { colors: ['#ef4444', '#f87171', '#fca5a5', '#fecaca', '#fee2e2', '#ffedd5', '#fed7aa', '#fdba74', '#fb923c'] } // Example red/orange shades
                    };
                     Plotly.newPlot(expenseChartDiv, [expenseTrace], { ...commonPieLayout, title: 'Expense Categories' }, plotlyConfig);
                } else {
                     expenseChartDiv.innerHTML = '<p class="text-center text-gray-500 pt-10">No expense data to display.</p>';
                }
            } else { console.error("Expense chart div not found"); }

        } catch (chartError) {
             console.error("Error during Plotly rendering:", chartError);
             // Propagate error to main handler
             throw new Error(`Chart rendering failed: ${chartError.message}`);
        }
    }

    function updateUIDisplayFromAI(data) {
        const aiOutput = data?.aiOutput || {};
        const analysisEl = document.getElementById('aiAnalysis');
        const recommendationsList = document.getElementById('recommendationsList');
        const progressContentEl = document.getElementById('progressContent'); // For modal

        if (analysisEl) {
            analysisEl.innerHTML = (aiOutput.analysis || 'Analysis not provided.').replace(/\n/g, '<br>');
        }
        if (progressContentEl) {
             progressContentEl.textContent = aiOutput.userProgress || 'No progress history available.';
        }
        if (recommendationsList) {
            recommendationsList.innerHTML = ''; // Clear previous
            const recsText = aiOutput.recommendations || '';
            const recsArray = recsText.split(/\\n|\n/) // Split by literal '\n' or actual newline
                                     .map(r => r.trim().replace(/^[\*\-\d\.]+\s*/, '')) // Trim and remove list markers
                                     .filter(r => r.length > 0); // Remove empty lines

            if (recsArray.length > 0 && !(recsArray.length === 1 && recsArray[0].toLowerCase().includes("not provided"))) {
                recsArray.forEach(rec => {
                    const li = document.createElement('li');
                    if (rec.toLowerCase().includes('critical') || rec.toLowerCase().includes('urgent')) li.className = 'critical';
                    else if (rec.toLowerCase().includes('warning') || rec.toLowerCase().includes('consider')) li.className = 'warning';
                    li.textContent = rec;
                    recommendationsList.appendChild(li);
                });
            } else {
                recommendationsList.innerHTML = '<li>No specific recommendations available.</li>';
            }
        } else { console.error("Recommendations list element not found"); }
    }

    // --- Chat Functionality ---
    function initializeChat() {
        console.log("--- initializeChat START ---");
        const chatInput = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');
        const chatHistory = document.getElementById('chatHistory');
        const chatInterfaceCard = document.getElementById('chatInterfaceCard');

        if (!chatInput || !chatSendButton || !chatHistory || !chatInterfaceCard) {
            console.error("One or more Chat UI elements not found! Aborting chat initialization.");
            if(chatInterfaceCard) chatInterfaceCard.style.display = 'none';
            return;
        }

        // Show chat card only if data was successfully processed and Supabase is available
        if (supabase && typeof supabase.functions?.invoke === 'function') {
             chatInterfaceCard.style.display = 'block'; // Use block or grid as needed
             enableChatInput(true);
             chatHistory.innerHTML = ''; // Clear previous messages
             // Add initial assistant message only once? Maybe check chatMessages length.
             if (chatMessages.length === 0) {
                addMessageToChat("Assistant", "Hello! Ask me anything about the financial data shown on your dashboard.", false);
             } else {
                 // Restore previous messages if needed (e.g., after demo data load) - complex, omit for now
             }
             setChatStatus("", false);

             // Ensure listeners are attached only once
             chatSendButton.removeEventListener('click', handleChatSubmit);
             chatInput.removeEventListener('keydown', handleChatEnterKey);
             chatSendButton.addEventListener('click', handleChatSubmit);
             chatInput.addEventListener('keydown', handleChatEnterKey);

             console.log("Chat UI initialized and enabled.");
        } else {
             chatInterfaceCard.style.display = 'none'; // Hide if Supabase not ready
             addMessageToChat("System", "Chat service connection failed.", true); // Add message even if hidden?
             enableChatInput(false);
             setChatStatus("Chat unavailable", false);
             console.warn("Chat initialization skipped: Supabase client or functions not available.");
        }
        console.log("--- initializeChat END ---");
    }

    function handleChatEnterKey(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleChatSubmit(); } }

    function enableChatInput(enabled) {
        const chatInput = document.getElementById('chatInput');
        const chatSendButton = document.getElementById('chatSendButton');
        if (chatInput && chatSendButton) {
            chatInput.disabled = !enabled;
            chatSendButton.disabled = !enabled;
            chatInput.placeholder = enabled ? "Ask about your finances..." : "Chat unavailable";
            chatInput.style.opacity = enabled ? '1' : '0.6';
            chatSendButton.style.opacity = enabled ? '1' : '0.6';
            chatSendButton.style.cursor = enabled ? 'pointer' : 'not-allowed';
        }
    }

     function addMessageToChat(sender, message, isError = false) {
        const chatHistory = document.getElementById('chatHistory');
        if (!chatHistory) return;

        const messageContainer = document.createElement('div');
        // Add sender type as class: 'user', 'assistant', 'system'
        messageContainer.classList.add('chat-message', sender.toLowerCase());

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        if (isError) { // Style error messages distinctly
            bubble.style.backgroundColor = '#fee2e2'; // Tailwind red-100
            bubble.style.color = '#b91c1c'; // Tailwind red-700
            bubble.style.borderColor = '#fca5a5'; // Tailwind red-300
        }

        // Basic Markdown-like link handling: [text](url) -> <a href="url">text</a>
        // Be cautious with innerHTML and untrusted content. Sanitize if necessary.
        const linkedMessage = message.replace(
                /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
                '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-medium">$1</a>'
            )
            .replace(/\n/g, '<br>'); // Convert newlines to <br>

        bubble.innerHTML = linkedMessage;
        messageContainer.appendChild(bubble);
        chatHistory.appendChild(messageContainer);

        // Scroll to the bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function setChatStatus(message, isLoading = false) {
        const chatStatus = document.getElementById('chatStatus');
        if (!chatStatus) return;
        if (isLoading) {
            chatStatus.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div> Thinking...`;
        } else {
            chatStatus.textContent = message;
            // Auto-clear status message after a few seconds unless it's an error
            if (message && !message.toLowerCase().includes('error')) {
                setTimeout(() => {
                    if (chatStatus.textContent === message) chatStatus.textContent = '';
                }, 4000);
            }
        }
    }

    async function sendToBackendChatFunction() {
        if (!dashboardData?.userInput?.personalInfo) {
            addMessageToChat("System", "Error: Financial data seems incomplete.", true);
            setChatStatus("Error: Data missing", false);
            return;
        }
        if (!supabase || typeof supabase.functions?.invoke !== 'function') {
            addMessageToChat("System", "Error: Chat service connection lost.", true);
            setChatStatus("Chat unavailable", false);
            return;
        }

        setChatStatus("Thinking...", true);
        enableChatInput(false);

        // Prepare context string (summary of key data)
        let financialContext = `User: ${getSafe(() => dashboardData.userInput.personalInfo.userName)}\n`;
        const totals = calculateTotals(dashboardData); // Recalculate for fresh context
        financialContext += `Totals: Income(${formatCurrency(totals.totalIncome)}), Expenses(${formatCurrency(totals.totalExpenses)}), Net(${formatCurrency(totals.netFlow)})\n`;
        financialContext += `Savings: Emergency(${formatCurrency(getSafe(()=>dashboardData.userInput.savings.emergency))}), General(${formatCurrency(getSafe(()=>dashboardData.userInput.savings.savings))}), Retirement(${formatCurrency(getSafe(()=>dashboardData.userInput.savings.retirement))})\n`;
        financialContext += `Total Debt: ${formatCurrency(totals.totalDebt)}\n`;
        // Include prior analysis/recs if available
        if (getSafe(() => dashboardData.aiOutput.analysis) !== 'N/A') financialContext += `Prior Analysis: ${getSafe(() => dashboardData.aiOutput.analysis)}\n`;
        if (getSafe(() => dashboardData.aiOutput.recommendations) !== 'N/A') financialContext += `Prior Recs: ${getSafe(() => dashboardData.aiOutput.recommendations)}\n`;

        // Construct messages payload for Supabase function
        const systemMessage = { role: "system", content: `You are SmartWealth AI, a helpful financial assistant. Use the provided financial context ONLY to answer the user's questions concisely. Financial Context:\n${financialContext}` };
        const messagesForBackend = [systemMessage, ...chatMessages]; // Include full history + system prompt

        const functionName = 'smooth-function'; // Make sure this matches your deployed function name

        console.log(`Invoking Supabase function '${functionName}' with ${messagesForBackend.length} messages.`);

        try {
            const { data, error } = await supabase.functions.invoke(functionName, {
                body: { messages: messagesForBackend, model: CHAT_MODEL }, // Send model preference if backend supports it
            });

            setChatStatus("", false); // Clear thinking indicator

            if (error) {
                console.error("Supabase function invocation error:", error);
                // Provide more specific feedback if possible
                let errMsg = error.message;
                if (error.context) errMsg += ` (Details: ${JSON.stringify(error.context)})`;
                 throw new Error(`Backend Error: ${errMsg}`);
            }

            if (data && data.assistantResponse && data.assistantResponse.content) {
                const assistantMsg = data.assistantResponse;
                 addMessageToChat("Assistant", assistantMsg.content);
                 chatMessages.push(assistantMsg); // Add AI response to local history
            } else {
                 console.error("Unexpected response format from backend:", data);
                throw new Error("Received an unexpected response format from the AI service.");
            }

        } catch (error) {
             console.error("Error during chat interaction:", error);
             addMessageToChat("System", `Sorry, I encountered an error: ${error.message}`, true);
             setChatStatus("Error communicating with AI", false);
        } finally {
             enableChatInput(true); // Always re-enable input
        }
    }


    // --- Event Handlers & Button Initializers ---
     function handleChatSubmit() {
        const chatInput = document.getElementById('chatInput');
        const userMessage = chatInput.value.trim();
        if (!userMessage || chatInput.disabled) return;

        addMessageToChat("User", userMessage);
        chatMessages.push({ role: "user", content: userMessage }); // Add user message to history
        chatInput.value = ''; // Clear input
        chatInput.style.height = '44px'; // Reset height after send

        sendToBackendChatFunction(); // Call backend
    }

    function initSaveButton() {
        const saveButton = document.getElementById('saveButton');
        if (!saveButton) { console.error("Save button not found."); return; }
        saveButton.addEventListener('click', () => {
            if (!dashboardData || Object.keys(dashboardData).length === 0) {
                alert("No report data available to save."); return;
            }
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dashboardData, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                const filenameUser = getSafe(() => dashboardData.userInput.personalInfo.userName.replace(/[^a-z0-9]/gi, '_').toLowerCase(), 'user');
                a.download = `financial_report_${filenameUser}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch (saveError) {
                console.error("Error creating save data:", saveError);
                handleError("Error saving file", saveError); // Use central error handler
            }
        });
    }

    function initUploadButton() {
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        if (!uploadButton || !fileInput) { console.error("Upload button or file input not found."); return; }
        uploadButton.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', handleFileUpload);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Show loading, hide others
        if (loadingSpinner) loadingSpinner.style.display = 'flex';
        if (errorMessageElement) errorMessageElement.style.display = 'none';
        if (initialMessageElement) initialMessageElement.style.display = 'none';
        if (mainContentElement) mainContentElement.style.display = 'none';

        const reader = new FileReader();
        reader.onload = function(e) {
            let uploadedData = null;
            try {
                uploadedData = JSON.parse(e.target.result);
                // Basic validation of uploaded structure
                if (typeof uploadedData !== 'object' || uploadedData === null || !uploadedData.userInput || !uploadedData.userInput.personalInfo) {
                    throw new Error("Invalid file content. Expected a JSON object with 'userInput' and 'personalInfo'.");
                }
                dashboardData = uploadedData; // Replace current data
                chatMessages = []; // Clear chat history for new data
                processAndDisplayData(dashboardData); // Display the new data
            } catch (error) {
                console.error("Error processing uploaded file:", error);
                handleError("Error loading file", error); // Use central handler
                 dashboardData = {}; // Reset data on error
                 chatMessages = []; // Clear chat
            } finally {
                event.target.value = null; // Reset file input
            }
        };
        reader.onerror = function(e) {
            console.error("FileReader error:", e);
            handleError("Error reading file", e.target.error || new Error("Unknown FileReader error"));
            dashboardData = {}; // Reset data
            chatMessages = []; // Clear chat
        };
        reader.readAsText(file);
    }

    // --- Modals ---
    function initModals() {
        // Close modal if clicking outside the content area
        window.addEventListener('click', function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = "none";
                }
            }
        });
         // Add explicit close button handlers if needed (already handled by inline onclick)
    }
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
             // Optional: Refresh modal content if dynamic
             if(modalId === 'progressModal' && dashboardData?.aiOutput) {
                 const progressContentEl = document.getElementById('progressContent');
                 if(progressContentEl) progressContentEl.textContent = dashboardData.aiOutput.userProgress || 'No progress history available.';
             }
            modal.style.display = "block";
        } else { console.warn(`Modal with ID ${modalId} not found.`); }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = "none";
    }

</script>
</body>
</html>

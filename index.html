<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa; /* Slightly lighter gray */
            color: #1f2937; /* Darker gray for text */
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .header-font { font-family: 'EB Garamond', serif; color: #111827; }
        .main-container { max-width: 1400px; margin: 2rem auto; padding: 1.5rem 2rem; }
        .dashboard-card { background-color: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); padding: 1.5rem; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 7px 18px rgba(0, 0, 0, 0.08); }
        .stat-value { font-size: 1.75rem; font-weight: 600; line-height: 1.2; }
        .stat-label { font-size: 0.9rem; color: #4b5563; margin-bottom: 0.25rem; display: block; }
        .card-header { font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; }
        .breakdown-list div { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid #f3f4f6; }
        .breakdown-list div:last-child { border-bottom: none; }
        .breakdown-label { font-size: 0.875rem; color: #6b7280; }
        .breakdown-value { font-weight: 500; color: #1f2937; }
        .action-button { background-color: #3b82f6; color: white; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .action-button:hover { background-color: #2563eb; }
        .secondary-button { background-color: #e5e7eb; color: #374151; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 500; transition: background-color 0.2s ease; border: none; cursor: pointer; }
        .secondary-button:hover { background-color: #d1d5db; }
        .prose { color: #374151; }
        .prose h3 { font-family: 'Inter', sans-serif; font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: #111827; }
        .prose h4 { font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #1f2937; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.7; }
        .prose ul { list-style-position: outside; padding-left: 1.25rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .text-success { color: #10b981; } .text-warning { color: #f59e0b; } .text-danger { color: #ef4444; }
        .bg-success-light { background-color: #d1fae5; } .bg-warning-light { background-color: #fef3c7; } .bg-danger-light { background-color: #fee2e2; }
        footer { margin-top: 3rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; }
        /* Add specific styles for debug table */
        #debugInfo table { width: 100%; border-collapse: collapse; font-size: 11px; }
        #debugInfo th, #debugInfo td { text-align: left; border-bottom: 1px solid #ddd; padding: 4px; word-break: break-all; }
        #debugInfo th { background-color: #f0f0f0; }
        #debugInfo strong { display: block; margin-top: 5px; margin-bottom: 2px; font-size: 12px; }
    </style>
</head>
<body class="min-h-screen">
    <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>

    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-gray-700 text-lg">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white z-50 p-4">
        <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-5 rounded-lg max-w-lg shadow-md">
            <h3 class="font-bold text-xl mb-3 header-font">Error Loading Dashboard</h3>
            <p id="errorText" class="mb-4">Unable to load financial data. Please check the URL or try again later.</p>
            <div id="debugInfo" class="mb-4 max-h-60 overflow-auto bg-gray-100 p-3 rounded text-xs border border-gray-300">Initializing debug info...</div>
            <div class="flex justify-center space-x-3 mt-4">
                <button id="retryButton" class="action-button">Retry Loading</button>
                <button id="manualEntryButton" class="secondary-button">Use Demo Data</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-container hidden">
        <header class="mb-10 border-b border-gray-200 pb-6">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                 <div>
                     <h1 id="dashboard-title" class="header-font text-4xl md:text-5xl font-bold text-gray-800 mb-1">SmartWealth Navigator</h1>
                     <p id="dashboard-subtitle" class="text-gray-600 text-lg">Your Personalized Financial Insights</p>
                 </div>
                 <div class="mt-4 md:mt-0 text-sm text-gray-500">
                      Data for: <span id="userNameDisplay" class="font-semibold text-gray-700">User</span> | Last Updated: <span id="updateDate">Today</span>
                 </div>
             </div>
        </header>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Key Financial Metrics</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Monthly Net Cash Flow</h3>
                     <div class="text-center mt-2">
                         <span id="netCashFlow" class="stat-value block mb-2">$0</span>
                         <div class="bg-gray-200 h-2.5 rounded-full mb-3"><div id="cashFlowProgress" class="h-2.5 rounded-full" style="width: 0%"></div></div>
                         <p id="cashFlowMessage" class="text-xs text-gray-500 h-8"></p>
                     </div>
                 </div>
                 <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Savings Rate</h3>
                     <div class="text-center mt-2"><span id="savingsRate" class="stat-value block mb-2">0%</span><p class="text-xs text-gray-500 mt-3">(Net Cash Flow / Total Income)</p></div>
                 </div>
                  <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Estimated Net Worth</h3>
                     <div class="text-center mt-2"><span id="netWorth" class="stat-value block mb-2">$0</span><p class="text-xs text-gray-500 mt-3">(Total Savings - Total Debt)</p></div>
                 </div>
                  <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Emergency Fund</h3>
                     <div class="text-center mt-2"><span id="emergencyFundCoverage" class="stat-value block mb-2">0 months</span><p class="text-xs text-gray-500 mt-3">(Emergency Savings / Monthly Expenses)</p></div>
                 </div>
             </div>
        </section>

        <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Income & Expenses Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="dashboard-card">
                    <h3 class="card-header">Monthly Income Breakdown</h3>
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                        <span class="stat-label font-semibold">Total Income</span><span id="totalIncome" class="stat-value text-green-600">$0</span>
                    </div>
                    <div id="incomeBreakdown" class="space-y-2 breakdown-list"><p class="text-gray-500 text-sm">Loading income details...</p></div>
                </div>
                <div class="dashboard-card">
                     <h3 class="card-header">Monthly Expenses Breakdown</h3>
                     <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                         <span class="stat-label font-semibold">Total Expenses</span><span id="totalExpenses" class="stat-value text-red-600">$0</span>
                     </div>
                     <div id="expensesBreakdown" class="space-y-1 breakdown-list max-h-60 overflow-y-auto pr-2"><p class="text-gray-500 text-sm">Loading expense details...</p></div>
                </div>
            </div>
        </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Visualizations</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="dashboard-card"><h3 class="card-header">Income vs. Expenses</h3><div id="incomeExpenseChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart will load here.</p></div></div>
                 <div class="dashboard-card"><h3 class="card-header">Savings & Debt Overview</h3><div id="savingsDebtChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart will load here.</p></div></div>
             </div>
         </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">AI Insights & Recommendations</h2>
             <div class="dashboard-card">
                 <div id="summaryContent" class="prose max-w-none prose-indigo"><p class="text-gray-500">Generating financial summary...</p></div>
                  <div id="aiAnalysisSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Analysis</h3><p id="aiAnalysisContent"></p></div>
                  <div id="aiRecommendationsSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Recommendations</h3><p id="aiRecommendationsContent"></p></div>
                  <div id="aiProgressSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">User Progress History</h3><p id="aiProgressContent"></p></div>
             </div>
        </section>

        <section id="chatInterfaceCard" class="mb-10 dashboard-card hidden">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Chat with SmartWealth AI</h2>
             <div class="bg-gray-100 p-4 rounded min-h-[200px] flex items-center justify-center"><p class="text-gray-500 italic">AI Chat coming soon...</p></div>
        </section>

        <footer class="text-center text-gray-500 text-sm py-6">
            <p>SmartWealth Navigator &copy; 2025 | Built by Socialeap™️</p>
             <p>This is a financial overview tool. Consult with a qualified financial advisor for personalized advice.</p>
        </footer>
    </div>

    <script>
        // --- Global Variables ---
        let dashboardData = null;

        // --- Utility Functions ---
        function formatCurrency(value) { /* ... same as before ... */
             if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }
        function formatPercentage(value) { /* ... same as before ... */
            if (isNaN(value) || !isFinite(value)) return '0%';
             return `${value.toFixed(1)}%`;
        }

        // --- Data Loading and Initialization ---
        document.addEventListener('DOMContentLoaded', function() { /* ... same button listeners and date setup ... */
             const today = new Date();
            document.getElementById('updateDate').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('retryButton').addEventListener('click', function() { /* ... */
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('loadingSpinner').classList.remove('hidden');
                 setTimeout(initializeDashboard, 500);
             });
             document.getElementById('manualEntryButton').addEventListener('click', function() { /* ... */
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('loadingSpinner').classList.remove('hidden');
                 useDemoData();
             });
             initializeDashboard();
        });

        // Debug function to check URL parameters (Enhanced)
        function debugURLParameters() {
             const params = new URLSearchParams(window.location.search);
             let debugInfoEl = document.getElementById('debugInfo');
             if (!debugInfoEl) return '';

             let paramsText = '<strong>URL Query String:</strong><br>';
             paramsText += `<code style="font-size: 10px; word-break: break-all;">${window.location.search || '(empty)'}</code><br>`;
             paramsText += '<strong>Parsed Parameters:</strong><br>';

             if (params.toString() === '') {
                 paramsText += '<span style="color: orange;">No URL parameters detected!</span><br>';
             } else {
                 paramsText += '<table><thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody>';
                 for (const [key, value] of params.entries()) {
                     paramsText += `<tr><td>${key}</td><td>${value || '<i style="color: gray;">(empty)</i>'}</td></tr>`;
                 }
                 paramsText += '</tbody></table>';
             }
             debugInfoEl.innerHTML = paramsText; // Update the debug element immediately
             return paramsText;
        }

        // Function to handle errors (Shows debug info)
        function handleError(message, error) {
            console.error("HANDLE ERROR:", message, error);
            // Ensure debug info is generated and displayed
            const debugContent = debugURLParameters();
             const debugInfoEl = document.getElementById('debugInfo');
             if (debugInfoEl && debugInfoEl.innerHTML.includes('Initializing')) {
                  debugInfoEl.innerHTML = debugContent || 'Could not retrieve URL parameters for debugging.';
             } else if (debugInfoEl) {
                  // Append error message to existing debug info if needed
                  debugInfoEl.innerHTML += `<br><strong>Error:</strong><br><span style="color: red;">${message}. ${error?.message || 'Check console.'}</span>`;
             }

            document.getElementById("errorText").innerText = `${message}. ${error?.message || 'See debug info below or check console.'}`;
            document.getElementById("errorMessage").classList.remove("hidden");
            document.getElementById("loadingSpinner").classList.add("hidden");
            document.getElementById("mainContent").classList.add("hidden");
        }

        // Function to use demo data (Same as before)
        function useDemoData() { /* ... same demo data object and renderDashboard call ... */
             console.log("Using Demo Data");
             const demoData = {
                 userInput: {
                     personalInfo: { userName: "Demo User", age: 35 },
                     income: { mainJobIncome: 5500, secondJob: 1200, otherIncome: 300 },
                     expenses: { housing: 1800, transportation: 450, utilities: 250, groceriesEssentials: 600, insurance: 350, medical: 150, care: 100, subscriptions: 80, taxes: 1100 },
                     savings: { emergency: 8000, savings: 15000, retirement: 75000 },
                     debts: [ { type: "Credit Card", balance: 4500, interestRate: 22.5, minPayment: 150 }, { type: "Bank Loans", balance: 12000, interestRate: 6.5, minPayment: 300 } ]
                 },
                  aiOutput: { analysis: "Demo analysis text.", recommendations: "Demo recommendations text.", userProgress: "Demo progress text." }
             };
             renderDashboard(demoData);
        }

        // **Initialize dashboard: Load data from URL -> Embedded -> Demo (REVISED LOGIC)**
        function initializeDashboard() {
            const params = new URLSearchParams(window.location.search);
            const dataElement = document.getElementById('embeddedPsrData');
            let dataLoaded = false;
            let rawData = {}; // Use a temporary object

            // --- Log Initial State ---
            console.log("--- initializeDashboard START ---");
             debugURLParameters(); // Log params immediately for debugging

            try {
                // --- Flexible Parameter Getter (REVISED) ---
                 const getParam = (keyBase) => {
                     const keyBaseLower = keyBase.toLowerCase();
                     let foundValue = null;
                      console.log(`getParam: Searching for base key "${keyBase}"`);

                     // Iterate through all actual URL keys
                     for (const currentKey of params.keys()) {
                         const currentKeyLower = currentKey.toLowerCase();

                         // 1. Exact match (case-insensitive)
                         if (currentKeyLower === keyBaseLower) {
                              foundValue = params.get(currentKey);
                              console.log(` -> Found exact match: ${currentKey} = ${foundValue}`);
                              break; // Found best match
                         }

                         // 2. Check for Jotform prefix q<number>_keyBase (case-insensitive)
                         const jotformPattern = new RegExp(`^q\\d+_${keyBaseLower}$`, 'i');
                         if (jotformPattern.test(currentKeyLower)) {
                              foundValue = params.get(currentKey);
                              console.log(` -> Found Jotform match: ${currentKey} = ${foundValue}`);
                              break; // Found best match
                         }

                         // 3. Check if the key ENDS WITH the base key (e.g., ...Income for mainJobIncome) - Less specific
                         if (currentKeyLower.endsWith(keyBaseLower)) {
                              foundValue = params.get(currentKey);
                              console.log(` -> Found suffix match: ${currentKey} = ${foundValue}`);
                              // Don't break yet, keep looking for better matches
                         }
                     }

                     if (foundValue !== null) {
                          console.log(`getParam: Returning value for "${keyBase}": "${foundValue}"`);
                          return foundValue;
                     } else {
                          console.log(`getParam: No matching parameter found for "${keyBase}"`);
                          return null;
                     }
                 };

                 // --- Helper to safely parse numbers (REVISED) ---
                 const parseNumeric = (keyName, value, defaultValue = 0) => {
                     console.log(`parseNumeric: Parsing key "${keyName}", value: "${value}"`);
                     if (value === null || typeof value === 'undefined' || String(value).trim() === '') {
                          console.log(` -> Empty/null value, returning default: ${defaultValue}`);
                          return defaultValue;
                      }
                     if (typeof value === 'number') {
                          const result = isNaN(value) ? defaultValue : value;
                           console.log(` -> Input is number, returning: ${result}`);
                           return result;
                     }
                     // Only proceed if it's a string
                     if (typeof value !== 'string') {
                          console.warn(` -> Unexpected type (${typeof value}), returning default: ${defaultValue}`);
                         return defaultValue;
                     }

                     // Remove common currency symbols, commas, whitespace. Keep decimal point and negative sign.
                     const cleaned = value.trim().replace(/[^0-9.-]+/g, '');
                      console.log(` -> Cleaned string: "${cleaned}"`);
                     if (cleaned === '' || cleaned === '-' || cleaned === '.') {
                          console.log(` -> Cleaned value invalid, returning default: ${defaultValue}`);
                         return defaultValue;
                     }
                     const number = parseFloat(cleaned);
                     const result = isNaN(number) ? defaultValue : number;
                      console.log(` -> Parsed float: ${number}, returning: ${result}`);
                     return result;
                 };

                 // --- Attempt to Load from URL ---
                 console.log("--- Parsing URL Parameters ---");
                 if (params.toString().length > 0) {
                     const fetchedUserName = getParam('userName') || getParam('username');
                     const fetchedAge = parseNumeric('age', getParam('age'));
                     const fetchedMainJobIncome = parseNumeric('mainJobIncome', getParam('mainJobIncome'));
                     const fetchedSecondJobIncome = parseNumeric('secondJobIncome', getParam('secondJobIncome') || getParam('secondJob'));
                     const fetchedOtherIncome = parseNumeric('otherIncome', getParam('otherIncome'));
                     const fetchedHousing = parseNumeric('housing', getParam('housing'));
                     const fetchedTransportation = parseNumeric('transportation', getParam('transportation'));
                     const fetchedUtilities = parseNumeric('utilities', getParam('utilities'));
                     const fetchedGroceries = parseNumeric('groceries-essentials', getParam('groceries-essentials') || getParam('groceries'));
                     const fetchedInsurance = parseNumeric('insurance', getParam('insurance'));
                     const fetchedMedical = parseNumeric('medical', getParam('medical'));
                     const fetchedCare = parseNumeric('care', getParam('care'));
                     const fetchedSubscriptions = parseNumeric('subscriptions', getParam('subscriptions'));
                     const fetchedTaxes = parseNumeric('taxes', getParam('taxes'));
                     const fetchedEmergencySavings = parseNumeric('emergencySavings', getParam('emergencySavings') || getParam('emergency'));
                     const fetchedCurrentSavings = parseNumeric('currentSavings', getParam('currentSavings') || getParam('savings'));
                     const fetchedRetirementFund = parseNumeric('retirementFund', getParam('retirementFund') || getParam('retirement'));
                     const fetchedCreditCardDebt = parseNumeric('creditCardDebt', getParam('creditCardDebt') || getParam('creditcard'));
                     const fetchedBankLoans = parseNumeric('bankLoans', getParam('bankLoans') || getParam('loans'));

                     // AI Fields (handle potential encoding)
                     const decodeAIField = (fieldName) => {
                         const val = getParam(fieldName);
                         if (!val) return '';
                         try {
                             const decoded = decodeURIComponent(val);
                              console.log(`Decoded AI field "${fieldName}": ${decoded.substring(0, 50)}...`); // Log snippet
                             return decoded;
                         } catch (e) {
                             console.warn(`Could not decode URI component for ${fieldName}:`, e, `Returning raw value: ${val.substring(0,50)}...`);
                             return val; // Return raw value if decoding fails
                         }
                     };
                     const fetchedAnalysis = decodeAIField('aiAnalysis');
                     const fetchedRecommendations = decodeAIField('recommendations');
                     const fetchedProgress = decodeAIField('userProgressHistory') || decodeAIField('userProgress');

                     // Construct the rawData object
                     rawData = {
                         userInput: {
                             personalInfo: { userName: fetchedUserName || 'User', age: fetchedAge || 30 },
                             income: { mainJobIncome: fetchedMainJobIncome, secondJob: fetchedSecondJobIncome, otherIncome: fetchedOtherIncome },
                             expenses: { housing: fetchedHousing, transportation: fetchedTransportation, utilities: fetchedUtilities, groceriesEssentials: fetchedGroceries, insurance: fetchedInsurance, medical: fetchedMedical, care: fetchedCare, subscriptions: fetchedSubscriptions, taxes: fetchedTaxes },
                             savings: { emergency: fetchedEmergencySavings, savings: fetchedCurrentSavings, retirement: fetchedRetirementFund },
                             debts: [
                                 { type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: 22.5, minPayment: 50 },
                                 { type: "Bank Loans", balance: fetchedBankLoans, interestRate: 6.5, minPayment: 100 }
                             ]
                         },
                         aiOutput: { analysis: fetchedAnalysis, recommendations: fetchedRecommendations, userProgress: fetchedProgress }
                     };

                     // --- Validation Check (REVISED) ---
                     console.log("--- Validating Parsed URL Data ---");
                      const hasIncome = rawData.userInput.income.mainJobIncome > 0 || rawData.userInput.income.secondJob > 0 || rawData.userInput.income.otherIncome > 0;
                      const hasExpenses = Object.values(rawData.userInput.expenses).some(v => v > 0);
                      const hasSavings = Object.values(rawData.userInput.savings).some(v => v > 0);
                      const hasDebt = rawData.userInput.debts.some(d => d.balance > 0);
                      const hasName = !!rawData.userInput.personalInfo.userName && rawData.userInput.personalInfo.userName !== 'User'; // Check if name was actually found

                      console.log(`Validation results: hasIncome=${hasIncome}, hasExpenses=${hasExpenses}, hasSavings=${hasSavings}, hasDebt=${hasDebt}, hasName=${hasName}`);

                      // Consider loaded if *any* financial data OR a specific name was found
                      if (hasIncome || hasExpenses || hasSavings || hasDebt || hasName) {
                         dashboardData = rawData;
                         dataLoaded = true;
                         console.log(">>> Data successfully loaded from URL parameters.", dashboardData);
                     } else {
                         console.warn("!!! URL parameters parsed, but no significant financial data or username found. Will check embedded/demo.");
                     }
                 } else {
                     console.log("--- No URL parameters detected ---");
                 }

                // --- Attempt to Load from Embedded JSON ---
                if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
                     console.log("--- Attempting to load data from embedded JSON ---");
                     try {
                        // ... (Embedded JSON parsing logic - same as before)
                        const embeddedJson = JSON.parse(dataElement.textContent);
                        if (typeof embeddedJson === 'object' && embeddedJson !== null && embeddedJson.userInput) {
                             dashboardData = embeddedJson;
                             dataLoaded = true;
                             console.log(">>> Data successfully loaded from embedded JSON.", dashboardData);
                         } else {
                              console.warn("!!! Embedded content was not valid dashboard JSON.");
                         }
                     } catch (jsonErr) {
                         console.error("!!! Error parsing embedded JSON:", jsonErr);
                     }
                 }

                // --- Final Check and Render/Fallback ---
                console.log("--- Final Data Load Check ---");
                if (dataLoaded && dashboardData) {
                    console.log(">>> Proceeding to render dashboard.");
                    renderDashboard(dashboardData);
                } else {
                    console.warn("!!! No valid data loaded from URL or embedded JSON. Triggering error/demo fallback.");
                    throw new Error("No valid financial data found in URL or embedded source."); // Trigger error display
                }
                console.log("--- initializeDashboard END ---");

            } catch (err) {
                 console.error("--- initializeDashboard ERROR ---", err);
                 handleError("Dashboard initialization failed", err);
                 // Ensure demo button is available in error state
                 document.getElementById('manualEntryButton')?.classList.remove('hidden');
            }
        }

        // --- Rendering Functions ---
        function renderDashboard(data) { /* ... same as before ... */
             try {
                 console.log("--- renderDashboard START ---", data);
                 dashboardData = data;
                 const userInput = data.userInput || {};
                 const personalInfo = userInput.personalInfo || {};
                 const income = userInput.income || {};
                 const expenses = userInput.expenses || {};
                 const savings = userInput.savings || {};
                 const debts = userInput.debts || [];
                 const aiOutput = data.aiOutput || {};

                 // Calculations (same as before)
                 const userName = personalInfo.userName || 'User';
                 const totalIncome = (income.mainJobIncome || 0) + (income.secondJob || 0) + (income.otherIncome || 0);
                 const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + (val || 0), 0);
                 const netCashFlow = totalIncome - totalExpenses;
                 const totalSavings = (savings.emergency || 0) + (savings.savings || 0) + (savings.retirement || 0);
                 const totalDebt = debts.reduce((sum, debt) => sum + (debt.balance || 0), 0);
                 const netWorth = totalSavings - totalDebt;
                 const savingsRate = totalIncome > 0 ? (netCashFlow / totalIncome) * 100 : 0;
                 const emergencyFundCoverage = totalExpenses > 0 ? (savings.emergency || 0) / totalExpenses : 0;

                 // Populate Header (same as before)
                 document.getElementById('userNameDisplay').textContent = userName;
                 document.getElementById('dashboard-subtitle').textContent = `Your Personalized Financial Insights for ${userName}`;

                 // Populate Key Metrics (same logic as before, check element existence)
                 const netCashFlowEl = document.getElementById('netCashFlow');
                 const cashFlowProgressEl = document.getElementById('cashFlowProgress');
                 const cashFlowMessageEl = document.getElementById('cashFlowMessage');
                 if (netCashFlowEl && cashFlowProgressEl && cashFlowMessageEl) {
                     // ... (net cash flow display logic same as before) ...
                      netCashFlowEl.textContent = formatCurrency(netCashFlow);
                      if (netCashFlow > 0) { netCashFlowEl.className = 'stat-value block mb-2 text-success'; cashFlowProgressEl.className = 'h-2.5 rounded-full bg-green-500'; cashFlowMessageEl.textContent = `Positive cash flow of ${formatCurrency(netCashFlow)}.`; cashFlowMessageEl.className = 'text-xs text-green-600'; cashFlowProgressEl.style.width = totalIncome > 0 ? `${Math.min(savingsRate, 100)}%` : '0%';
                      } else if (netCashFlow < 0) { netCashFlowEl.className = 'stat-value block mb-2 text-danger'; cashFlowProgressEl.className = 'h-2.5 rounded-full bg-red-500'; cashFlowMessageEl.textContent = `Negative cash flow of ${formatCurrency(Math.abs(netCashFlow))}.`; cashFlowMessageEl.className = 'text-xs text-red-600'; const deficitRate = totalIncome > 0 ? Math.min((Math.abs(netCashFlow) / totalIncome) * 100, 100) : totalExpenses > 0 ? 100 : 0; cashFlowProgressEl.style.width = `${deficitRate}%`;
                      } else { netCashFlowEl.className = 'stat-value block mb-2 text-gray-700'; cashFlowProgressEl.className = 'h-2.5 rounded-full bg-blue-500'; cashFlowMessageEl.textContent = 'Income equals expenses.'; cashFlowMessageEl.className = 'text-xs text-blue-600'; cashFlowProgressEl.style.width = '50%'; }
                 }
                 document.getElementById('savingsRate').textContent = formatPercentage(savingsRate);
                 document.getElementById('netWorth').textContent = formatCurrency(netWorth);
                 document.getElementById('emergencyFundCoverage').textContent = `${emergencyFundCoverage.toFixed(1)} months`;
                  const savingsRateEl = document.getElementById('savingsRate'); // Style Savings Rate
                  if(savingsRateEl) { if (savingsRate < 5) savingsRateEl.className = 'stat-value block mb-2 text-danger'; else if (savingsRate < 15) savingsRateEl.className = 'stat-value block mb-2 text-warning'; else savingsRateEl.className = 'stat-value block mb-2 text-success'; }


                 // Populate Income Breakdown (same as before)
                 document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
                 const incomeBreakdownEl = document.getElementById('incomeBreakdown');
                 incomeBreakdownEl.innerHTML = ''; let incomeItems = 0;
                 if (income.mainJobIncome > 0) { incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Main Job</span><span class="breakdown-value">${formatCurrency(income.mainJobIncome)}</span></div>`; }
                 if (income.secondJob > 0) { incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Second Job</span><span class="breakdown-value">${formatCurrency(income.secondJob)}</span></div>`; }
                 if (income.otherIncome > 0) { incomeItems++; incomeBreakdownEl.innerHTML += `<div><span class="breakdown-label">Other Income</span><span class="breakdown-value">${formatCurrency(income.otherIncome)}</span></div>`; }
                 if (incomeItems === 0) { incomeBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm italic">No income sources provided.</p>'; }

                 // Populate Expenses Breakdown (same as before)
                 document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
                 const expensesBreakdownEl = document.getElementById('expensesBreakdown');
                 expensesBreakdownEl.innerHTML = ''; let expenseItems = 0; const expenseOrder = ['housing', 'taxes', 'transportation', 'groceriesEssentials', 'insurance', 'utilities', 'medical', 'care', 'subscriptions'];
                  expenseOrder.forEach(key => { if (expenses[key] > 0) { expenseItems++; const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()).replace('Essentials','& Essentials'); expensesBreakdownEl.innerHTML += `<div><span class="breakdown-label">${label}</span><span class="breakdown-value">${formatCurrency(expenses[key])}</span></div>`; } });
                  Object.entries(expenses).forEach(([key, value]) => { if (value > 0 && !expenseOrder.includes(key)) { expenseItems++; const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); expensesBreakdownEl.innerHTML += `<div><span class="breakdown-label">${label}</span><span class="breakdown-value">${formatCurrency(value)}</span></div>`; } });
                 if (expenseItems === 0) { expensesBreakdownEl.innerHTML = '<p class="text-gray-500 text-sm italic">No expense details provided.</p>'; }


                 // Populate AI Insights & Summary
                 renderSummaryAndRecommendations(data);
                 populateAISections(aiOutput);

                 // Render Charts
                 renderIncomeExpenseChart(income, expenses);
                 renderSavingsDebtChart(savings, debts, totalSavings, totalDebt);

                 // Final Display Tweaks
                 document.getElementById('loadingSpinner').classList.add('hidden');
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('mainContent').classList.remove('hidden');
                 console.log("--- renderDashboard END ---");

            } catch (err) {
                console.error("--- renderDashboard ERROR ---", err);
                // Attempt to show error via handleError, but might fail if DOM is broken
                 try { handleError("Error during dashboard rendering", err); } catch { console.error("!!! FAILED TO SHOW ERROR MESSAGE !!!"); }
            }
        }

        // --- RENDER SUMMARY & RECOMMENDATIONS --- (Same as before)
         function renderSummaryAndRecommendations(data) { /* ... function code remains the same ... */
              const { userInput, aiOutput } = data;
             const { personalInfo, income, expenses, savings, debts } = userInput || {};
             const userName = personalInfo?.userName || 'User';
             const totalIncome = (income?.mainJobIncome || 0) + (income?.secondJob || 0) + (income?.otherIncome || 0);
             const totalExpenses = Object.values(expenses || {}).reduce((sum, val) => sum + (val || 0), 0);
             const netCashFlow = totalIncome - totalExpenses;
             const totalSavings = (savings?.emergency || 0) + (savings?.savings || 0) + (savings?.retirement || 0);
             const totalDebt = (debts || []).reduce((sum, debt) => sum + (debt.balance || 0), 0);
             const emergencyFund = savings?.emergency || 0;
             const emergencyMonths = totalExpenses > 0 ? emergencyFund / totalExpenses : 0;

             let summaryHTML = `
                 <h3 class="text-lg font-semibold mb-3">Financial Snapshot for ${userName}</h3>
                 <div class="space-y-4">
                     <p>Here's a quick overview based on the data provided:</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                         <div>
                             <h4 class="font-semibold mb-2 text-indigo-700">Monthly Flow</h4>
                             <ul class="list-disc pl-5 space-y-1 text-sm">
                                 <li>Total Income: <span class="font-medium">${formatCurrency(totalIncome)}</span></li>
                                 <li>Total Expenses: <span class="font-medium">${formatCurrency(totalExpenses)}</span></li>
                                 <li>Net Cash Flow: <span class="font-medium ${netCashFlow >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netCashFlow)}</span></li>
                             </ul>
                         </div>
                         <div>
                             <h4 class="font-semibold mb-2 text-indigo-700">Assets & Liabilities</h4>
                             <ul class="list-disc pl-5 space-y-1 text-sm">
                                 <li>Total Savings: <span class="font-medium">${formatCurrency(totalSavings)}</span> (Incl. Retirement)</li>
                                 <li>Emergency Fund: <span class="font-medium">${formatCurrency(emergencyFund)}</span> (${emergencyMonths.toFixed(1)} months coverage)</li>
                                 <li>Total Debt: <span class="font-medium">${formatCurrency(totalDebt)}</span></li>
                                 <li>Est. Net Worth: <span class="font-medium">${formatCurrency(totalSavings - totalDebt)}</span></li>
                             </ul>
                         </div>
                     </div>
                     <div class="mt-6 pt-4 border-t">
                         <h4 class="font-semibold mb-2 text-indigo-700">Key Recommendations</h4>
                         <ul class="list-disc pl-5 space-y-2 text-sm">`;

              // Dynamic Recommendations (same logic as before)
             if (netCashFlow < 0) { summaryHTML += `<li class="text-danger"><strong class="font-semibold">Address Negative Cash Flow:</strong> Your expenses (${formatCurrency(totalExpenses)}) exceed your income (${formatCurrency(totalIncome)}). Review all expense categories...</li>`; }
             else { const savingsRate = totalIncome > 0 ? (netCashFlow / totalIncome) * 100 : 0; if (savingsRate < 10) { summaryHTML += `<li class="text-warning"><strong class="font-semibold">Boost Savings Rate:</strong> Your current rate (${formatPercentage(savingsRate)}) is below 15-20%...</li>`; } else if (savingsRate < 20) { summaryHTML += `<li class="text-success"><strong class="font-semibold">Good Cash Flow:</strong> Positive flow (${formatCurrency(netCashFlow)})...</li>`; } else { summaryHTML += `<li class="text-success"><strong class="font-semibold">Excellent Cash Flow:</strong> Strong rate (${formatPercentage(savingsRate)})...</li>`; } }
             if (emergencyMonths < 3) { summaryHTML += `<li class="text-warning"><strong class="font-semibold">Build Emergency Fund:</strong> Fund (${formatCurrency(emergencyFund)}) covers ${emergencyMonths.toFixed(1)} months... Target 3-6 months...</li>`; } else if (emergencyMonths < 6) { summaryHTML += `<li class="text-success"><strong class="font-semibold">Strengthen Emergency Fund:</strong> ${emergencyMonths.toFixed(1)} months coverage... Continue towards 6 months...</li>`; } else { summaryHTML += `<li class="text-success"><strong class="font-semibold">Solid Emergency Fund:</strong> Covers ${emergencyMonths.toFixed(1)} months...</li>`; }
             const highInterestDebt = (debts || []).find(d => d.balance > 0 && d.interestRate > 10);
             if (highInterestDebt) { summaryHTML += `<li class="text-danger"><strong class="font-semibold">Prioritize High-Interest Debt:</strong> Debt over 10% (e.g., ${highInterestDebt.type} at ${highInterestDebt.interestRate}% interest)...</li>`; } else if (totalDebt > 0) { summaryHTML += `<li class="text-warning"><strong class="font-semibold">Manage Debt:</strong> Total debt ${formatCurrency(totalDebt)}...</li>`; } else { summaryHTML += `<li class="text-success"><strong class="font-semibold">Debt-Free:</strong> Congratulations!...</li>`; }

             summaryHTML += `</ul></div></div>`;
             document.getElementById('summaryContent').innerHTML = summaryHTML;
         }

        // --- POPULATE AI SECTIONS --- (Same as before)
         function populateAISections(aiOutput) { /* ... function code remains the same ... */
             const analysis = aiOutput?.analysis?.trim();
             const recommendations = aiOutput?.recommendations?.trim();
             const progress = aiOutput?.userProgress?.trim();
              const analysisEl = document.getElementById('aiAnalysisContent');
              const analysisSectionEl = document.getElementById('aiAnalysisSection');
              const recsEl = document.getElementById('aiRecommendationsContent');
              const recsSectionEl = document.getElementById('aiRecommendationsSection');
              const progressEl = document.getElementById('aiProgressContent');
              const progressSectionEl = document.getElementById('aiProgressSection');

              if (analysis && analysisEl && analysisSectionEl) { analysisEl.textContent = analysis; analysisSectionEl.classList.remove('hidden'); }
              else if (analysisSectionEl) { analysisSectionEl.classList.add('hidden'); }

              if (recommendations && recsEl && recsSectionEl) { recsEl.innerHTML = recommendations.replace(/\n/g, '<br>'); recsSectionEl.classList.remove('hidden'); }
              else if(recsSectionEl) { recsSectionEl.classList.add('hidden'); }

              if (progress && progressEl && progressSectionEl) { progressEl.textContent = progress; progressSectionEl.classList.remove('hidden'); }
              else if(progressSectionEl) { progressSectionEl.classList.add('hidden'); }
         }

        // --- RENDER CHARTS --- (Same as before)
         function renderIncomeExpenseChart(incomeData, expenseData) { /* ... function code remains the same ... */
              const chartElement = document.getElementById('incomeExpenseChart');
             try {
                 const totalIncome = (incomeData.mainJobIncome || 0) + (incomeData.secondJob || 0) + (incomeData.otherIncome || 0);
                 const totalExpenses = Object.values(expenseData || {}).reduce((sum, val) => sum + (val || 0), 0);
                 if (totalIncome === 0 && totalExpenses === 0) { chartElement.innerHTML = '<p class="text-center text-gray-500 pt-10">No income or expense data.</p>'; return; }
                 const traceIncome = { x: ['Income'], y: [totalIncome], name: 'Total Income', type: 'bar', marker: { color: '#10b981' }, width: 0.4 };
                 const traceExpenses = { x: ['Expenses'], y: [totalExpenses], name: 'Total Expenses', type: 'bar', marker: { color: '#ef4444' }, width: 0.4 };
                 const layout = { title: 'Monthly Income vs. Expenses', yaxis: { title: 'Amount (USD)', tickprefix: '$', separatethousands: true }, barmode: 'group', showlegend: true, legend: { x: 0.1, y: -0.2, orientation: 'h' }, margin: { l: 60, r: 30, t: 60, b: 50 }, font: { family: 'Inter, sans-serif', size: 12 } };
                 Plotly.newPlot(chartElement, [traceIncome, traceExpenses], layout, {responsive: true});
             } catch(err) { console.error("Error rendering Income/Expense chart:", err); chartElement.innerHTML = '<p class="text-center text-danger pt-10">Chart Error.</p>'; }
         }
         function renderSavingsDebtChart(savingsData, debtData, totalSavings, totalDebt) { /* ... function code remains the same ... */
             const chartElement = document.getElementById('savingsDebtChart');
              try {
                  const validSavings = Object.entries(savingsData || {}).filter(([key, value]) => value > 0).map(([key, value]) => ({ label: key.charAt(0).toUpperCase() + key.slice(1), value: value }));
                  const validDebts = (debtData || []).filter(debt => debt.balance > 0).map(debt => ({ label: debt.type, value: debt.balance }));
                  if (validSavings.length === 0 && validDebts.length === 0) { chartElement.innerHTML = '<p class="text-center text-gray-500 pt-10">No savings or debt data.</p>'; return; }
                 const traceSavings = { x: validSavings.map(item => item.label), y: validSavings.map(item => item.value), name: 'Savings', type: 'bar', marker: { color: '#34d399' } };
                  const traceDebt = { x: validDebts.map(item => item.label), y: validDebts.map(item => item.value), name: 'Debt', type: 'bar', marker: { color: '#f87171' } };
                 const layout = { title: 'Savings Accounts vs. Debts', yaxis: { title: 'Amount (USD)', tickprefix: '$', separatethousands: true }, barmode: 'group', showlegend: true, legend: { x: 0.1, y: -0.2, orientation: 'h' }, margin: { l: 60, r: 30, t: 60, b: 80 }, font: { family: 'Inter, sans-serif', size: 12 } };
                 Plotly.newPlot(chartElement, [traceSavings, traceDebt], layout, {responsive: true});
             } catch(err) { console.error("Error rendering Savings/Debt chart:", err); chartElement.innerHTML = '<p class="text-center text-danger pt-10">Chart Error.</p>'; }
         }

    </script>
</body>
</html>

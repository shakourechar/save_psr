<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartWealth Navigator - Enhanced Financial Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <style>
        :root {
            --sw-primary-accent: #4f46e5; /* Indigo-600 */
            --sw-secondary-accent: #10b981; /* Emerald-500 */
            --sw-text-dark: #111827; /* Gray-900 */
            --sw-text-medium: #374151; /* Gray-700 */
            --sw-text-light: #6b7280; /* Gray-500 */
            --sw-bg-main: #f7f8fc; /* Slightly blueish gray */
            --sw-bg-card: #ffffff;
            --sw-border-light: #e5e7eb; /* Gray-200 */
            --sw-border-medium: #d1d5db; /* Gray-300 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--sw-bg-main);
            color: var(--sw-text-medium);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .header-font { font-family: 'EB Garamond', serif; color: var(--sw-text-dark); }
        .main-container { max-width: 1400px; margin: 2rem auto; padding: 1.5rem 2rem; }
        .dashboard-card {
             background-color: var(--sw-bg-card);
             border-radius: 12px; /* Slightly more rounded */
             box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
             padding: 1.75rem; /* Increased padding */
             transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
             margin-bottom: 2rem;
             border: 1px solid var(--sw-border-light);
        }
        .dashboard-card:hover {
            /* transform: translateY(-3px); */ /* Optional hover effect */
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.08); /* Subtle accent shadow */
        }
        .stat-value { font-size: 1.75rem; font-weight: 600; line-height: 1.2; }
        .stat-label { font-size: 0.9rem; color: var(--sw-text-light); margin-bottom: 0.25rem; display: block; }
        .card-header {
             font-family: 'Inter', sans-serif;
             font-size: 1.2rem; /* Slightly larger */
             font-weight: 600;
             color: var(--sw-text-dark);
             margin-bottom: 1.25rem;
             border-bottom: 1px solid var(--sw-border-light);
             padding-bottom: 0.75rem;
        }
        /* Breakdown Lists */
        .breakdown-list div { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6; }
        .breakdown-list div:last-child { border-bottom: none; }
        .breakdown-label { font-size: 0.9rem; color: var(--sw-text-light); }
        .breakdown-value { font-weight: 500; color: var(--sw-text-medium); }
        /* Buttons */
        .action-button { background-color: var(--sw-primary-accent); color: white; padding: 0.7rem 1.4rem; border-radius: 8px; font-weight: 500; transition: background-color 0.2s ease, box-shadow 0.2s ease; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2); }
        .action-button:hover { background-color: #4338ca; /* Indigo-700 */ box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .action-button:disabled { background-color: #a5b4fc; /* Indigo-300 */ cursor: not-allowed; box-shadow: none;}
        .secondary-button { background-color: #eef2ff; /* Indigo-50 */ color: var(--sw-primary-accent); padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 500; transition: background-color 0.2s ease; border: 1px solid #c7d2fe; /* Indigo-200 */ cursor: pointer; }
        .secondary-button:hover { background-color: #e0e7ff; /* Indigo-100 */ }
        /* Prose Styling */
        .prose { color: var(--sw-text-medium); }
        .prose h3 { font-family: 'Inter', sans-serif; font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--sw-text-dark); }
        .prose h4 { font-family: 'Inter', sans-serif; font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--sw-text-medium); }
        .prose p { margin-bottom: 0.75rem; line-height: 1.7; }
        .prose ul { list-style-position: outside; padding-left: 1.25rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .text-success { color: var(--sw-secondary-accent); } .text-warning { color: #f59e0b; } .text-danger { color: #ef4444; }
        footer { margin-top: 3rem; border-top: 1px solid var(--sw-border-light); padding-top: 1.5rem; color: var(--sw-text-light); }
        #debugInfo table { width: 100%; border-collapse: collapse; font-size: 11px; }
        #debugInfo th, #debugInfo td { text-align: left; border-bottom: 1px solid #ddd; padding: 4px; word-break: break-all; }
        #debugInfo th { background-color: #f0f0f0; }
        #debugInfo strong { display: block; margin-top: 5px; margin-bottom: 2px; font-size: 12px; }

        /* --- Modern Chat Widget Styles --- */
        #chatInterfaceCard {
            /* Subtle gradient background */
            background: linear-gradient(135deg, var(--sw-bg-card) 0%, #f9faff 100%);
            border: 1px solid #e8eafc; /* Lighter border */
        }
        .chat-container {
             display: flex;
             flex-direction: column;
             height: 550px; /* Increased height */
             border: 1px solid var(--sw-border-medium);
             border-radius: 10px; /* Match card */
             overflow: hidden;
             background-color: var(--sw-bg-card); /* Ensure white background */
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }
        .chat-history {
             flex-grow: 1;
             padding: 1.5rem; /* More padding */
             overflow-y: auto;
             background-color: transparent; /* Inherit from container */
             scrollbar-width: thin; /* Firefox */
             scrollbar-color: var(--sw-border-medium) transparent; /* Firefox */
        }
        /* Webkit scrollbar styling */
         .chat-history::-webkit-scrollbar { width: 8px; }
         .chat-history::-webkit-scrollbar-track { background: transparent; }
         .chat-history::-webkit-scrollbar-thumb { background-color: var(--sw-border-medium); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
         .chat-history::-webkit-scrollbar-thumb:hover { background-color: var(--sw-text-light); }

        .chat-message { margin-bottom: 1.25rem; line-height: 1.6; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.assistant { justify-content: flex-start; }

        .message-bubble {
             border-radius: 18px;
             padding: 0.8rem 1.1rem;
             max-width: 75%; /* Slightly wider */
             box-shadow: 0 2px 4px rgba(0,0,0,0.05);
             word-wrap: break-word;
        }
        .chat-message.user .message-bubble {
             background: linear-gradient(135deg, var(--sw-primary-accent) 0%, #6366f1 100%); /* Indigo gradient */
             color: white;
             border-radius: 18px 18px 4px 18px; /* Slightly asymmetric */
        }
        .chat-message.assistant .message-bubble {
             background-color: #eef2ff; /* Indigo-50 */
             color: var(--sw-text-medium);
             border: 1px solid #e0e7ff; /* Indigo-100 */
             border-radius: 18px 18px 18px 4px;
        }
        .message-sender { display: none; /* Hide sender label for cleaner look */ }

        .chat-status {
             font-size: 0.8rem;
             color: var(--sw-text-light);
             padding: 0.5rem 1rem;
             text-align: center;
             height: 25px;
             background-color: #f9fafb; /* Light gray */
             border-top: 1px solid var(--sw-border-light);
        }
        /* Typing Indicator (same as before) */
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background-color: #6b7280; border-radius: 50%; margin: 0 2px; animation: typing 1s infinite ease-in-out; }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; } .typing-indicator span:nth-child(2) { animation-delay: 0.1s; } .typing-indicator span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .chat-input-area {
             border-top: 1px solid var(--sw-border-light);
             padding: 0.75rem 1rem;
             background-color: #f9fafb; /* Lightest gray */
             display: flex;
             align-items: center;
             gap: 0.75rem; /* Gap between textarea and button */
        }
        .chat-input-area textarea {
             flex-grow: 1;
             padding: 0.7rem 1rem;
             border: 1px solid var(--sw-border-medium);
             border-radius: 20px; /* Pill shape */
             resize: none;
             font-size: 0.95rem;
             line-height: 1.4;
             height: 44px; /* Fixed height */
             background-color: white;
             transition: border-color 0.2s ease, box-shadow 0.2s ease;
             outline: none;
        }
        .chat-input-area textarea:focus {
             border-color: var(--sw-primary-accent);
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .chat-input-area button {
             padding: 0.6rem 1rem;
             white-space: nowrap;
             flex-shrink: 0; /* Prevent button shrinking */
             border-radius: 20px; /* Match textarea */
        }

    </style>
</head>
<body class="min-h-screen">
    <pre id="embeddedPsrData" style="display: none;">/* MAKE_COM_JSON_PLACEHOLDER */</pre>

    <div id="loadingSpinner" class="fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-90 z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-gray-700 text-lg">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="errorMessage" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white bg-opacity-95 z-50 p-4">
        <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-5 rounded-lg max-w-lg shadow-md">
            <h3 class="font-bold text-xl mb-3 header-font">Error Loading Dashboard</h3>
            <p id="errorText" class="mb-4">Unable to load financial data. Please check the URL or try again later.</p>
            <div id="debugInfo" class="mb-4 max-h-60 overflow-auto bg-gray-100 p-3 rounded text-xs border border-gray-300">Initializing debug info...</div>
            <div class="flex justify-center space-x-3 mt-4">
                <button id="retryButton" class="action-button">Retry Loading</button>
                <button id="manualEntryButton" class="secondary-button">Use Demo Data</button>
            </div>
        </div>
    </div>

    <div id="mainContent" class="main-container hidden">
        <header class="mb-10 border-b border-gray-200 pb-6">
             <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                 <div>
                     <h1 id="dashboard-title" class="header-font text-4xl md:text-5xl font-bold text-gray-800 mb-1">SmartWealth Navigator</h1>
                     <p id="dashboard-subtitle" class="text-gray-600 text-lg">Your Personalized Financial Insights</p>
                 </div>
                 <div class="mt-4 md:mt-0 text-sm text-gray-500">
                      Data for: <span id="userNameDisplay" class="font-semibold text-gray-700">User</span> | Last Updated: <span id="updateDate">Today</span>
                 </div>
             </div>
        </header>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Key Financial Metrics</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Monthly Net Cash Flow</h3>
                     <div class="text-center mt-2">
                         <span id="netCashFlow" class="stat-value block mb-2">$0</span>
                         <div class="bg-gray-200 h-2.5 rounded-full mb-3"><div id="cashFlowProgress" class="h-2.5 rounded-full" style="width: 0%"></div></div>
                         <p id="cashFlowMessage" class="text-xs text-gray-500 h-8"></p>
                     </div>
                 </div>
                 <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Savings Rate</h3>
                     <div class="text-center mt-2"><span id="savingsRate" class="stat-value block mb-2">0%</span><p class="text-xs text-gray-500 mt-3">(Net Cash Flow / Total Income)</p></div>
                 </div>
                  <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Estimated Net Worth</h3>
                     <div class="text-center mt-2"><span id="netWorth" class="stat-value block mb-2">$0</span><p class="text-xs text-gray-500 mt-3">(Total Savings - Total Debt)</p></div>
                 </div>
                  <div class="dashboard-card p-5">
                     <h3 class="card-header text-base">Emergency Fund</h3>
                     <div class="text-center mt-2"><span id="emergencyFundCoverage" class="stat-value block mb-2">0 months</span><p class="text-xs text-gray-500 mt-3">(Emergency Savings / Monthly Expenses)</p></div>
                 </div>
             </div>
        </section>

        <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Income & Expenses Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="dashboard-card">
                    <h3 class="card-header">Monthly Income Breakdown</h3>
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                        <span class="stat-label font-semibold">Total Income</span><span id="totalIncome" class="stat-value text-green-600">$0</span>
                    </div>
                    <div id="incomeBreakdown" class="space-y-2 breakdown-list"><p class="text-gray-500 text-sm">Loading income details...</p></div>
                </div>
                <div class="dashboard-card">
                     <h3 class="card-header">Monthly Expenses Breakdown</h3>
                     <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                         <span class="stat-label font-semibold">Total Expenses</span><span id="totalExpenses" class="stat-value text-red-600">$0</span>
                     </div>
                     <div id="expensesBreakdown" class="space-y-1 breakdown-list max-h-60 overflow-y-auto pr-2"><p class="text-gray-500 text-sm">Loading expense details...</p></div>
                </div>
            </div>
        </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">Visualizations</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div class="dashboard-card"><h3 class="card-header">Income vs. Expenses</h3><div id="incomeExpenseChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart will load here.</p></div></div>
                 <div class="dashboard-card"><h3 class="card-header">Savings & Debt Overview</h3><div id="savingsDebtChart" class="min-h-[350px]"><p class="text-center text-gray-500 pt-10">Chart will load here.</p></div></div>
             </div>
         </section>

         <section class="mb-10">
             <h2 class="header-font text-2xl font-bold text-gray-800 mb-5">AI Insights & Recommendations</h2>
             <div class="dashboard-card">
                 <div id="summaryContent" class="prose max-w-none prose-indigo"><p class="text-gray-500">Generating financial summary...</p></div>
                  <div id="aiAnalysisSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Analysis</h3><p id="aiAnalysisContent"></p></div>
                  <div id="aiRecommendationsSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">AI Recommendations</h3><p id="aiRecommendationsContent"></p></div>
                  <div id="aiProgressSection" class="mt-6 prose max-w-none prose-indigo hidden"><h3 class="border-t pt-4">User Progress History</h3><p id="aiProgressContent"></p></div>
             </div>
        </section>

        <section id="chatInterfaceCard" class="dashboard-card">
             <h2 class="card-header header-font text-xl font-bold mb-5">Chat with SmartWealth AI</h2>
             <div class="chat-container">
                <div class="chat-history" id="chatHistory">
                    </div>
                <div class="chat-status" id="chatStatus"></div>
                <div class="chat-input-area">
                    <textarea id="chatInput" placeholder="Ask about your finances..." rows="1" disabled></textarea>
                    <button id="chatSendButton" class="action-button" disabled>
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"> <path d="M3.105 3.105a1.5 1.5 0 011.995-.04l8 4a1.5 1.5 0 010 2.87l-8 4a1.5 1.5 0 01-1.995-.04L1.6 13.89a1.5 1.5 0 01-.04-1.995l3-4a1.5 1.5 0 010-1.79l-3-4a1.5 1.5 0 01.04-1.995l1.5-1.5z" /> </svg>
                         <span class="sr-only">Send</span> </button>
                </div>
             </div>
        </section>

        <footer class="text-center text-gray-500 text-sm py-6">
            <p>SmartWealth Navigator &copy; 2025 | Built by Socialeap™️</p>
            <p>This is a financial overview tool. Consult with a qualified financial advisor for personalized advice.</p>
        </footer>
    </div>

    <script>
        // --- Global Variables ---
        let dashboardData = null; // Stores the main financial data object
        let chatMessages = []; // Stores the conversation history for API calls
        const CHAT_MODEL = 'gpt-4o-mini'; // For backend reference if needed

  // --- Supabase Client (CONFIGURE THESE) ---
const SUPABASE_URL = 'https://tfnwwpksieluzvxqdiiq.supabase.co/functions/v1/smooth-function'; // <-- Make sure this has your URL
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbnd3cGtzaWVsdXp2eHFkaWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1ODQ3MjgsImV4cCI6MjA2MDE2MDcyOH0.xbtjiQ65vCggjj35qtlCZ0S5mJa4muSZcHXhaU4qvrE'; // <-- Make sure this has your Key
let supabase = null; // Keep this variable global within the script scope
try {
    // Check if credentials are set
    if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
        throw new Error("Supabase URL is not configured in the script.");
    }
    if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        throw new Error("Supabase Anon Key is not configured in the script.");
    }

    // Check if the Supabase library loaded and exposed the global object and function
    // Use window.supabase to be explicit about checking the global scope
    if (typeof window.supabase === 'undefined' || !window.supabase || typeof window.supabase.createClient !== 'function') {
         console.error("Supabase library (supabase-js@2) did not load correctly or 'createClient' is not available.");
         throw new Error("Supabase library failed to load. Check the script tag in <head> and network requests.");
    }

    // --- *** Correct Initialization *** ---
    // Use the globally available createClient function from the loaded library
    const { createClient } = window.supabase;
    // Assign the created client instance to your 'supabase' variable
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // --- *** End Correct Initialization *** ---

    console.log("Supabase client initialized successfully.");

} catch (error) {
    console.error("Error during Supabase client initialization:", error);
    // Call handleError, which will show the specific error (URL/Key missing, library load fail, etc.)
    handleError("Failed to initialize backend connection", error);
    // We might want to prevent further execution or disable chat here
    // e.g., enableChatInput(false); // Assuming this function exists and handles null elements
}


        // --- Utility Functions ---
        function formatCurrency(value) {
             if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }
        function formatPercentage(value) {
            if (isNaN(value) || !isFinite(value)) return '0%';
             return `${value.toFixed(1)}%`;
        }

        // --- Data Loading and Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
             const today = new Date();
            document.getElementById('updateDate').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('retryButton').addEventListener('click', function() {
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('loadingSpinner').classList.remove('hidden');
                 setTimeout(initializeDashboard, 500);
             });
             document.getElementById('manualEntryButton').addEventListener('click', function() {
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('loadingSpinner').classList.remove('hidden');
                 useDemoData();
             });
             initializeDashboard();
        });

        // Debug function
        function debugURLParameters() {
             const params = new URLSearchParams(window.location.search);
             let debugInfoEl = document.getElementById('debugInfo');
             if (!debugInfoEl) return '';
             let paramsText = '<strong>URL Query String:</strong><br>';
             paramsText += `<code style="font-size: 10px; word-break: break-all;">${window.location.search || '(empty)'}</code><br>`;
             paramsText += '<strong>Parsed Parameters:</strong><br>';
             if (params.toString() === '') {
                 paramsText += '<span style="color: orange;">No URL parameters detected!</span><br>';
             } else {
                 paramsText += '<table><thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody>';
                 for (const [key, value] of params.entries()) {
                     paramsText += `<tr><td>${key}</td><td>${value || '<i style="color: gray;">(empty)</i>'}</td></tr>`;
                 }
                 paramsText += '</tbody></table>';
             }
             debugInfoEl.innerHTML = paramsText;
             return paramsText;
        }
        // Error handler
        function handleError(message, error) {
            console.error("HANDLE ERROR:", message, error);
            const debugContent = debugURLParameters();
             const debugInfoEl = document.getElementById('debugInfo');
             if (debugInfoEl && debugInfoEl.innerHTML.includes('Initializing')) {
                  debugInfoEl.innerHTML = debugContent || 'Could not retrieve URL parameters.';
             } else if (debugInfoEl) {
                  debugInfoEl.innerHTML += `<br><strong>Error:</strong><br><span style="color: red;">${message}. ${error?.message || 'Check console.'}</span>`;
             }
            document.getElementById("errorText").innerText = `${message}. ${error?.message || 'See debug info or console.'}`;
            document.getElementById("errorMessage").classList.remove("hidden");
            document.getElementById("loadingSpinner").classList.add("hidden");
            document.getElementById("mainContent").classList.add("hidden");
        }
        // Demo data loader
        function useDemoData() {
             console.log("Using Demo Data");
             const demoData = { /* ... same demo data ... */ };
             renderDashboard(demoData);
        }

       // **Initialize dashboard: Load data from URL -> Embedded -> Demo (REVISED LOGIC)**
    function initializeDashboard() {
        const params = new URLSearchParams(window.location.search);
        const dataElement = document.getElementById('embeddedPsrData');
        let dataLoaded = false;
        let rawData = {}; // Use a temporary object

        // --- Log Initial State ---
        console.log("--- initializeDashboard START ---");
        debugURLParameters(); // Log params immediately for debugging

        // --- Initialize Supabase Client FIRST ---
        // (Moved initialization before the main data processing try...catch)
        // Use the global 'supabase' variable defined earlier in the script
        try {
             // Check if credentials are set
             if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                 throw new Error("Supabase URL is not configured in the script.");
             }
             if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                 throw new Error("Supabase Anon Key is not configured in the script.");
             }

             // Check if the Supabase library loaded correctly
             if (typeof window.supabase === 'undefined' || !window.supabase || typeof window.supabase.createClient !== 'function') {
                 console.error("Supabase library (supabase-js@2) did not load correctly or 'createClient' is not available.");
                 throw new Error("Supabase library failed to load. Check the script tag in <head> and network requests.");
             }

             // --- Correct Initialization ---
             // Use the globally available createClient function
             const { createClient } = window.supabase;
             // Assign the created client instance to the global 'supabase' variable
             // Note: Ensure 'supabase' was declared with 'let' outside this function if needed globally
             // If 'supabase' is only needed within chat functions called later, this is fine.
             supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
             // --- End Correct Initialization ---

             console.log("Supabase client initialized successfully.");

        } catch (error) {
             console.error("Error during Supabase client initialization:", error);
             // Call handleError, which will show the error message and stop full loading
             handleError("Failed to initialize backend connection", error);
             // Stop further execution in initializeDashboard if Supabase fails
             return;
        }
        // --- End Supabase Initialization ---


        // --- Now, try processing URL/Embedded data ---
        try {
            // --- Flexible Parameter Getter ---
             const getParam = (keyBase) => {
                 const keyBaseLower = keyBase.toLowerCase();
                 let foundValue = null;
                  // console.log(`getParam: Searching for base key "${keyBase}"`); // Optional: uncomment for extreme debug
                 for (const currentKey of params.keys()) {
                     const currentKeyLower = currentKey.toLowerCase();
                     if (currentKeyLower === keyBaseLower) { foundValue = params.get(currentKey); break; }
                     const jotformPattern = new RegExp(`^q\\d+_${keyBaseLower}$`, 'i');
                     if (jotformPattern.test(currentKeyLower)) { foundValue = params.get(currentKey); break; }
                     if (currentKeyLower.endsWith(keyBaseLower) && foundValue === null) { foundValue = params.get(currentKey); } // Less specific fallback
                 }
                 // if (foundValue === null) { console.log(`getParam: No matching parameter found for "${keyBase}"`); } // Optional
                 return foundValue;
             };

            // --- Helper to safely parse numbers ---
             const parseNumeric = (keyName, value, defaultValue = 0) => {
                 // console.log(`parseNumeric: Parsing key "${keyName}", value: "${value}"`); // Optional
                 if (value === null || typeof value === 'undefined' || String(value).trim() === '') { return defaultValue; }
                 if (typeof value === 'number') { return isNaN(value) ? defaultValue : value; }
                 if (typeof value !== 'string') { return defaultValue; }
                 const cleaned = value.trim().replace(/[^0-9.-]+/g, '');
                 if (cleaned === '' || cleaned === '-' || cleaned === '.') { return defaultValue; }
                 const number = parseFloat(cleaned);
                 return isNaN(number) ? defaultValue : number;
             };

            // --- Attempt to Load from URL ---
             console.log("--- Parsing URL Parameters ---");
             if (params.toString().length > 0) {
                // ... (Code to fetch all parameters using getParam/parseNumeric remains the same) ...
                const fetchedUserName=getParam('userName')||getParam('username'); const fetchedAge=parseNumeric('age',getParam('age')); const fetchedMainJobIncome=parseNumeric('mainJobIncome',getParam('mainJobIncome')); const fetchedSecondJobIncome=parseNumeric('secondJobIncome',getParam('secondJobIncome')||getParam('secondJob')); const fetchedOtherIncome=parseNumeric('otherIncome',getParam('otherIncome')); const fetchedHousing=parseNumeric('housing',getParam('housing')); const fetchedTransportation=parseNumeric('transportation',getParam('transportation')); const fetchedUtilities=parseNumeric('utilities',getParam('utilities')); const fetchedGroceries=parseNumeric('groceries-essentials',getParam('groceries-essentials')||getParam('groceries')); const fetchedInsurance=parseNumeric('insurance',getParam('insurance')); const fetchedMedical=parseNumeric('medical',getParam('medical')); const fetchedCare=parseNumeric('care',getParam('care')); const fetchedSubscriptions=parseNumeric('subscriptions',getParam('subscriptions')); const fetchedTaxes=parseNumeric('taxes',getParam('taxes')); const fetchedEmergencySavings=parseNumeric('emergencySavings',getParam('emergencySavings')||getParam('emergency')); const fetchedCurrentSavings=parseNumeric('currentSavings',getParam('currentSavings')||getParam('savings')); const fetchedRetirementFund=parseNumeric('retirementFund',getParam('retirementFund')||getParam('retirement')); const fetchedCreditCardDebt=parseNumeric('creditCardDebt',getParam('creditCardDebt')||getParam('creditcard')); const fetchedBankLoans=parseNumeric('bankLoans',getParam('bankLoans')||getParam('loans'));
                const decodeAIField=(fieldName)=>{ const val=getParam(fieldName); if(!val)return''; try{ const decoded=decodeURIComponent(val); return decoded; }catch(e){ console.warn(`Decode URI fail for ${fieldName}`,e); return val; } }; const fetchedAnalysis=decodeAIField('aiAnalysis'); const fetchedRecommendations=decodeAIField('recommendations'); const fetchedProgress=decodeAIField('userProgressHistory')||decodeAIField('userProgress');
                rawData = { userInput: { personalInfo: { userName: fetchedUserName||'User', age: fetchedAge||30 }, income: { mainJobIncome: fetchedMainJobIncome, secondJob: fetchedSecondJobIncome, otherIncome: fetchedOtherIncome }, expenses: { housing: fetchedHousing, transportation: fetchedTransportation, utilities: fetchedUtilities, groceriesEssentials: fetchedGroceries, insurance: fetchedInsurance, medical: fetchedMedical, care: fetchedCare, subscriptions: fetchedSubscriptions, taxes: fetchedTaxes }, savings: { emergency: fetchedEmergencySavings, savings: fetchedCurrentSavings, retirement: fetchedRetirementFund }, debts: [ { type: "Credit Card", balance: fetchedCreditCardDebt, interestRate: 22.5, minPayment: 50 }, { type: "Bank Loans", balance: fetchedBankLoans, interestRate: 6.5, minPayment: 100 } ] }, aiOutput: { analysis: fetchedAnalysis, recommendations: fetchedRecommendations, userProgress: fetchedProgress } };


                // --- Validation Check (with Detailed Logging) ---
                 console.log("--- Validating Parsed URL Data ---");
                 const hasIncome = rawData.userInput.income.mainJobIncome > 0 || rawData.userInput.income.secondJob > 0 || rawData.userInput.income.otherIncome > 0;
                 const hasExpenses = Object.values(rawData.userInput.expenses).some(v => v > 0);
                 const hasSavings = Object.values(rawData.userInput.savings).some(v => v > 0);
                 const hasDebt = rawData.userInput.debts.some(d => d.balance > 0);
                 const hasName = !!rawData.userInput.personalInfo.userName && rawData.userInput.personalInfo.userName !== 'User';

                 // Log details before the check
                 console.log("rawData object just before validation:", JSON.stringify(rawData, null, 2));
                 console.log(`Individual validation checks: hasIncome=${hasIncome}, hasExpenses=${hasExpenses}, hasSavings=${hasSavings}, hasDebt=${hasDebt}, hasName=${hasName}`);

                 // Final check
                 if (hasIncome || hasExpenses || hasSavings || hasDebt || hasName) {
                     dashboardData = rawData;
                     dataLoaded = true;
                     console.log(">>> Validation PASSED. Data loaded from URL parameters.");
                 } else {
                     dataLoaded = false;
                     console.warn("!!! Validation FAILED (no significant data or specific username found). `dataLoaded` remains false.");
                 }
                 // --- End Validation Check ---

             } else {
                 console.log("--- No URL parameters detected ---");
             }

            // --- Attempt to Load from Embedded JSON ---
             if (!dataLoaded && dataElement && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
                 console.log("--- Attempting to load data from embedded JSON ---");
                 try {
                     const embeddedJson = JSON.parse(dataElement.textContent);
                     if (typeof embeddedJson === 'object' && embeddedJson !== null && embeddedJson.userInput) {
                         dashboardData = embeddedJson; // Use embedded data
                         dataLoaded = true;
                         console.log(">>> Data successfully loaded from embedded JSON.", dashboardData);
                     } else {
                         console.warn("!!! Embedded content was not valid dashboard JSON.");
                     }
                 } catch (jsonErr) {
                     console.error("!!! Error parsing embedded JSON:", jsonErr);
                     // Don't throw here, allow fallback to demo/error
                 }
             }

            // --- Final Check and Render/Fallback ---
             console.log("--- Final Data Load Check ---");
             if (dataLoaded && dashboardData) {
                 console.log(">>> Proceeding to render dashboard.");
                 renderDashboard(dashboardData); // Render with the loaded data
             } else {
                 console.warn("!!! No valid data loaded from URL or embedded JSON. Triggering error/demo fallback.");
                 throw new Error("No valid financial data found in URL or embedded source."); // Trigger error display
             }
             console.log("--- initializeDashboard END (Success) ---");

        } catch (err) {
             // This catch block handles errors specifically from the data processing part
             console.error("--- initializeDashboard Data Processing ERROR ---", err);
             handleError("Dashboard initialization failed during data processing", err);
             document.getElementById('manualEntryButton')?.classList.remove('hidden');
        }
    } // <-- End of initializeDashboard function

        // --- RENDER DASHBOARD ---
        function renderDashboard(data) {
             try {
                 console.log("--- renderDashboard START ---");
                 dashboardData = data; // Store globally

                 // ... (All the existing code to calculate metrics and populate HTML elements) ...
                 const userInput = data.userInput || {}; const personalInfo = userInput.personalInfo || {}; const income = userInput.income || {}; const expenses = userInput.expenses || {}; const savings = userInput.savings || {}; const debts = userInput.debts || []; const aiOutput = data.aiOutput || {};
                 const userName=personalInfo.userName||'User'; const totalIncome=(income.mainJobIncome||0)+(income.secondJob||0)+(income.otherIncome||0); const totalExpenses=Object.values(expenses).reduce((s,v)=>s+(v||0),0); const netCashFlow=totalIncome-totalExpenses; const totalSavings=(savings.emergency||0)+(savings.savings||0)+(savings.retirement||0); const totalDebt=debts.reduce((s,d)=>s+(d.balance||0),0); const netWorth=totalSavings-totalDebt; const savingsRate=totalIncome>0?(netCashFlow/totalIncome)*100:0; const emergencyFundCoverage=totalExpenses>0?(savings.emergency||0)/totalExpenses:0;
                 document.getElementById('userNameDisplay').textContent = userName; document.getElementById('dashboard-subtitle').textContent=`Personalized Insights for ${userName}`;
                 const netCashFlowEl=document.getElementById('netCashFlow'); const cashFlowProgressEl=document.getElementById('cashFlowProgress'); const cashFlowMessageEl=document.getElementById('cashFlowMessage'); if(netCashFlowEl&&cashFlowProgressEl&&cashFlowMessageEl){/*...net cash flow styling...*/netCashFlowEl.textContent=formatCurrency(netCashFlow); if(netCashFlow > 0){/*...*/}else if(netCashFlow < 0){/*...*/}else{/*...*/}} document.getElementById('savingsRate').textContent=formatPercentage(savingsRate); document.getElementById('netWorth').textContent=formatCurrency(netWorth); document.getElementById('emergencyFundCoverage').textContent=`${emergencyFundCoverage.toFixed(1)} months`; const savingsRateEl=document.getElementById('savingsRate'); if(savingsRateEl){/*...savings rate styling...*/}
                 document.getElementById('totalIncome').textContent = formatCurrency(totalIncome); const incomeBreakdownEl = document.getElementById('incomeBreakdown'); incomeBreakdownEl.innerHTML = ''; let incomeItems=0; /*...populate income breakdown...*/ if(incomeItems === 0){incomeBreakdownEl.innerHTML='...no income...';}
                 document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses); const expensesBreakdownEl = document.getElementById('expensesBreakdown'); expensesBreakdownEl.innerHTML = ''; let expenseItems=0; /*...populate expense breakdown...*/ if(expenseItems === 0){expensesBreakdownEl.innerHTML='...no expenses...';}
                 renderSummaryAndRecommendations(data);
                 populateAISections(aiOutput);
                 renderIncomeExpenseChart(income, expenses);
                 renderSavingsDebtChart(savings, debts, totalSavings, totalDebt);

                 // --- Initialize Chat ---
                 initializeChat(); // Setup chat after rendering

                 // --- Final Display ---
                 document.getElementById('loadingSpinner').classList.add('hidden');
                 document.getElementById('errorMessage').classList.add('hidden');
                 document.getElementById('mainContent').classList.remove('hidden');
                 console.log("--- renderDashboard END ---");

            } catch (err) {
                 console.error("--- renderDashboard ERROR ---", err);
                 handleError("Error rendering dashboard content", err);
            }
        }

        // --- Render Summary, Populate AI, Render Charts ---
        // (These functions remain unchanged from previous versions)
        function renderSummaryAndRecommendations(data) { /* ... unchanged ... */ }
        function populateAISections(aiOutput) { /* ... unchanged ... */ }
        function renderIncomeExpenseChart(incomeData, expenseData) { /* ... unchanged ... */ }
        function renderSavingsDebtChart(savingsData, debtData, totalSavings, totalDebt) { /* ... unchanged ... */ }


        // --- ** CHAT FUNCTIONALITY (Using Backend) ** ---

        function initializeChat() {
            console.log("--- initializeChat START ---");
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatHistory = document.getElementById('chatHistory');
            const chatInterfaceCard = document.getElementById('chatInterfaceCard');

            if (!chatInput || !chatSendButton || !chatHistory || !chatInterfaceCard) {
                console.error("Chat UI elements not found! Cannot initialize chat.");
                return;
            }

            // Show the chat interface card now that it's being initialized
            chatInterfaceCard.classList.remove('hidden');

            // Check if Supabase client is available
            if (!supabase) {
                 addMessageToChat("System", "Chat service connection failed. Please check configuration.", true);
                 enableChatInput(false);
                 chatInput.placeholder = "Chat unavailable";
                 return;
            }

            enableChatInput(true); // Enable if Supabase is ready
            chatHistory.innerHTML = ''; // Clear placeholder
            addMessageToChat("System", "Ask a question about your financial data.", false);

            chatSendButton.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    handleChatSubmit();
                }
            });
            console.log("--- initializeChat END ---");
        }

        function enableChatInput(enabled) {
             const chatInput = document.getElementById('chatInput');
             const chatSendButton = document.getElementById('chatSendButton');
             if(chatInput && chatSendButton) {
                  chatInput.disabled = !enabled;
                  chatSendButton.disabled = !enabled;
                  chatInput.placeholder = enabled ? "Ask about your finances..." : "Chat unavailable";
             }
        }

        function handleChatSubmit() {
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value.trim();
            if (!userMessage || chatSendButton.disabled) return; // Ignore empty or if disabled

            addMessageToChat("User", userMessage);
            chatMessages.push({ role: "user", content: userMessage });
            chatInput.value = '';
            sendToBackendChatFunction(); // Call backend
        }

        function addMessageToChat(sender, message, isError = false) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            if(chatHistory.innerHTML.includes("Ask a question about your financial data.")) {
                 chatHistory.innerHTML = ''; // Clear initial message
            }

            const messageContainer = document.createElement('div');
            messageContainer.classList.add('chat-message', sender.toLowerCase());

            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
             if (isError) { bubble.style.backgroundColor = '#fee2e2'; bubble.style.color = '#b91c1c'; }

            // Basic markdown & link handling
            const linkedMessage = message
                .replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">$1</a>')
                .replace(/\n/g, '<br>');
            bubble.innerHTML = linkedMessage;

            messageContainer.appendChild(bubble);
            chatHistory.appendChild(messageContainer);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll down
        }

         function setChatStatus(message, isLoading = false) {
              const chatStatus = document.getElementById('chatStatus');
              if (!chatStatus) return;
              if (isLoading) {
                   chatStatus.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
              } else {
                   chatStatus.textContent = message;
                   if (message && !message.toLowerCase().includes('error')) {
                        setTimeout(() => { if (chatStatus.textContent === message) { chatStatus.textContent = ''; } }, 3000);
                   }
              }
         }

        // Sends messages to YOUR Supabase Edge Function
        async function sendToBackendChatFunction() {
            if (!dashboardData) { addMessageToChat("System", "Error: Financial data not loaded.", true); return; }
            if (!supabase) { addMessageToChat("System", "Error: Chat service not connected.", true); return; }

             setChatStatus("Thinking...", true);
             enableChatInput(false);

            // --- Construct Context and System Message ---
             let financialContext = `Username: ${dashboardData.userInput?.personalInfo?.userName || 'N/A'}\n`;
             const totalIncome = Object.values(dashboardData.userInput?.income || {}).reduce((s,v)=>s+v,0); const totalExpenses = Object.values(dashboardData.userInput?.expenses || {}).reduce((s,v)=>s+v,0);
             financialContext += `Totals: Income(${formatCurrency(totalIncome)}), Expenses(${formatCurrency(totalExpenses)}), Net(${formatCurrency(totalIncome-totalExpenses)})\n`;
             financialContext += `Savings: Emergency(${formatCurrency(dashboardData.userInput?.savings?.emergency||0)}), General(${formatCurrency(dashboardData.userInput?.savings?.savings||0)}), Retirement(${formatCurrency(dashboardData.userInput?.savings?.retirement||0)})\n`;
             const totalDebt = (dashboardData.userInput?.debts || []).reduce((s,d)=>s+(d.balance || 0),0); financialContext += `Total Debt: ${formatCurrency(totalDebt)}\n`;
             if (dashboardData.aiOutput?.analysis) financialContext += `Prior Analysis: ${dashboardData.aiOutput.analysis}\n`; if (dashboardData.aiOutput?.recommendations) financialContext += `Prior Recs: ${dashboardData.aiOutput.recommendations}\n`;

             const systemMessage = { role: "system", content: `You are SmartWealth AI. Use the financial context below to answer concisely. Context:\n${financialContext}` };
             const messagesForBackend = [systemMessage, ...chatMessages];

            // --- Use the Correct Supabase Function URL ---
            const backendEndpoint = 'https://tfnwwpksieluzvxqdiiq.supabase.co/functions/v1/smooth-function'; // <-- USER'S URL

            console.log(`Sending ${messagesForBackend.length} messages to backend: ${backendEndpoint}`);

            try {
                // Using Supabase client's invoke method (alternative to fetch, handles auth potentially)
                // const { data, error } = await supabase.functions.invoke('smooth-function', { // Function name
                //     body: { messages: messagesForBackend },
                // });
                // Sticking with fetch for directness based on previous code:
                const response = await fetch(backendEndpoint, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         // Supabase edge functions invoked directly often don't need manual apikey if JWT is handled
                         // or if security is based on the invoke method. If your function is set to anon auth,
                         // you might need the anon key header. Test what your function requires.
                          // 'apikey': SUPABASE_ANON_KEY
                     },
                     body: JSON.stringify({ messages: messagesForBackend })
                });

                setChatStatus("", false);

                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({}));
                     console.error("Backend Function Error Response:", errorData);
                     const errorMsg = `Error calling chat backend (${response.status}): ${errorData?.error || response.statusText || 'Unknown error'}`;
                     addMessageToChat("System", errorMsg, true);
                     setChatStatus(`Error: ${response.status}`, false);
                     return;
                }

                const data = await response.json();

                if (data.assistantResponse && data.assistantResponse.content) {
                    const assistantMessage = data.assistantResponse;
                    addMessageToChat("Assistant", assistantMessage.content);
                    chatMessages.push(assistantMessage); // Add valid response to history
                } else {
                     addMessageToChat("System", "Received an unexpected or empty response from the backend.", true);
                     console.warn("Unexpected backend response structure:", data);
                }

            } catch (error) {
                console.error("Error calling backend chat function:", error);
                addMessageToChat("System", `Network error calling backend: ${error.message}`, true);
                setChatStatus("Error", false);
            } finally {
                 enableChatInput(true);
            }
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SmartWealth Navigator - Financial Health Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5; /* Light gray background */
      margin: 0;
      padding: 0;
    }
    h1, h2, h3, h4 {
      font-family: 'EB Garamond', serif;
      color: #333; /* Darker text color */
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #ffffff; /* White background for container */
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    header img {
      height: 60px; /* Adjust logo height */
      margin-right: 15px;
    }
    header h1 {
      color: #2E7D32; /* Primary brand color */
      margin: 0;
      flex-grow: 1; /* Allow title to take available space */
    }
     #saveButton {
       margin-left: auto; /* Push button to the right */
       padding: 8px 16px;
       background-color: #4CAF50; /* Green background */
       color: white;
       border: none;
       border-radius: 4px;
       cursor: pointer;
       font-size: 0.9em;
       transition: background-color 0.3s ease;
     }
     #saveButton:hover {
       background-color: #388E3C; /* Darker green on hover */
     }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card h3 {
      margin-top: 0;
      color: #4CAF50; /* Green headings for cards */
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6); /* Darker overlay */
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 8px;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    #loadingMessage, #errorMessage {
      text-align: center;
      padding: 20px;
      font-size: 1.2em;
      color: #555;
    }
     #errorMessage {
         color: #D32F2F; /* Red color for errors */
         display: none; /* Hidden by default */
     }
     #mainContent {
         display: none; /* Hidden until data loads */
     }
    /* Responsive adjustments */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header h1 {
          margin-top: 10px;
      }
      #saveButton {
          margin-left: 0; /* Align left on small screens */
          margin-top: 10px;
      }
      .grid-container {
         grid-template-columns: 1fr; /* Stack cards vertically */
      }
    }
  </style>
</head>
<body>

  <script id="embeddedPsrData" type="application/json">
    /* MAKE_COM_JSON_PLACEHOLDER */
  </script>

  <div class="container">
    <header>
      <h1>Financial Health Dashboard</h1>
       <button id="saveButton">Save Full Report Data (JSON)</button>
    </header>

    <div id="loadingMessage">Loading your financial report...</div>
     <div id="errorMessage"></div>

     <div id="mainContent">
      <div class="grid-container">
        <div class="card">
          <h3>Quick Summary</h3>
          <p><strong>User:</strong> <span id="userName">N/A</span></p>
          <p><strong>Age:</strong> <span id="age">N/A</span></p>
          <p><strong>Total Monthly Income:</strong> <span id="totalIncome">N/A</span></p>
          <p><strong>Total Monthly Expenses:</strong> <span id="totalExpenses">N/A</span></p>
          <p><strong>Monthly Net Flow:</strong> <span id="netFlow">N/A</span></p>
        </div>
        <div class="card">
          <h3>Savings Overview</h3>
          <p><strong>Emergency Savings:</strong> <span id="emergencySavings">N/A</span></p>
          <p><strong>Current General Savings:</strong> <span id="currentSavings">N/A</span></p>
          <p><strong>Retirement Fund:</strong> <span id="retirementFund">N/A</span></p>
        </div>
      </div>

      <div class="grid-container">
        <div class="card">
          <h3>Income Breakdown</h3>
          <div id="incomeChart" style="width:100%;height:300px;"></div>
        </div>
        <div class="card">
          <h3>Expense Breakdown</h3>
          <div id="expenseChart" style="width:100%;height:300px;"></div>
        </div>
      </div>

       <div class="card" style="margin-bottom: 20px;">
            <h3>Financial Tools & Challenges</h3>
            <p><strong>Current Financial Tools:</strong> <span id="financialTools">N/A</span></p>
            <p><strong>Reported Challenges:</strong> <span id="challenges">N/A</span></p>
            <p><strong>Upcoming Purchase Goals:</strong> <span id="purchaseGoals">N/A</span></p>
       </div>

      <div class="card">
        <h3>AI Analysis & Recommendations</h3>
        <div id="aiAnalysis" style="white-space: pre-wrap; margin-bottom: 15px;">N/A</div>
        <button onclick="openModal('recommendationsModal')" class="text-blue-600 hover:underline">View Recommendations</button>
        <button onclick="openModal('progressModal')" class="text-blue-600 hover:underline ml-4">View Progress History</button>
      </div>
     </div> </div><div id="recommendationsModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('recommendationsModal')">&times;</span>
      <h2>Recommendations</h2>
      <div id="recommendationsContent" style="white-space: pre-wrap;"></div>
    </div>
  </div>

  <div id="progressModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('progressModal')">&times;</span>
      <h2>User Progress History</h2>
      <div id="progressContent" style="white-space: pre-wrap;"></div>
    </div>
  </div>

  <script>
    // Global variable to store fetched data for the save button
    let fetchedReportData = {};

    // Function to safely get nested properties
    function getSafe(fn, defaultVal) {
      try {
        const value = fn();
        return (value === null || value === undefined) ? defaultVal : value;
      } catch (e) {
        return defaultVal;
      }
    }

    // Function to format numbers as currency
    function formatCurrency(value) {
      const number = Number(value);
      if (isNaN(number)) return 'N/A';
      return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    // Function to update the text content of elements
    function updateElementText(id, value, formatter) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = formatter ? formatter(value) : (value || 'N/A');
      } else {
          console.warn(`Element with ID ${id} not found.`);
      }
    }

    // Function to calculate totals
    function calculateTotals(data) {
        const income = data?.userInput?.income || {};
        const expenses = data?.userInput?.expenses || {};

        const totalIncome = (Number(income.mainJobIncome || 0) + Number(income.secondJob || 0) + Number(income.otherIncome || 0));
        const totalExpenses = (
            Number(expenses.housing || 0) + Number(expenses.utilities || 0) +
            Number(expenses.transportation || 0) + Number(expenses.groceriesEssentials || 0) +
            Number(expenses.insurance || 0) + Number(expenses.medical || 0) +
            Number(expenses.care || 0) + Number(expenses.subscriptions || 0) +
            Number(expenses.taxes || 0)
        );
        const netFlow = totalIncome - totalExpenses;

        return { totalIncome, totalExpenses, netFlow };
    }


    // Function to update the main report sections
    function updateReport(data) {
        const personalInfo = data?.userInput?.personalInfo || {};
        const savings = data?.userInput?.savings || {};
        const financials = data?.userInput?.financials || {};
        const totals = calculateTotals(data);

        updateElementText('userName', personalInfo.userName);
        updateElementText('age', personalInfo.age);
        updateElementText('totalIncome', totals.totalIncome, formatCurrency);
        updateElementText('totalExpenses', totals.totalExpenses, formatCurrency);
        updateElementText('netFlow', totals.netFlow, formatCurrency);

        updateElementText('emergencySavings', savings.emergency, formatCurrency);
        updateElementText('currentSavings', savings.savings, formatCurrency);
        updateElementText('retirementFund', savings.retirement, formatCurrency);

        updateElementText('financialTools', financials.financialTools);
        updateElementText('challenges', financials.challenges);
        updateElementText('purchaseGoals', financials.upcomingPurchase);

        updateElementText('aiAnalysis', data?.aiOutput?.analysis);
    }

    // Function to render Plotly charts
    function renderCharts(data) {
      const income = data?.userInput?.income || {};
      const expenses = data?.userInput?.expenses || {};

      // Income Chart
      const incomeData = [{
        values: [
            getSafe(() => Number(income.mainJobIncome), 0),
            getSafe(() => Number(income.secondJob), 0),
            getSafe(() => Number(income.otherIncome), 0)
        ],
        labels: ['Main Job', 'Second Job', 'Other'],
        type: 'pie',
        hole: .4,
        hoverinfo: 'label+percent',
        textinfo: 'value',
        textfont_size: 14,
        marker: { colors: ['#4CAF50', '#8BC34A', '#CDDC39'] } // Shades of green/yellow
      }];
      const incomeLayout = {
        title: 'Income Sources',
        showlegend: true,
        height: 300,
        margin: { l: 20, r: 20, t: 40, b: 20 } // Adjust margins
      };
      Plotly.newPlot('incomeChart', incomeData, incomeLayout, {responsive: true});

      // Expense Chart
      const expenseValues = [
          getSafe(() => Number(expenses.housing), 0), getSafe(() => Number(expenses.utilities), 0),
          getSafe(() => Number(expenses.transportation), 0), getSafe(() => Number(expenses.groceriesEssentials), 0),
          getSafe(() => Number(expenses.insurance), 0), getSafe(() => Number(expenses.medical), 0),
          getSafe(() => Number(expenses.care), 0), getSafe(() => Number(expenses.subscriptions), 0),
          getSafe(() => Number(expenses.taxes), 0)
      ];
      const expenseLabels = [
          'Housing', 'Utilities', 'Transportation', 'Groceries/Essentials',
          'Insurance', 'Medical', 'Child/Elder Care', 'Subscriptions', 'Taxes'
      ];
      const expenseData = [{
        values: expenseValues,
        labels: expenseLabels,
        type: 'pie',
        hole: .4,
        hoverinfo: 'label+percent',
        textinfo: 'value',
        textfont_size: 14,
        marker: { colors: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688'] } // Various colors
      }];
      const expenseLayout = {
        title: 'Expense Categories',
        showlegend: true,
        height: 300,
        margin: { l: 20, r: 20, t: 40, b: 20 } // Adjust margins
      };
      Plotly.newPlot('expenseChart', expenseData, expenseLayout, {responsive: true});
    }

    // Function to update AI Analysis and potentially other text areas
    function updateAnalysis(data) {
        const aiOutput = data?.aiOutput || {};
        updateElementText('aiAnalysis', aiOutput.analysis);
        // Update modal content here too, if not done by initModals
        updateElementText('recommendationsContent', aiOutput.recommendations);
        updateElementText('progressContent', aiOutput.userProgress);
    }


    // Functions to handle modals
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "block";
    }

    function closeModal(modalId) {
       const modal = document.getElementById(modalId);
      if (modal) modal.style.display = "none";
    }

    // Function to initialize modal content (could be expanded)
    function initModals(data) {
        const aiOutput = data?.aiOutput || {};
        updateElementText('recommendationsContent', aiOutput.recommendations);
        updateElementText('progressContent', aiOutput.userProgress);

      // Close modal if clicked outside the content area
      window.onclick = function(event) {
        const modals = document.getElementsByClassName('modal');
        for (let i = 0; i < modals.length; i++) {
             if (event.target == modals[i]) {
               modals[i].style.display = "none";
             }
        }
      }
    }

    // Function to initialize the Save JSON button
    function initSaveButton() {
      const saveButton = document.getElementById('saveButton');
      if (!saveButton) {
          console.error("Save button not found.");
          return;
      }
      saveButton.addEventListener('click', () => {
        // Use the globally stored fetchedReportData
        if (!fetchedReportData || Object.keys(fetchedReportData).length === 0) {
             alert("No report data available to save.");
             return;
        }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fetchedReportData, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        // Try to get username for filename, fallback to 'user'
        const filenameUser = getSafe(() => fetchedReportData.userInput.personalInfo.userName.replace(/[^a-z0-9]/gi, '_').toLowerCase(), 'user');
        a.download = `financial_report_${filenameUser}_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    // Main initialization function: parse embedded data and update dashboard
    function init() {
      let data = null;
      const loadingMessage = document.getElementById('loadingMessage');
      const errorMessage = document.getElementById('errorMessage');
      const mainContent = document.getElementById('mainContent');

      try {
        const dataElement = document.getElementById('embeddedPsrData');
        // Check if the placeholder is still present or if the element is missing/empty
        if (dataElement && dataElement.textContent.trim() && dataElement.textContent.trim() !== '/* MAKE_COM_JSON_PLACEHOLDER */') {
           data = JSON.parse(dataElement.textContent);
           fetchedReportData = data; // Store globally for save button
        } else {
           console.error("Embedded PSR data not found or is placeholder.");
           errorMessage.textContent = 'Could not load report data embedded in the file. Placeholder content found.';
           errorMessage.style.display = 'block';
           loadingMessage.style.display = 'none';
           return; // Stop if no data
        }
      } catch (error) {
         console.error("Error parsing embedded JSON:", error);
         errorMessage.textContent = `Failed to parse embedded report data: ${error.message}`;
         errorMessage.style.display = 'block';
         loadingMessage.style.display = 'none';
         return; // Stop on error
      }

       // Hide loading, show content (if data parsed successfully)
      loadingMessage.style.display = 'none';

      // Only proceed if data was successfully parsed
      if (data) {
          mainContent.style.display = 'block'; // Show main content area
          updateReport(data);
          renderCharts(data);
          updateAnalysis(data);
          initModals(data);
          initSaveButton();
      } else {
           // Ensure error message is shown if data somehow becomes null after checks
            if (errorMessage.style.display !== 'block') {
                errorMessage.textContent = 'Report data is missing or invalid.';
                errorMessage.style.display = 'block';
            }
      }
    }

    // Run init when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
